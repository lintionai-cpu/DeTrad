<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Factor Trader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        50% {
          box-shadow: 0 0 40px rgba(59, 130, 246, 0.8);
        }
      }
      .toast {
        animation: slideIn 0.3s ease;
      }
      .pulse {
        animation: pulse 2s ease-in-out infinite;
      }
      .glow {
        animation: glow 2s ease-in-out infinite;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen"
  >
    <div
      id="toastContainer"
      class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm"
    ></div>

    <div
      id="authModal"
      class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-blue-500/30"
      >
        <h2
          class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent"
        >
          üöÄ All Factor Trader Pro
        </h2>
        <p class="text-gray-400 text-center mb-6">
          Enter passcode to access trading system
        </p>
        <input
          type="password"
          id="authPass"
          placeholder="Enter Passcode"
          class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center text-2xl tracking-widest focus:border-blue-500 focus:outline-none"
        />
        <button
          onclick="authenticate()"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-3 rounded-lg font-bold hover:opacity-90 transition"
        >
          UNLOCK
        </button>
        <p class="text-xs text-gray-500 text-center mt-4">Default: 1234</p>
      </div>
    </div>

    <div id="mainApp" class="hidden p-2 sm:p-4">
      <div class="max-w-7xl mx-auto space-y-3 sm:space-y-4">
        <div
          class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-2xl"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
          >
            <div>
              <h1 class="text-2xl sm:text-4xl font-bold">
                üöÄ ALL FACTOR TRADER PRO
              </h1>
              <p class="text-blue-100 text-xs sm:text-base mt-1">
                Advanced Multi-Strategy Deriv Trading
              </p>
            </div>
            <div
              class="flex items-center gap-2 sm:gap-3 bg-black/30 px-3 sm:px-4 py-2 rounded-lg"
            >
              <span
                id="connDot"
                class="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-red-500"
              ></span>
              <span id="connStatus" class="font-semibold text-sm sm:text-base"
                >Disconnected</span
              >
            </div>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4"
            >
              <p class="text-xs text-blue-200">Balance</p>
              <p id="balance" class="text-lg sm:text-2xl font-bold">$0.00</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4"
            >
              <p class="text-xs text-purple-200">PnL</p>
              <p id="totalPnL" class="text-lg sm:text-2xl font-bold">$0.00</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4"
            >
              <p class="text-xs text-green-200">Win Rate</p>
              <p id="winRate" class="text-lg sm:text-2xl font-bold">0%</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4"
            >
              <p class="text-xs text-orange-200">Trades</p>
              <p id="totalTrades" class="text-lg sm:text-2xl font-bold">0</p>
            </div>
          </div>

          <div
            class="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-3 mt-3 sm:mt-4"
          >
            <div class="bg-black/20 p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Price</p>
              <p
                id="currentPrice"
                class="text-sm sm:text-lg font-bold text-blue-400"
              >
                -
              </p>
            </div>
            <div class="bg-black/20 p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Signal</p>
              <p
                id="currentSignal"
                class="text-sm sm:text-lg font-bold text-yellow-400"
              >
                WAIT
              </p>
            </div>
            <div class="bg-black/20 p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Confidence</p>
              <p
                id="confidence"
                class="text-sm sm:text-lg font-bold text-green-400"
              >
                0%
              </p>
            </div>
            <div class="bg-black/20 p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Stake</p>
              <p
                id="currentStake"
                class="text-sm sm:text-lg font-bold text-purple-400"
              >
                $0
              </p>
            </div>
            <div
              class="bg-black/20 p-2 sm:p-3 rounded-lg col-span-2 sm:col-span-1"
            >
              <p class="text-xs">Status</p>
              <p
                id="tradeStatus"
                class="text-sm sm:text-lg font-bold text-orange-400"
              >
                IDLE
              </p>
            </div>
          </div>
        </div>

        <div class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl">
          <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">
            üîå API Connection
          </h2>
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <input
              type="password"
              id="apiToken"
              placeholder="Deriv API Token"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base focus:border-blue-500 focus:outline-none"
            />
            <button
              onclick="connect()"
              class="bg-blue-600 px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold hover:bg-blue-700 transition text-sm sm:text-base"
            >
              Connect
            </button>
            <button
              onclick="disconnect()"
              class="bg-red-600 px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold hover:bg-red-700 transition text-sm sm:text-base"
            >
              Disconnect
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
          <div
            class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl"
          >
            <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">
              üìä Market & Strategy
            </h2>
            <select
              id="market"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 mb-3 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
            >
              <option value="R_10">Volatility 10</option>
              <option value="R_25">Volatility 25</option>
              <option value="R_50">Volatility 50</option>
              <option value="R_75">Volatility 75</option>
              <option value="R_100">Volatility 100</option>
              <option value="1HZ10V">Vol 10 (1s)</option>
              <option value="1HZ25V">Vol 25 (1s)</option>
              <option value="1HZ50V">Vol 50 (1s)</option>
              <option value="1HZ75V">Vol 75 (1s)</option>
              <option value="1HZ100V">Vol 100 (1s)</option>
              <option value="BOOM500">Boom 500</option>
              <option value="BOOM1000">Boom 1000</option>
              <option value="CRASH500">Crash 500</option>
              <option value="CRASH1000">Crash 1000</option>
            </select>
            <select
              id="contractType"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 mb-3 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
            >
              <option value="CALL">Rise/Fall</option>
              <option value="CALLE">Higher</option>
              <option value="PUTE">Lower</option>
            </select>
            <select
              id="strategy"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
            >
              <option value="SNIPER-1">üìà Sniper EMA+MACD</option>
              <option value="MACD-BB-LONG">üìä MACD+BB Long</option>
              <option value="MACD-BB-SHORT">üìä MACD+BB Short</option>
              <option value="EMA-CROSS-LONG">‚ö° EMA Break Long</option>
              <option value="EMA-CROSS-SHORT">‚ö° EMA Break Short</option>
            </select>
          </div>

          <div
            class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl"
          >
            <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">
              ‚öôÔ∏è Risk Management
            </h2>
            <div class="grid grid-cols-2 gap-2 sm:gap-3">
              <div>
                <label class="text-xs sm:text-sm">Stake ($)</label>
                <input
                  type="number"
                  id="stake"
                  value="1"
                  min="0.35"
                  step="0.1"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm">Duration</label>
                <input
                  type="number"
                  id="duration"
                  value="5"
                  min="1"
                  max="10"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm">Max Loss</label>
                <input
                  type="number"
                  id="maxLoss"
                  value="50"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm">Max Profit</label>
                <input
                  type="number"
                  id="maxProfit"
                  value="100"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm">Min Conf %</label>
                <input
                  type="number"
                  id="minConfidence"
                  value="70"
                  min="50"
                  max="100"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm">Delay (s)</label>
                <input
                  type="number"
                  id="tradeDelay"
                  value="3"
                  min="1"
                  max="30"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base border border-gray-600 focus:border-blue-500 focus:outline-none"
                />
              </div>
            </div>
            <label
              class="flex items-center gap-2 mt-3 text-sm sm:text-base cursor-pointer"
            >
              <input
                type="checkbox"
                id="martingale"
                class="w-4 h-4 sm:w-5 sm:h-5"
              />
              <span>Martingale (3 max)</span>
            </label>
          </div>
        </div>

        <div class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
            <button
              onclick="startTrading()"
              id="startBtn"
              class="bg-green-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-green-700 transition glow"
            >
              üöÄ START
            </button>
            <button
              onclick="stopTrading()"
              id="stopBtn"
              disabled
              class="bg-red-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg opacity-50 transition"
            >
              ‚õî STOP
            </button>
            <button
              onclick="singleTrade()"
              class="bg-blue-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-blue-700 transition"
            >
              ‚ö° SINGLE
            </button>
            <button
              onclick="reset()"
              class="bg-yellow-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-yellow-700 transition"
            >
              üîÑ RESET
            </button>
          </div>
        </div>

        <div class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl">
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
          >
            <h2 class="text-lg sm:text-xl font-bold">üìú History</h2>
            <button
              onclick="exportCSV()"
              class="bg-purple-600 px-3 sm:px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm sm:text-base"
            >
              üì• Export
            </button>
          </div>
          <div class="overflow-x-auto -mx-4 sm:mx-0">
            <table class="w-full text-xs sm:text-sm min-w-[600px]">
              <thead class="bg-gray-700">
                <tr>
                  <th class="p-2 sm:p-3 text-left">Time</th>
                  <th class="p-2 sm:p-3 text-left">Strategy</th>
                  <th class="p-2 sm:p-3 text-left">Type</th>
                  <th class="p-2 sm:p-3 text-left">Stake</th>
                  <th class="p-2 sm:p-3 text-left">Result</th>
                  <th class="p-2 sm:p-3 text-left">PnL</th>
                </tr>
              </thead>
              <tbody id="history">
                <tr>
                  <td colspan="6" class="p-6 sm:p-8 text-center text-gray-500">
                    No trades yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws,
        isConnected = false,
        isTrading = false,
        isProcessing = false,
        balance = 0,
        totalPnL = 0,
        totalTrades = 0,
        totalWins = 0,
        currentStake = 1,
        martingaleStep = 0,
        priceHistory = [],
        tradeHistory = [],
        lastTradeTime = 0,
        activeContractId = null;

      function authenticate() {
        const p = document.getElementById("authPass").value;
        if (p === "1234" || p === "admin") {
          document.getElementById("authModal").classList.add("hidden");
          document.getElementById("mainApp").classList.remove("hidden");
          showToast("‚úÖ Welcome to All Factor Trader Pro!", "success");
        } else {
          showToast("‚ùå Invalid passcode", "error");
        }
      }

      document.getElementById("authPass").addEventListener("keypress", (e) => {
        if (e.key === "Enter") authenticate();
      });

      function showToast(m, t = "info") {
        const d = document.createElement("div");
        d.className = `toast px-4 py-3 rounded-lg shadow-2xl text-sm sm:text-base ${
          t === "success"
            ? "bg-green-600"
            : t === "error"
            ? "bg-red-600"
            : t === "warning"
            ? "bg-yellow-600"
            : "bg-blue-600"
        }`;
        d.textContent = m;
        document.getElementById("toastContainer").appendChild(d);
        setTimeout(() => d.remove(), 5000);
      }

      function updateUI() {
        document.getElementById("balance").textContent = `$${balance.toFixed(
          2
        )}`;
        document.getElementById("totalPnL").textContent = `$${totalPnL.toFixed(
          2
        )}`;
        document.getElementById(
          "totalPnL"
        ).className = `text-lg sm:text-2xl font-bold ${
          totalPnL >= 0 ? "text-green-400" : "text-red-400"
        }`;
        document.getElementById("winRate").textContent =
          totalTrades > 0
            ? `${((totalWins / totalTrades) * 100).toFixed(1)}%`
            : "0%";
        document.getElementById("totalTrades").textContent = totalTrades;
        document.getElementById(
          "currentStake"
        ).textContent = `$${currentStake.toFixed(2)}`;
      }

      function updateConnectionStatus(c) {
        isConnected = c;
        document.getElementById("connStatus").textContent = c
          ? "Connected"
          : "Disconnected";
        document.getElementById(
          "connDot"
        ).className = `w-2 h-2 sm:w-3 sm:h-3 rounded-full ${
          c ? "bg-green-500 pulse" : "bg-red-500"
        }`;
      }

      function updateTradeStatus(s) {
        document.getElementById("tradeStatus").textContent = s;
        const col = {
          IDLE: "text-gray-400",
          ANALYZING: "text-yellow-400 pulse",
          SIGNAL: "text-green-400",
          TRADING: "text-blue-400 pulse",
          WAITING: "text-orange-400",
        };
        document.getElementById(
          "tradeStatus"
        ).className = `text-sm sm:text-lg font-bold ${
          col[s] || "text-gray-400"
        }`;
      }

      function calculateEMA(d, p) {
        if (d.length < p) return null;
        const k = 2 / (p + 1);
        let e = d.slice(0, p).reduce((a, b) => a + b, 0) / p;
        for (let i = p; i < d.length; i++) e = d[i] * k + e * (1 - k);
        return e;
      }

      function calculateEMAArray(d, p) {
        if (d.length < p) return [];
        const k = 2 / (p + 1),
          a = [];
        let e = d.slice(0, p).reduce((x, y) => x + y, 0) / p;
        a.push(e);
        for (let i = p; i < d.length; i++) {
          e = d[i] * k + e * (1 - k);
          a.push(e);
        }
        return a;
      }

      function calculateSMA(d, p) {
        if (d.length < p) return null;
        return d.slice(-p).reduce((a, b) => a + b, 0) / p;
      }

      function calculateMACD(d, f = 12, s = 26, sig = 9) {
        if (d.length < s) return null;
        const fa = calculateEMAArray(d, f),
          sa = calculateEMAArray(d, s);
        if (!fa.length || !sa.length) return null;
        const l = fa.map((v, i) => v - sa[i]),
          si = calculateEMAArray(l, sig);
        if (!si.length) return null;
        const h = l.slice(-si.length).map((v, i) => v - si[i]);
        return {
          macd: l[l.length - 1],
          signal: si[si.length - 1],
          histogram: h[h.length - 1],
          macdArray: l,
          signalArray: si,
        };
      }

      function calculateBB(d, p = 20, dev = 2) {
        if (d.length < p) return null;
        const sm = calculateSMA(d, p),
          sl = d.slice(-p),
          v = sl.reduce((sum, val) => sum + Math.pow(val - sm, 2), 0) / p,
          std = Math.sqrt(v);
        return { upper: sm + std * dev, middle: sm, lower: sm - std * dev };
      }

      function strategySniperEMAMACD() {
        if (priceHistory.length < 50) return null;
        const f = calculateEMA(priceHistory, 9),
          s = calculateEMA(priceHistory, 21),
          pf = calculateEMA(priceHistory.slice(0, -1), 9),
          ps = calculateEMA(priceHistory.slice(0, -1), 21),
          m = calculateMACD(priceHistory, 12, 26, 9);
        if (!f || !s || !pf || !ps || !m) return null;
        const bull = m.macd > m.signal && m.histogram > 0,
          bear = m.macd < m.signal && m.histogram < 0;
        if (pf <= ps && f > s && bull)
          return {
            signal: "CALL",
            confidence: 0.85,
            expiry: 7,
            reason: "Sniper Bull",
          };
        if (pf >= ps && f < s && bear)
          return {
            signal: "PUT",
            confidence: 0.85,
            expiry: 7,
            reason: "Sniper Bear",
          };
        return null;
      }

      function strategyMACDBBLong() {
        if (priceHistory.length < 200) return null;
        const m = calculateMACD(priceHistory);
        if (!m) return null;
        const mv = priceHistory.slice(-200).map((_, i) => {
            const sl = priceHistory.slice(0, priceHistory.length - 200 + i + 1),
              mc = calculateMACD(sl);
            return mc ? mc.macd : 0;
          }),
          bb = calculateBB(mv, 200, 1.5);
        if (!bb) return null;
        const ma =
            mv.length >= 2
              ? (mv[mv.length - 1] * 2 + mv[mv.length - 2]) / 3
              : m.macd,
          pm = mv[mv.length - 2] || 0,
          pma =
            mv.length >= 3
              ? (mv[mv.length - 2] * 2 + mv[mv.length - 3]) / 3
              : pm,
          cp = priceHistory[priceHistory.length - 1],
          pp = priceHistory[priceHistory.length - 2];
        if (
          m.macd < bb.upper &&
          ma < bb.upper &&
          pma <= pm &&
          ma > pm &&
          cp > pp
        )
          return {
            signal: "CALL",
            confidence: 0.8,
            expiry: 6,
            reason: "MACD+BB Long",
          };
        return null;
      }

      function strategyMACDBBShort() {
        if (priceHistory.length < 200) return null;
        const m = calculateMACD(priceHistory);
        if (!m) return null;
        const mv = priceHistory.slice(-200).map((_, i) => {
            const sl = priceHistory.slice(0, priceHistory.length - 200 + i + 1),
              mc = calculateMACD(sl);
            return mc ? mc.macd : 0;
          }),
          bb = calculateBB(mv, 200, 1.5);
        if (!bb) return null;
        const ma =
            mv.length >= 2
              ? (mv[mv.length - 1] * 2 + mv[mv.length - 2]) / 3
              : m.macd,
          pm = mv[mv.length - 2] || 0,
          pma =
            mv.length >= 3
              ? (mv[mv.length - 2] * 2 + mv[mv.length - 3]) / 3
              : pm,
          cp = priceHistory[priceHistory.length - 1],
          pp = priceHistory[priceHistory.length - 2];
        if (
          m.macd > bb.upper &&
          ma > bb.upper &&
          pma >= pm &&
          ma < pm &&
          cp < pp
        )
          return {
            signal: "PUT",
            confidence: 0.8,
            expiry: 6,
            reason: "MACD+BB Short",
          };
        return null;
      }

      function strategyEMACrossLong() {
        if (priceHistory.length < 25) return null;
        const f = calculateEMA(priceHistory, 9),
          s = calculateEMA(priceHistory, 21),
          pf = calculateEMA(priceHistory.slice(0, -1), 9),
          ps = calculateEMA(priceHistory.slice(0, -1), 21),
          cp = priceHistory[priceHistory.length - 1],
          pp = priceHistory[priceHistory.length - 2];
        if (!f || !s || !pf || !ps) return null;
        if (pf <= ps && f > s && cp > f && cp > s && cp > pp)
          return {
            signal: "CALL",
            confidence: 0.78,
            expiry: 5,
            reason: "EMA Long",
          };
        return null;
      }

      function strategyEMACrossShort() {
        if (priceHistory.length < 25) return null;
        const f = calculateEMA(priceHistory, 9),
          s = calculateEMA(priceHistory, 21),
          pf = calculateEMA(priceHistory.slice(0, -1), 9),
          ps = calculateEMA(priceHistory.slice(0, -1), 21),
          cp = priceHistory[priceHistory.length - 1],
          pp = priceHistory[priceHistory.length - 2];
        if (!f || !s || !pf || !ps) return null;
        if (pf >= ps && f < s && cp < f && cp < s && cp < pp)
          return {
            signal: "PUT",
            confidence: 0.78,
            expiry: 5,
            reason: "EMA Short",
          };
        return null;
      }

      function analyzeMarket() {
        if (priceHistory.length < 10) return null;
        const st = document.getElementById("strategy").value;
        let r = null;
        if (st === "SNIPER-1") r = strategySniperEMAMACD();
        else if (st === "MACD-BB-LONG") r = strategyMACDBBLong();
        else if (st === "MACD-BB-SHORT") r = strategyMACDBBShort();
        else if (st === "EMA-CROSS-LONG") r = strategyEMACrossLong();
        else if (st === "EMA-CROSS-SHORT") r = strategyEMACrossShort();
        else r = strategySniperEMAMACD();
        if (r) {
          document.getElementById("currentSignal").textContent = r.signal;
          document.getElementById("confidence").textContent = `${(
            r.confidence * 100
          ).toFixed(0)}%`;
          updateTradeStatus("SIGNAL");
          const mc =
            parseFloat(document.getElementById("minConfidence").value) / 100;
          if (isTrading && !isProcessing && r.confidence >= mc) {
            const now = Date.now(),
              delay =
                parseFloat(document.getElementById("tradeDelay").value) * 1000;
            if (now - lastTradeTime >= delay) executeTrade(r);
          }
        } else {
          document.getElementById("currentSignal").textContent = "WAIT";
          document.getElementById("confidence").textContent = "0%";
          if (isTrading && !isProcessing) updateTradeStatus("ANALYZING");
        }
        return r;
      }

      function executeTrade(sig) {
        if (isProcessing || !isConnected) return;
        isProcessing = true;
        updateTradeStatus("TRADING");
        const mart = document.getElementById("martingale").checked,
          base = parseFloat(document.getElementById("stake").value);
        currentStake = mart && martingaleStep > 0 ? currentStake : base;
        const ct = document.getElementById("contractType").value;
        let tt = sig.signal;
        if (ct === "CALLE" || ct === "PUTE")
          tt = sig.signal === "CALL" ? "CALLE" : "PUTE";
        const prop = {
          proposal: 1,
          amount: currentStake,
          basis: "stake",
          contract_type: tt,
          currency: "USD",
          duration:
            sig.expiry || parseInt(document.getElementById("duration").value),
          duration_unit: "t",
          symbol: document.getElementById("market").value,
        };
        showToast(`üì§ ${tt} - $${currentStake.toFixed(2)}`, "info");
        ws.send(JSON.stringify(prop));
      }

      function connect() {
        const t = document.getElementById("apiToken").value.trim();
        if (!t) {
          showToast("‚ùå Enter API token", "error");
          return;
        }
        ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=1089");
        ws.onopen = () => {
          ws.send(JSON.stringify({ authorize: t }));
          showToast("üîÑ Connecting...", "info");
        };
        ws.onmessage = (e) => {
          const d = JSON.parse(e.data);
          if (d.error) {
            showToast(d.error.message, "error");
            updateConnectionStatus(false);
            return;
          }
          handleMessage(d);
        };
        ws.onerror = () => {
          showToast("‚ùå Connection error", "error");
          updateConnectionStatus(false);
        };
        ws.onclose = () => {
          updateConnectionStatus(false);
          isTrading = false;
          showToast("‚ö†Ô∏è Disconnected", "warning");
        };
      }

      function handleMessage(d) {
        if (d.msg_type === "authorize" && d.authorize) {
          balance = parseFloat(d.authorize.balance);
          updateConnectionStatus(true);
          updateUI();
          showToast("‚úÖ Connected successfully!", "success");
          const m = document.getElementById("market").value;
          ws.send(JSON.stringify({ ticks: m, subscribe: 1 }));
          ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        } else if (d.msg_type === "tick") {
          const p = parseFloat(d.tick.quote);
          priceHistory.push(p);
          if (priceHistory.length > 200) priceHistory.shift();
          document.getElementById("currentPrice").textContent = p.toFixed(5);
          if (priceHistory.length >= 10 && !isProcessing) analyzeMarket();
        } else if (d.msg_type === "proposal" && d.proposal) {
          ws.send(
            JSON.stringify({ buy: d.proposal.id, price: d.proposal.ask_price })
          );
        } else if (d.msg_type === "buy" && d.buy) {
          activeContractId = d.buy.contract_id;
          ws.send(
            JSON.stringify({
              proposal_open_contract: 1,
              contract_id: d.buy.contract_id,
              subscribe: 1,
            })
          );
          lastTradeTime = Date.now();
          showToast("‚úÖ Trade placed!", "success");
        } else if (d.msg_type === "proposal_open_contract") {
          const c = d.proposal_open_contract;
          if (c.status === "sold" || c.is_sold) handleContractResult(c);
        } else if (d.msg_type === "balance") {
          balance = parseFloat(d.balance.balance);
          updateUI();
        }
      }

      function handleContractResult(c) {
        const profit = parseFloat(c.profit),
          isWin = profit > 0;
        totalPnL += profit;
        totalTrades++;
        if (isWin) totalWins++;
        tradeHistory.unshift({
          time: new Date().toLocaleTimeString(),
          strategy: document.getElementById("strategy").value,
          type: c.contract_type,
          stake: parseFloat(c.buy_price),
          result: isWin ? "Win" : "Loss",
          pnl: profit,
        });
        const mart = document.getElementById("martingale").checked;
        if (isWin) {
          showToast(`‚úÖ WIN! +$${profit.toFixed(2)}`, "success");
          martingaleStep = 0;
          currentStake = parseFloat(document.getElementById("stake").value);
        } else {
          showToast(`‚ùå LOSS: $${profit.toFixed(2)}`, "error");
          if (mart && martingaleStep < 3) {
            martingaleStep++;
            currentStake *= 2;
            showToast(
              `‚ö†Ô∏è Martingale ${martingaleStep}: $${currentStake.toFixed(2)}`,
              "warning"
            );
          } else {
            martingaleStep = 0;
            currentStake = parseFloat(document.getElementById("stake").value);
          }
        }
        updateHistory();
        updateUI();
        isProcessing = false;
        activeContractId = null;
        if (isTrading) updateTradeStatus("ANALYZING");
        else updateTradeStatus("IDLE");
        const maxLoss = parseFloat(document.getElementById("maxLoss").value),
          maxProfit = parseFloat(document.getElementById("maxProfit").value);
        if (Math.abs(totalPnL) >= maxLoss && totalPnL < 0) {
          stopTrading();
          showToast("‚õî Max loss reached!", "error");
        }
        if (totalPnL >= maxProfit) {
          stopTrading();
          showToast("üéâ Profit target reached!", "success");
        }
      }

      function disconnect() {
        if (ws) {
          ws.close();
          isTrading = false;
          isProcessing = false;
          updateConnectionStatus(false);
          updateTradeStatus("IDLE");
        }
      }

      function startTrading() {
        if (!isConnected) {
          showToast("‚ùå Please connect first", "error");
          return;
        }
        if (priceHistory.length < 10) {
          showToast("‚ö†Ô∏è Waiting for data...", "warning");
          return;
        }
        isTrading = true;
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        updateTradeStatus("ANALYZING");
        showToast("üöÄ Auto-trading started!", "success");
      }

      function stopTrading() {
        isTrading = false;
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        updateTradeStatus("IDLE");
        showToast("‚õî Auto-trading stopped", "info");
      }

      function singleTrade() {
        if (!isConnected) {
          showToast("‚ùå Please connect first", "error");
          return;
        }
        if (isProcessing) {
          showToast("‚ö†Ô∏è Trade in progress...", "warning");
          return;
        }
        const sig = analyzeMarket();
        if (sig && sig.confidence >= 0.5) {
          executeTrade(sig);
        } else {
          showToast("‚ö†Ô∏è No valid signal", "warning");
        }
      }

      function reset() {
        if (!confirm("Reset all session data?")) return;
        totalPnL = 0;
        totalTrades = 0;
        totalWins = 0;
        martingaleStep = 0;
        currentStake = parseFloat(document.getElementById("stake").value);
        priceHistory = [];
        tradeHistory = [];
        document.getElementById("history").innerHTML =
          '<tr><td colspan="6" class="p-6 sm:p-8 text-center text-gray-500">No trades yet</td></tr>';
        document.getElementById("currentSignal").textContent = "WAIT";
        document.getElementById("confidence").textContent = "0%";
        updateUI();
        showToast("üîÑ Session reset!", "success");
      }

      function updateHistory() {
        const tbody = document.getElementById("history");
        if (tradeHistory.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="p-6 sm:p-8 text-center text-gray-500">No trades yet</td></tr>';
          return;
        }
        tbody.innerHTML = tradeHistory
          .slice(0, 50)
          .map(
            (t) =>
              `<tr class="hover:bg-gray-700 border-b border-gray-700"><td class="p-2 sm:p-3">${
                t.time
              }</td><td class="p-2 sm:p-3"><span class="text-xs bg-gray-700 px-2 py-1 rounded">${
                t.strategy
              }</span></td><td class="p-2 sm:p-3">${
                t.type
              }</td><td class="p-2 sm:p-3">$${t.stake.toFixed(
                2
              )}</td><td class="p-2 sm:p-3"><span class="px-2 sm:px-3 py-1 rounded-full text-xs ${
                t.result === "Win" ? "bg-green-600" : "bg-red-600"
              }">${t.result}</span></td><td class="p-2 sm:p-3 font-bold ${
                t.pnl >= 0 ? "text-green-400" : "text-red-400"
              }">${t.pnl >= 0 ? "+" : ""}$${t.pnl.toFixed(2)}</td></tr>`
          )
          .join("");
      }

      function exportCSV() {
        if (tradeHistory.length === 0) {
          showToast("‚ö†Ô∏è No trades to export", "warning");
          return;
        }
        const headers = ["Time", "Strategy", "Type", "Stake", "Result", "PnL"],
          rows = tradeHistory.map((t) => [
            t.time,
            t.strategy,
            t.type,
            t.stake.toFixed(2),
            t.result,
            t.pnl.toFixed(2),
          ]),
          csv = [headers, ...rows].map((row) => row.join(",")).join("\n"),
          blob = new Blob([csv], { type: "text/csv" }),
          url = URL.createObjectURL(blob),
          a = document.createElement("a");
        a.href = url;
        a.download = `trades_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("üì• History exported!", "success");
      }

      document.getElementById("market").addEventListener("change", () => {
        if (isConnected && ws) {
          const m = document.getElementById("market").value;
          ws.send(JSON.stringify({ forget_all: "ticks" }));
          ws.send(JSON.stringify({ ticks: m, subscribe: 1 }));
          priceHistory = [];
          showToast(`üîÑ Switched to ${m}`, "info");
        }
      });

      updateUI();
      updateTradeStatus("IDLE");
    </script>
  </body>
</html>
