<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumFX Pro - Advanced Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-dark: #0f172a;
            --secondary-dark: #1e293b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
        }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }
        .card-glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .strategy-active {
            box-shadow: 0 0 0 2px var(--accent-green);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 2px var(--accent-green); }
            50% { box-shadow: 0 0 0 4px var(--accent-green); }
        }
        .trade-buy { border-left: 4px solid var(--accent-green); }
        .trade-sell { border-left: 4px solid var(--accent-red); }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent-blue);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-connect { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .price-flash { animation: flash 0.3s; }
        @keyframes flash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(59, 130, 246, 0.3); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: var(--accent-blue); border-radius: 4px; }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-disconnected { background: #ef4444; }
        .modal-overlay {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-70 modal-overlay flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 card-glass">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold mb-2">Connect to Deriv</h3>
                <p class="text-gray-400">Enter your API token to start trading</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">API Token</label>
                    <input type="password" id="apiTokenInput" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your Deriv API token">
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-400">
                    <i class="fas fa-info-circle"></i>
                    <span>Get token from <a href="https://app.deriv.com/account/api-token" target="_blank" class="text-blue-400">Deriv.com</a></span>
                </div>
                <button onclick="connectToAPI()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition">
                    <i class="fas fa-plug mr-2"></i>Connect
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl p-6 max-w-4xl w-full mx-4 card-glass max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold"><i class="fas fa-cog mr-2"></i>Strategy Settings</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="strategySettings"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-40 card-glass shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 p-2 rounded-lg">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Quantum<span class="text-blue-400">FX</span> <span class="text-xs bg-gradient-to-r from-blue-500 to-purple-500 px-2 py-1 rounded">PRO</span></h1>
                        <div class="text-xs" id="connectionStatus">
                            <span class="status-dot status-disconnected"></span><span>Disconnected</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right hidden md:block">
                        <div class="text-sm text-gray-400">Balance</div>
                        <div class="font-bold" id="headerBalance">$0.00</div>
                    </div>
                    <button id="connectBtn" onclick="showAuthModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium pulse-connect">
                        <i class="fas fa-plug mr-2"></i>Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Account Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card-glass rounded-lg p-4">
                <div class="text-sm text-gray-400">Balance</div>
                <div class="text-2xl font-bold" id="balance">$0.00</div>
            </div>
            <div class="card-glass rounded-lg p-4">
                <div class="text-sm text-gray-400">Today's P&L</div>
                <div class="text-2xl font-bold" id="dailyPL">$0.00</div>
            </div>
            <div class="card-glass rounded-lg p-4">
                <div class="text-sm text-gray-400">Total Trades</div>
                <div class="text-2xl font-bold" id="totalTrades">0</div>
            </div>
            <div class="card-glass rounded-lg p-4">
                <div class="text-sm text-gray-400">Win Rate</div>
                <div class="text-2xl font-bold" id="winRate">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Panel -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Trading Controls -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-blue-400"></i> Trading Controls
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Market Symbol</label>
                            <select id="symbolSelect" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Timeframe</label>
                            <select id="timeframeSelect" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                                <option value="60">1 Minute</option>
                                <option value="180">3 Minutes</option>
                                <option value="300">5 Minutes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Initial Stake ($)</label>
                            <input type="number" id="initialStake" value="1" min="0.35" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Target Profit ($)</label>
                            <input type="number" id="targetProfit" value="10" min="1" step="1" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Max Trade Runs</label>
                            <input type="number" id="maxRuns" value="5" min="1" max="20" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Trade Duration</label>
                            <input type="number" id="tradeDuration" value="1" min="1" max="10" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Duration Unit</label>
                            <select id="durationUnit" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                                <option value="t">Ticks</option>
                                <option value="m">Minutes</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Risk Management -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-yellow-400"></i> Risk Management
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded">
                            <span>Martingale System</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="martingaleToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Martingale Multiplier</label>
                            <input type="number" id="martingaleMultiplier" value="2.0" min="1.5" max="3" step="0.1" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Max Loss Stop ($)</label>
                            <input type="number" id="maxLoss" value="50" min="10" step="5" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Daily Profit Limit ($)</label>
                            <input type="number" id="dailyProfitLimit" value="100" min="10" step="10" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                    </div>
                </section>

                <!-- Trading Strategies -->
                <section class="card-glass rounded-xl p-5">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center">
                            <i class="fas fa-robot mr-2 text-purple-400"></i> Trading Strategies
                        </h3>
                        <button id="startTradingBtn" onclick="toggleTrading()" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition">
                            <i class="fas fa-play mr-2"></i>Start Trading
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategyContainer"></div>
                </section>

                <!-- Real-Time Trading Chart -->
                <section class="card-glass rounded-xl p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-400"></i> Live Trading Chart
                        </h3>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-400">Signals:</span>
                                <span class="flex items-center text-xs"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Buy</span>
                                <span class="flex items-center text-xs"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Sell</span>
                            </div>
                            <button onclick="resetChartZoom()" class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                                <i class="fas fa-compress-arrows-alt mr-1"></i> Reset Zoom
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-900/50 rounded-lg p-3" style="height: 450px;">
                        <canvas id="tradingChart"></canvas>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-3 text-xs">
                        <div class="bg-gray-800/50 rounded p-2">
                            <span class="text-gray-400">EMA 12:</span>
                            <span class="font-bold text-blue-400" id="ema12Value">--</span>
                        </div>
                        <div class="bg-gray-800/50 rounded p-2">
                            <span class="text-gray-400">EMA 50:</span>
                            <span class="font-bold text-purple-400" id="ema50Value">--</span>
                        </div>
                        <div class="bg-gray-800/50 rounded p-2">
                            <span class="text-gray-400">Signal Strength:</span>
                            <span class="font-bold text-yellow-400" id="signalStrength">--</span>
                        </div>
                    </div>
                </section>

                <!-- Market Data -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-area mr-2 text-green-400"></i> Market Analysis
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-800/50 rounded p-3">
                            <div class="text-sm text-gray-400">Current Price</div>
                            <div class="text-xl font-bold" id="currentPrice">--</div>
                        </div>
                        <div class="bg-gray-800/50 rounded p-3">
                            <div class="text-sm text-gray-400">EMA Status</div>
                            <div class="text-lg font-bold" id="emaStatus">--</div>
                        </div>
                        <div class="bg-gray-800/50 rounded p-3">
                            <div class="text-sm text-gray-400">MACD Signal</div>
                            <div class="text-lg font-bold" id="macdSignal">--</div>
                        </div>
                        <div class="bg-gray-800/50 rounded p-3">
                            <div class="text-sm text-gray-400">Trend</div>
                            <div class="text-lg font-bold" id="trendIndicator">--</div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Panel -->
            <div class="space-y-6">
                <!-- Active Trades -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-400"></i> Active Trades
                    </h3>
                    <div id="activeTradesContainer" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-center text-gray-500 py-4">No active trades</div>
                    </div>
                </section>

                <!-- Trade History -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-400"></i> Trade History
                    </h3>
                    <div id="tradeHistoryContainer" class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">No trades yet</div>
                    </div>
                </section>

                <!-- Performance Analytics -->
                <section class="card-glass rounded-xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-2 text-purple-400"></i> Performance
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Wins</span>
                            <span class="font-bold text-green-400" id="totalWins">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Losses</span>
                            <span class="font-bold text-red-400" id="totalLosses">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Profit Factor</span>
                            <span class="font-bold" id="profitFactor">0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Average Win</span>
                            <span class="font-bold" id="avgWin">$0.00</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // Global Variables
        let ws = null;
        let isConnected = false;
        let isTrading = false;
        let currentSymbol = null;
        let currentTimeframe = 60;
        let candles = [];
        let activeContracts = new Map();
        let tradeHistory = [];
        let accountBalance = 0;
        let dailyProfit = 0;
        let totalWins = 0;
        let totalLosses = 0;
        let currentRun = 0;
        let martingaleEnabled = false;
        let currentStake = 1;
        let tradingChart = null;
        let chartData = {
            labels: [],
            prices: [],
            ema12: [],
            ema50: [],
            sma12: [],
            sma50: [],
            buySignals: [],
            sellSignals: []
        };

        // Strategy Configurations
        const strategies = {
            ema_cross: {
                name: 'EMA Cross + Candle Confirmation',
                active: false,
                params: {
                    fastPeriod: 12,
                    slowPeriod: 50,
                    confirmCandle: true
                }
            },
            sma_cross: {
                name: 'SMA Cross + Candle Confirmation',
                active: false,
                params: {
                    fastPeriod: 12,
                    slowPeriod: 50,
                    confirmCandle: true
                }
            },
            macd_ma: {
                name: 'MACD + MA Cross',
                active: false,
                params: {
                    macdFast: 12,
                    macdSlow: 26,
                    macdSignal: 9,
                    maPeriod: 2,
                    confirmCandle: true
                }
            }
        };

        // WebSocket Connection
        function connectToAPI() {
            const token = document.getElementById('apiTokenInput').value.trim();
            if (!token) {
                showNotification('Please enter API token', 'error');
                return;
            }

            ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
            
            ws.onopen = () => {
                authorize(token);
            };

            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                handleWebSocketMessage(data);
            };

            ws.onerror = () => {
                showNotification('Connection error', 'error');
                updateConnectionStatus(false);
            };

            ws.onclose = () => {
                isConnected = false;
                updateConnectionStatus(false);
                // Auto-reconnect
                if (isTrading) {
                    setTimeout(() => connectToAPI(), 5000);
                }
            };
        }

        function authorize(token) {
            sendWSMessage({ authorize: token });
        }

        function sendWSMessage(msg) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(msg));
            }
        }

        function handleWebSocketMessage(data) {
            if (data.error) {
                showNotification(data.error.message, 'error');
                return;
            }

            if (data.authorize) {
                isConnected = true;
                accountBalance = parseFloat(data.authorize.balance);
                updateConnectionStatus(true);
                updateAccountInfo();
                loadMarkets();
                document.getElementById('authModal').classList.add('hidden');
                showNotification('Connected successfully', 'success');
                
                // Subscribe to balance updates
                sendWSMessage({ balance: 1, subscribe: 1 });
            }

            if (data.active_symbols) {
                populateMarkets(data.active_symbols);
            }

            if (data.candles) {
                processCandles(data.candles);
            }

            if (data.ohlc) {
                updateCandle(data.ohlc);
            }

            if (data.balance) {
                accountBalance = parseFloat(data.balance.balance);
                updateAccountInfo();
            }

            if (data.proposal_open_contract) {
                updateContract(data.proposal_open_contract);
            }

            if (data.buy) {
                handleTradeOpened(data.buy);
            }
        }

        function loadMarkets() {
            sendWSMessage({
                active_symbols: 'brief',
                product_type: 'basic'
            });
        }

        function populateMarkets(symbols) {
            const select = document.getElementById('symbolSelect');
            select.innerHTML = '<optgroup label="Volatility Indices">';
            
            symbols.filter(s => s.market === 'synthetic_index').forEach(s => {
                select.innerHTML += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
            
            select.innerHTML += '</optgroup><optgroup label="Forex">';
            
            symbols.filter(s => s.market === 'forex').slice(0, 20).forEach(s => {
                select.innerHTML += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
            
            select.innerHTML += '</optgroup>';
            
            if (symbols.length > 0) {
                currentSymbol = symbols[0].symbol;
                subscribeToCandles();
            }
        }

        function subscribeToCandles() {
            if (!currentSymbol) return;
            
            // Get historical candles
            sendWSMessage({
                ticks_history: currentSymbol,
                adjust_start_time: 1,
                count: 100,
                end: 'latest',
                start: 1,
                style: 'candles',
                granularity: currentTimeframe
            });

            // Subscribe to real-time candles
            sendWSMessage({
                ticks_history: currentSymbol,
                adjust_start_time: 1,
                count: 1,
                end: 'latest',
                start: 1,
                style: 'candles',
                granularity: currentTimeframe,
                subscribe: 1
            });
        }

        function processCandles(data) {
            candles = data.map(c => ({
                time: c.epoch * 1000,
                open: parseFloat(c.open),
                high: parseFloat(c.high),
                low: parseFloat(c.low),
                close: parseFloat(c.close)
            }));
            
            if (candles.length > 0) {
                updateMarketData();
                updateChart();
                if (isTrading) analyzeMarket();
            }
        }

        function updateCandle(ohlc) {
            const newCandle = {
                time: ohlc.epoch * 1000,
                open: parseFloat(ohlc.open),
                high: parseFloat(ohlc.high),
                low: parseFloat(ohlc.low),
                close: parseFloat(ohlc.close)
            };

            if (candles.length > 0 && candles[candles.length - 1].time === newCandle.time) {
                candles[candles.length - 1] = newCandle;
            } else {
                candles.push(newCandle);
                if (candles.length > 100) candles.shift();
                
                // New candle closed - analyze for trades
                if (isTrading) analyzeMarket();
            }

            updateMarketData();
            updateChart();
        }

        function updateMarketData() {
            if (candles.length === 0) return;
            
            const latestCandle = candles[candles.length - 1];
            document.getElementById('currentPrice').textContent = latestCandle.close.toFixed(5);
            
            // Calculate indicators
            const closes = candles.map(c => c.close);
            
            if (closes.length >= 50) {
                const ema12 = calculateEMA(closes, 12);
                const ema50 = calculateEMA(closes, 50);
                const emaStatus = ema12 > ema50 ? 'Bullish' : 'Bearish';
                document.getElementById('emaStatus').textContent = emaStatus;
                document.getElementById('emaStatus').className = `text-lg font-bold ${ema12 > ema50 ? 'text-green-400' : 'text-red-400'}`;
                
                const macd = calculateMACD(closes);
                const macdSignal = macd.histogram > 0 ? 'Buy' : 'Sell';
                document.getElementById('macdSignal').textContent = macdSignal;
                document.getElementById('macdSignal').className = `text-lg font-bold ${macd.histogram > 0 ? 'text-green-400' : 'text-red-400'}`;
                
                const trend = determineTrend(closes);
                document.getElementById('trendIndicator').textContent = trend;
                document.getElementById('trendIndicator').className = `text-lg font-bold ${trend === 'Up' ? 'text-green-400' : trend === 'Down' ? 'text-red-400' : 'text-gray-400'}`;
            }
        }

        function analyzeMarket() {
            if (!isTrading || candles.length < 50) return;
            
            const closes = candles.map(c => c.close);
            let signal = null;
            let strategyUsed = null;

            // Check each active strategy
            for (const [key, strategy] of Object.entries(strategies)) {
                if (!strategy.active) continue;

                if (key === 'ema_cross') {
                    signal = checkEMACross(closes, strategy.params);
                } else if (key === 'sma_cross') {
                    signal = checkSMACross(closes, strategy.params);
                } else if (key === 'macd_ma') {
                    signal = checkMACDMA(closes, strategy.params);
                }

                if (signal) {
                    strategyUsed = key;
                    // Add signal marker to chart
                    addSignalToChart(signal, strategyUsed);
                    executeTrade(signal, key);
                    break; // Execute only one trade at a time
                }
            }
        }

        function checkEMACross(closes, params) {
            const emaFast = calculateEMA(closes, params.fastPeriod);
            const emaFastPrev = calculateEMA(closes.slice(0, -1), params.fastPeriod);
            const emaSlow = calculateEMA(closes, params.slowPeriod);
            const emaSlowPrev = calculateEMA(closes.slice(0, -1), params.slowPeriod);
            
            const latestCandle = candles[candles.length - 1];
            const prevCandle = candles[candles.length - 2];

            // Bullish cross
            if (emaFastPrev <= emaSlowPrev && emaFast > emaSlow) {
                if (!params.confirmCandle || (latestCandle.close > latestCandle.open)) {
                    return 'CALL';
                }
            }
            
            // Bearish cross
            if (emaFastPrev >= emaSlowPrev && emaFast < emaSlow) {
                if (!params.confirmCandle || (latestCandle.close < latestCandle.open)) {
                    return 'PUT';
                }
            }
            
            return null;
        }

        function checkSMACross(closes, params) {
            const smaFast = calculateSMA(closes, params.fastPeriod);
            const smaFastPrev = calculateSMA(closes.slice(0, -1), params.fastPeriod);
            const smaSlow = calculateSMA(closes, params.slowPeriod);
            const smaSlowPrev = calculateSMA(closes.slice(0, -1), params.slowPeriod);
            
            const latestCandle = candles[candles.length - 1];

            // Bullish cross
            if (smaFastPrev <= smaSlowPrev && smaFast > smaSlow) {
                if (!params.confirmCandle || (latestCandle.close > latestCandle.open)) {
                    return 'CALL';
                }
            }
            
            // Bearish cross
            if (smaFastPrev >= smaSlowPrev && smaFast < smaSlow) {
                if (!params.confirmCandle || (latestCandle.close < latestCandle.open)) {
                    return 'PUT';
                }
            }
            
            return null;
        }

        function checkMACDMA(closes, params) {
            const macd = calculateMACD(closes, params.macdFast, params.macdSlow, params.macdSignal);
            const macdPrev = calculateMACD(closes.slice(0, -1), params.macdFast, params.macdSlow, params.macdSignal);
            
            // Get MACD values for MA calculation
            const macdValues = [];
            for (let i = closes.length - params.maPeriod; i < closes.length; i++) {
                const m = calculateMACD(closes.slice(0, i + 1), params.macdFast, params.macdSlow, params.macdSignal);
                macdValues.push(m.MACD);
            }
            
            const ma = calculateSMA(macdValues, params.maPeriod);
            const maPrev = calculateSMA(macdValues.slice(0, -1), params.maPeriod);
            
            const latestCandle = candles[candles.length - 1];

            // Signal crosses below MA (bullish)
            if (macdPrev.signal >= maPrev && macd.signal < ma) {
                if (!params.confirmCandle || (latestCandle.close > latestCandle.open)) {
                    return 'CALL';
                }
            }
            
            // Signal crosses above MA (bearish)
            if (macdPrev.signal <= maPrev && macd.signal > ma) {
                if (!params.confirmCandle || (latestCandle.close < latestCandle.open)) {
                    return 'PUT';
                }
            }
            
            return null;
        }

        function executeTrade(type, strategyKey) {
            if (activeContracts.size > 0) return; // Don't trade if there's an active contract
            
            const maxRuns = parseInt(document.getElementById('maxRuns').value);
            if (currentRun >= maxRuns) {
                showNotification('Max trade runs reached', 'warning');
                stopTrading();
                return;
            }

            const targetProfit = parseFloat(document.getElementById('targetProfit').value);
            if (dailyProfit >= targetProfit) {
                showNotification('Daily profit target reached!', 'success');
                stopTrading();
                return;
            }

            const maxLoss = parseFloat(document.getElementById('maxLoss').value);
            if (dailyProfit <= -maxLoss) {
                showNotification('Max loss limit reached', 'error');
                stopTrading();
                return;
            }

            const stake = martingaleEnabled && currentRun > 0 ? 
                currentStake * parseFloat(document.getElementById('martingaleMultiplier').value) : 
                parseFloat(document.getElementById('initialStake').value);
            
            currentStake = stake;

            const durationUnit = document.getElementById('durationUnit').value;
            const duration = parseInt(document.getElementById('tradeDuration').value);

            // Get proposal first
            sendWSMessage({
                proposal: 1,
                amount: stake,
                basis: 'stake',
                contract_type: type,
                currency: 'USD',
                duration: duration,
                duration_unit: durationUnit,
                symbol: currentSymbol
            });
        }

        function handleTradeOpened(buyData) {
            const contract = {
                id: buyData.contract_id,
                buyPrice: parseFloat(buyData.buy_price),
                type: buyData.contract_type,
                startTime: Date.now()
            };

            activeContracts.set(contract.id, contract);
            currentRun++;
            
            updateActiveTradesUI();
            
            // Subscribe to contract updates
            sendWSMessage({
                proposal_open_contract: 1,
                contract_id: contract.id,
                subscribe: 1
            });

            showNotification(`${contract.type} trade opened - ${contract.buyPrice.toFixed(2)}`, 'info');
        }

        function updateContract(data) {
            const contract = activeContracts.get(data.proposal_open_contract.contract_id);
            if (!contract) return;

            contract.currentPrice = parseFloat(data.proposal_open_contract.bid_price || 0);
            contract.profit = parseFloat(data.proposal_open_contract.profit || 0);
            contract.status = data.proposal_open_contract.status;

            if (contract.status === 'sold') {
                handleTradeClosed(contract);
            } else {
                updateActiveTradesUI();
            }
        }

        function handleTradeClosed(contract) {
            activeContracts.delete(contract.id);
            
            const isWin = contract.profit > 0;
            
            if (isWin) {
                totalWins++;
                currentRun = 0; // Reset on win
                currentStake = parseFloat(document.getElementById('initialStake').value);
            } else {
                totalLosses++;
            }

            dailyProfit += contract.profit;
            
            tradeHistory.unshift({
                ...contract,
                endTime: Date.now()
            });

            if (tradeHistory.length > 50) tradeHistory.pop();

            updateAccountInfo();
            updateActiveTradesUI();
            updateTradeHistoryUI();
            
            showNotification(
                isWin ? `Won ${contract.profit.toFixed(2)}` : `Lost ${Math.abs(contract.profit).toFixed(2)}`,
                isWin ? 'success' : 'error'
            );

            // Continue trading if enabled
            if (isTrading) {
                setTimeout(() => analyzeMarket(), 2000);
            }
        }

        // Indicator Calculations
        function calculateEMA(data, period) {
            if (data.length < period) return data[data.length - 1];
            
            const k = 2 / (period + 1);
            let ema = data[0];
            
            for (let i = 1; i < data.length; i++) {
                ema = data[i] * k + ema * (1 - k);
            }
            
            return ema;
        }

        function calculateSMA(data, period) {
            if (data.length < period) return data[data.length - 1];
            
            const slice = data.slice(-period);
            return slice.reduce((a, b) => a + b, 0) / period;
        }

        function calculateMACD(data, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const emaFast = calculateEMA(data, fastPeriod);
            const emaSlow = calculateEMA(data, slowPeriod);
            const macdLine = emaFast - emaSlow;
            
            // For signal line, we'd need historical MACD values
            // Simplified version
            const signal = macdLine * 0.9; // Approximation
            const histogram = macdLine - signal;
            
            return { MACD: macdLine, signal, histogram };
        }

        function determineTrend(closes) {
            if (closes.length < 20) return 'Neutral';
            
            const sma20 = calculateSMA(closes, 20);
            const current = closes[closes.length - 1];
            
            if (current > sma20 * 1.001) return 'Up';
            if (current < sma20 * 0.999) return 'Down';
            return 'Neutral';
        }

        // Chart Functions
        function initializeChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            
            tradingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Price',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.1,
                            fill: true,
                            order: 1
                        },
                        {
                            label: 'EMA 12',
                            data: [],
                            borderColor: '#8b5cf6',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5],
                            order: 2
                        },
                        {
                            label: 'EMA 50',
                            data: [],
                            borderColor: '#ec4899',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5],
                            order: 3
                        },
                        {
                            label: 'SMA 12',
                            data: [],
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [2, 2],
                            order: 4
                        },
                        {
                            label: 'SMA 50',
                            data: [],
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [2, 2],
                            order: 5
                        },
                        {
                            label: 'Buy Signals',
                            data: [],
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointStyle: 'triangle',
                            showLine: false,
                            order: 0
                        },
                        {
                            label: 'Sell Signals',
                            data: [],
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointStyle: 'triangle',
                            rotation: 180,
                            showLine: false,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e2e8f0',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(5);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                maxTicksLimit: 8,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value.toFixed(5);
                                },
                                font: { size: 10 }
                            }
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            });
        }

        function updateChart() {
            if (!tradingChart || candles.length === 0) return;
            
            const closes = candles.map(c => c.close);
            const times = candles.map(c => new Date(c.time).toLocaleTimeString());
            
            // Calculate all indicators
            const ema12Values = [];
            const ema50Values = [];
            const sma12Values = [];
            const sma50Values = [];
            
            for (let i = 0; i < closes.length; i++) {
                const subset = closes.slice(0, i + 1);
                
                if (i >= 11) {
                    ema12Values.push(calculateEMA(subset, 12));
                    sma12Values.push(calculateSMA(subset, 12));
                } else {
                    ema12Values.push(null);
                    sma12Values.push(null);
                }
                
                if (i >= 49) {
                    ema50Values.push(calculateEMA(subset, 50));
                    sma50Values.push(calculateSMA(subset, 50));
                } else {
                    ema50Values.push(null);
                    sma50Values.push(null);
                }
            }
            
            // Update chart data
            tradingChart.data.labels = times;
            tradingChart.data.datasets[0].data = closes;
            tradingChart.data.datasets[1].data = ema12Values;
            tradingChart.data.datasets[2].data = ema50Values;
            tradingChart.data.datasets[3].data = sma12Values;
            tradingChart.data.datasets[4].data = sma50Values;
            
            tradingChart.update('none'); // Update without animation for smooth real-time updates
            
            // Update indicator values in UI
            if (closes.length >= 12) {
                document.getElementById('ema12Value').textContent = ema12Values[ema12Values.length - 1]?.toFixed(5) || '--';
            }
            if (closes.length >= 50) {
                document.getElementById('ema50Value').textContent = ema50Values[ema50Values.length - 1]?.toFixed(5) || '--';
                
                // Calculate signal strength
                const ema12 = ema12Values[ema12Values.length - 1];
                const ema50 = ema50Values[ema50Values.length - 1];
                const diff = Math.abs(ema12 - ema50);
                const strength = diff > ema50 * 0.001 ? 'Strong' : diff > ema50 * 0.0005 ? 'Medium' : 'Weak';
                document.getElementById('signalStrength').textContent = strength;
            }
        }

        function addSignalToChart(signal, strategy) {
            if (!tradingChart || candles.length === 0) return;
            
            const latestIndex = candles.length - 1;
            const latestPrice = candles[latestIndex].close;
            
            if (signal === 'CALL') {
                // Add buy signal
                const buyData = [...tradingChart.data.datasets[5].data];
                buyData[latestIndex] = latestPrice;
                tradingChart.data.datasets[5].data = buyData;
            } else {
                // Add sell signal
                const sellData = [...tradingChart.data.datasets[6].data];
                sellData[latestIndex] = latestPrice;
                tradingChart.data.datasets[6].data = sellData;
            }
            
            tradingChart.update('none');
        }

        function resetChartZoom() {
            if (tradingChart) {
                tradingChart.resetZoom();
            }
        }

        // UI Functions
        function toggleTrading() {
            if (!isConnected) {
                showNotification('Please connect to Deriv first', 'error');
                return;
            }

            isTrading = !isTrading;
            const btn = document.getElementById('startTradingBtn');
            
            if (isTrading) {
                btn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Trading';
                btn.className = 'px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition';
                showNotification('Trading started', 'success');
                currentRun = 0;
                analyzeMarket();
            } else {
                stopTrading();
            }
        }

        function stopTrading() {
            isTrading = false;
            const btn = document.getElementById('startTradingBtn');
            btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Trading';
            btn.className = 'px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition';
            showNotification('Trading stopped', 'warning');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const btn = document.getElementById('connectBtn');
            
            if (connected) {
                status.innerHTML = '<span class="status-dot status-connected"></span><span>Connected</span>';
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>Connected';
                btn.className = 'px-4 py-2 bg-green-600 rounded-lg text-sm font-medium';
            } else {
                status.innerHTML = '<span class="status-dot status-disconnected"></span><span>Disconnected</span>';
                btn.innerHTML = '<i class="fas fa-plug mr-2"></i>Connect';
                btn.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium pulse-connect';
            }
        }

        function updateAccountInfo() {
            document.getElementById('balance').textContent = `${accountBalance.toFixed(2)}`;
            document.getElementById('headerBalance').textContent = `${accountBalance.toFixed(2)}`;
            document.getElementById('dailyPL').textContent = `${dailyProfit.toFixed(2)}`;
            document.getElementById('dailyPL').className = `text-2xl font-bold ${dailyProfit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            const totalTrades = totalWins + totalLosses;
            document.getElementById('totalTrades').textContent = totalTrades;
            
            const winRate = totalTrades > 0 ? (totalWins / totalTrades * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
            
            document.getElementById('totalWins').textContent = totalWins;
            document.getElementById('totalLosses').textContent = totalLosses;
            
            const totalProfit = tradeHistory.filter(t => t.profit > 0).reduce((sum, t) => sum + t.profit, 0);
            const totalLoss = Math.abs(tradeHistory.filter(t => t.profit < 0).reduce((sum, t) => sum + t.profit, 0));
            const profitFactor = totalLoss > 0 ? (totalProfit / totalLoss) : 0;
            document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
            
            const avgWin = totalWins > 0 ? (totalProfit / totalWins) : 0;
            document.getElementById('avgWin').textContent = `${avgWin.toFixed(2)}`;
        }

        function updateActiveTradesUI() {
            const container = document.getElementById('activeTradesContainer');
            
            if (activeContracts.size === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No active trades</div>';
                return;
            }

            container.innerHTML = '';
            activeContracts.forEach(contract => {
                const div = document.createElement('div');
                div.className = `${contract.type === 'CALL' ? 'trade-buy' : 'trade-sell'} p-3 rounded-lg bg-gray-800/30`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold">${contract.type}</div>
                        <div class="text-sm ${contract.profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${contract.profit >= 0 ? '+' : ''}${contract.profit.toFixed(2)}
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Stake: ${contract.buyPrice.toFixed(2)}</span>
                        <span>${new Date(contract.startTime).toLocaleTimeString()}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateTradeHistoryUI() {
            const container = document.getElementById('tradeHistoryContainer');
            
            if (tradeHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No trades yet</div>';
                return;
            }

            container.innerHTML = '';
            tradeHistory.slice(0, 20).forEach(trade => {
                const div = document.createElement('div');
                div.className = `${trade.type === 'CALL' ? 'trade-buy' : 'trade-sell'} p-3 rounded-lg bg-gray-800/30`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <div class="font-bold">${trade.type}</div>
                            <div class="text-xs text-gray-400">${new Date(trade.endTime).toLocaleTimeString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${trade.profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${trade.profit >= 0 ? '+' : ''}${trade.profit.toFixed(2)}
                            </div>
                            <div class="text-xs text-gray-400">Stake: ${trade.buyPrice.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function initializeStrategies() {
            const container = document.getElementById('strategyContainer');
            container.innerHTML = '';

            Object.entries(strategies).forEach(([key, strategy]) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800/50 rounded-lg p-4 border border-gray-700 cursor-pointer hover:bg-gray-800/70 transition';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold mb-1">${strategy.name}</h4>
                            <span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">Inactive</span>
                        </div>
                        <button onclick="openStrategySettings('${key}')" class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleStrategy('${key}', this.checked)">
                            <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                        <span class="text-sm text-gray-400">Enable</span>
                    </div>
                `;
                div.dataset.strategyId = key;
                container.appendChild(div);
            });
        }

        function toggleStrategy(key, enabled) {
            strategies[key].active = enabled;
            const card = document.querySelector(`[data-strategy-id="${key}"]`);
            const statusSpan = card.querySelector('span');
            
            if (enabled) {
                card.classList.add('strategy-active');
                statusSpan.className = 'text-xs bg-green-900 text-green-300 px-2 py-1 rounded';
                statusSpan.textContent = 'Active';
                showNotification(`${strategies[key].name} activated`, 'success');
            } else {
                card.classList.remove('strategy-active');
                statusSpan.className = 'text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded';
                statusSpan.textContent = 'Inactive';
            }
        }

        function openStrategySettings(key) {
            const strategy = strategies[key];
            const modal = document.getElementById('settingsModal');
            const container = document.getElementById('strategySettings');
            
            let html = `<h4 class="font-bold text-lg mb-4">${strategy.name}</h4><div class="space-y-4">`;
            
            Object.entries(strategy.params).forEach(([param, value]) => {
                const label = param.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                
                if (typeof value === 'boolean') {
                    html += `
                        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded">
                            <span>${label}</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" ${value ? 'checked' : ''} onchange="updateStrategyParam('${key}', '${param}', this.checked)" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                    `;
                } else {
                    html += `
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">${label}</label>
                            <input type="number" value="${value}" onchange="updateStrategyParam('${key}', '${param}', parseFloat(this.value))" class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3">
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function updateStrategyParam(strategyKey, param, value) {
            strategies[strategyKey].params[param] = value;
            showNotification('Settings updated', 'success');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
        }

        function showNotification(msg, type = 'info') {
            const colors = {
                success: 'bg-green-900 text-green-300 border-green-700',
                error: 'bg-red-900 text-red-300 border-red-700',
                warning: 'bg-yellow-900 text-yellow-300 border-yellow-700',
                info: 'bg-blue-900 text-blue-300 border-blue-700'
            };

            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 toast ${colors[type]} border`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icons[type]} mr-2"></i>
                    <span>${msg}</span>
                </div>
            `;

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Event Listeners
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            candles = [];
            subscribeToCandles();
        });

        document.getElementById('timeframeSelect').addEventListener('change', (e) => {
            currentTimeframe = parseInt(e.target.value);
            candles = [];
            subscribeToCandles();
        });

        document.getElementById('martingaleToggle').addEventListener('change', (e) => {
            martingaleEnabled = e.target.checked;
            showNotification(`Martingale ${martingaleEnabled ? 'enabled' : 'disabled'}`, martingaleEnabled ? 'success' : 'warning');
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initializeStrategies();
            updateAccountInfo();
            initializeChart();
        });
    </script>
</body>
</html>
