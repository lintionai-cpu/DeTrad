<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deriv Options Trading Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
        }
        
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        
        /* Glass Effect */
        .glass {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Status Colors */
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        
        /* Volatility Indicators */
        .vol-low { 
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        .vol-medium { 
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
        }
        .vol-high { 
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { 
            background: #4b5563; 
            border-radius: 4px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .mobile-stack { flex-direction: column !important; }
            .mobile-full { width: 100% !important; }
            .mobile-text-sm { font-size: 0.875rem !important; }
            .mobile-p-2 { padding: 0.5rem !important; }
        }
        
        /* Gradient Backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* Switch Toggle */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #374151;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-switch.active {
            background: #8b5cf6;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            left: 26px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white min-h-screen">
    
    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-3 sm:p-4 lg:p-6">
        
        <!-- Header -->
        <div class="glass rounded-2xl p-4 sm:p-6 mb-4 animate-slide-in">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
                        Options Trading Pro
                    </h1>
                    <p class="text-sm text-gray-400 mt-1">Advanced Deriv Trading Platform</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div id="statusDot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                        <span id="statusText" class="text-sm font-medium">Offline</span>
                    </div>
                    <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            
            <!-- Stats Dashboard -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 p-4 rounded-xl border border-blue-500/20">
                    <p class="text-xs text-gray-400 mb-1">Balance</p>
                    <p id="balance" class="text-xl sm:text-2xl font-bold">$0.00</p>
                </div>
                <div class="bg-gradient-to-br from-green-900/50 to-green-800/30 p-4 rounded-xl border border-green-500/20">
                    <p class="text-xs text-gray-400 mb-1">Total P&L</p>
                    <p id="totalPnl" class="text-xl sm:text-2xl font-bold profit">$0.00</p>
                </div>
                <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 p-4 rounded-xl border border-purple-500/20">
                    <p class="text-xs text-gray-400 mb-1">Win Rate</p>
                    <p id="winRate" class="text-xl sm:text-2xl font-bold">0%</p>
                </div>
                <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 p-4 rounded-xl border border-orange-500/20">
                    <p class="text-xs text-gray-400 mb-1">Trades</p>
                    <p id="totalTrades" class="text-xl sm:text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- API Connection -->
        <div class="glass rounded-2xl p-4 sm:p-6 mb-4 animate-slide-in">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2">
                üîå <span>API Connection</span>
            </h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="password" 
                    id="apiToken" 
                    placeholder="Enter your Deriv API Token"
                    class="flex-1 bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                >
                <button 
                    onclick="connectAPI()" 
                    id="connectBtn"
                    class="gradient-primary px-8 py-3 rounded-xl font-semibold hover:scale-105 transform transition shadow-lg">
                    Connect
                </button>
            </div>
        </div>

        <!-- Strategy Selection -->
        <div class="glass rounded-2xl p-4 sm:p-6 mb-4 animate-slide-in">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2">
                üéØ <span>Trading Strategy</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <button onclick="selectStrategy('accumulators')" id="stratAccumulators" class="strategy-card bg-gradient-to-br from-purple-600 to-purple-800 p-4 rounded-xl border-2 border-purple-400 hover:scale-105 transform transition shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">üìà</span>
                        <span class="text-xs bg-green-500 px-2 py-1 rounded-full">ACTIVE</span>
                    </div>
                    <h3 class="font-bold text-lg mb-1">Accumulators Focus</h3>
                    <p class="text-xs text-gray-300">Auto-adjust growth rate based on volatility</p>
                </button>
                
            </div>
        </div>

        <!-- Accumulators Strategy Section -->
        <div id="accumulatorsSection" class="space-y-4">
            
            <!-- Market & Settings -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                
                <!-- Market Selection -->
                <div class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
                    <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2">
                        üìä <span>Market Selection</span>
                    </h2>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm mb-2 text-gray-300">Volatility Market</label>
                            <select id="market" onchange="changeMarket()" class="w-full bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                              <optgroup label="Volatility Indices">
                                <option value="R_10">Volatility 10 Index</option>
                                <option value="R_25">Volatility 25 Index</option>
                                <option value="R_50">Volatility 50 Index</option>
                                <option value="R_75">Volatility 75 Index</option>
                                <option value="R_100">Volatility 100 Index</option>
                                <option value="1HZ10V">Volatility 10 (1s) Index</option>
                                <option value="1HZ25V">Volatility 25 (1s) Index</option>
                                <option value="1HZ50V">Volatility 50 (1s) Index</option>
                                <option value="1HZ75V">Volatility 75 (1s) Index</option>
                                <option value="1HZ100V">Volatility 100 (1s) Index</option>
                            </optgroup>
                                <optgroup label="Crash/Boom">
                                  <option value="CRASH300N">Crash 300 Index</option>
                                  <option value="CRASH500">Crash 500 Index</option>
                                  <option value="CRASH1000">Crash 1000 Index</option>
                                  <option value="BOOM300N">Boom 300 Index</option>
                                  <option value="BOOM500">Boom 500 Index</option>
                                  <option value="BOOM1000">Boom 1000 Index</option>
                              </optgroup>
                              <optgroup label="Jump Indices">
                                <option value="JD10">Jump 10 Index</option>
                                <option value="JD25">Jump 25 Index</option>
                                <option value="JD50">Jump 50 Index</option>
                                <option value="JD75">Jump 75 Index</option>
                                <option value="JD100">Jump 100 Index</option>
                            </optgroup>
                            <optgroup label="Step Indices">
                                <option value="stpRNG">Step Index</option>
                            </optgroup>
                            <optgroup label="Range Break">
                                <option value="RDBULL">Range Break 100 Index</option>
                                <option value="RDBEAR">Range Break 200 Index</option>
                            </optgroup>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm mb-2 text-gray-300">Stake Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-400">$</span>
                                    <input type="number" id="stake" value="10" min="1" step="1"
                                        class="w-full bg-gray-800/50 border border-gray-600 rounded-xl pl-8 pr-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm mb-2 text-gray-300">Take Profit</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-400">$</span>
                                    <input type="number" id="takeProfit" value="5" min="1" step="0.5"
                                        class="w-full bg-gray-800/50 border border-gray-600 rounded-xl pl-8 pr-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm mb-2 text-gray-300">Max Ticks</label>
                                <input type="number" id="maxTicks" value="100" min="10" max="1000" step="10"
                                    class="w-full bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm mb-2 text-gray-300">Trade Runs</label>
                                <input type="number" id="tradeRuns" value="5" min="1" max="100" step="1"
                                    class="w-full bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <p class="text-xs text-gray-400 mt-1">Trades after each profit target</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Volatility Analysis & Growth Rate -->
                <div class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
                    <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2">
                        üåä <span>Market Analysis</span>
                    </h2>
                    
                    <!-- Real-time Volatility -->
                    <div id="volatilityIndicator" class="vol-low p-4 rounded-xl mb-4 text-center">
                        <p class="text-sm mb-1">Current Volatility</p>
                        <p id="volLevel" class="text-3xl font-bold">LOW</p>
                        <p id="volDesc" class="text-xs mt-1">Slow & Tight Movement</p>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">Movement</p>
                            <p id="avgMovement" class="text-sm font-bold">-</p>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">Range</p>
                            <p id="tickRange" class="text-sm font-bold">-</p>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg text-center">
                            <p class="text-xs text-gray-400">Ticks</p>
                            <p id="ticksAnalyzed" class="text-sm font-bold">0</p>
                        </div>
                    </div>
                    
                    <!-- Growth Rate Control -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-gradient-to-r from-purple-900/50 to-blue-900/50 p-3 rounded-xl">
                            <span class="text-sm font-semibold">Auto-Adjust Growth Rate</span>
                            <div class="toggle-switch active" id="autoGrowthToggle" onclick="toggleAutoGrowth()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        
                        <div id="manualGrowthSection" class="hidden">
                            <label class="block text-sm mb-2 text-gray-300">Manual Growth Rate</label>
                            <select id="manualGrowthRate" onchange="updateManualGrowth()" class="w-full bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="0.01">1% - Safest</option>
                                <option value="0.02">2% - Conservative</option>
                                <option value="0.03">3% - Balanced</option>
                                <option value="0.04">4% - Aggressive</option>
                                <option value="0.05">5% - Highest Risk</option>
                            </select>
                        </div>
                        
                        <div class="bg-gray-800/50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-400 mb-1">Current Growth Rate</p>
                            <p id="currentGrowth" class="text-3xl font-bold text-purple-400">1%</p>
                        </div>
                        
                        <!-- Live Growth Adjustment (during trade) -->
                        <div id="liveGrowthAdjust" class="hidden">
                            <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-xl p-3">
                                <p class="text-sm font-semibold text-yellow-400 mb-3">‚ö° Adjust Growth (Live Trade)</p>
                                <div class="grid grid-cols-5 gap-2">
                                    <button onclick="adjustGrowthLive(0.01)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-bold transition">1%</button>
                                    <button onclick="adjustGrowthLive(0.02)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-bold transition">2%</button>
                                    <button onclick="adjustGrowthLive(0.03)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-bold transition">3%</button>
                                    <button onclick="adjustGrowthLive(0.04)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-bold transition">4%</button>
                                    <button onclick="adjustGrowthLive(0.05)" class="bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-bold transition">5%</button>
                                </div>
                                <p class="text-xs text-gray-400 mt-2 text-center">Click to change rate instantly</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Controls -->
            <div class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <button onclick="startTrading()" id="startBtn" disabled
                        class="flex-1 gradient-success px-6 py-4 rounded-xl font-bold text-lg hover:scale-105 transform transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        üöÄ Start Trading
                    </button>
                    <button onclick="sellContract()" id="sellBtn" disabled
                        class="flex-1 gradient-warning px-6 py-4 rounded-xl font-bold text-lg hover:scale-105 transform transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        üí∞ Sell Now
                    </button>
                    <button onclick="stopTrading()" id="stopBtn" disabled
                        class="flex-1 gradient-danger px-6 py-4 rounded-xl font-bold text-lg hover:scale-105 transform transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        ‚õî Stop
                    </button>
                </div>
                
                <!-- Progress Stats -->
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Completed</p>
                        <p id="completedRuns" class="text-2xl font-bold text-green-400">0</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Remaining</p>
                        <p id="remainingRuns" class="text-2xl font-bold text-yellow-400">5</p>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">Status</p>
                        <p id="tradingStatus" class="text-sm font-bold text-gray-400">IDLE</p>
                    </div>
                </div>
            </div>

            <!-- Active Contract Monitor -->
            <div class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
                <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center gap-2">
                    üìà <span>Active Contract</span>
                </h2>
                
                <div id="activeContract" class="hidden">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                        <div class="bg-gradient-to-br from-green-900/50 to-green-800/30 p-4 rounded-xl border border-green-500/20">
                            <p class="text-xs text-gray-400 mb-1">Current Profit</p>
                            <p id="currentProfit" class="text-2xl font-bold profit">$0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-900/50 to-blue-800/30 p-4 rounded-xl border border-blue-500/20">
                            <p class="text-xs text-gray-400 mb-1">Ticks</p>
                            <p id="currentTicks" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-900/50 to-purple-800/30 p-4 rounded-xl border border-purple-500/20">
                            <p class="text-xs text-gray-400 mb-1">Growth</p>
                            <p id="activeGrowth" class="text-2xl font-bold text-purple-400">1%</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-900/50 to-orange-800/30 p-4 rounded-xl border border-orange-500/20">
                            <p class="text-xs text-gray-400 mb-1">Duration</p>
                            <p id="tradeDuration" class="text-2xl font-bold">0s</p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="bg-gray-800/50 p-4 rounded-xl">
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span>Progress to Target</span>
                            <span id="progressText">$0.00 / $5.00</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div id="profitProgress" class="gradient-success h-4 rounded-full transition-all duration-300 animate-pulse" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span id="tickProgress">Tick 0 / 100</span>
                            <span id="percentComplete">0%</span>
                        </div>
                    </div>
                </div>
                
                <div id="noContract" class="text-center py-12">
                    <div class="text-6xl mb-4">üìä</div>
                    <p class="text-gray-400">No active contract</p>
                    <p class="text-sm text-gray-500 mt-2">Start trading to see live updates</p>
                </div>
            </div>

            <!-- Trade History -->
            <div class="glass rounded-2xl p-4 sm:p-6 animate-slide-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                        üìú <span>Trade History</span>
                    </h2>
                    <button onclick="clearHistory()" class="text-sm bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition">
                        Clear All
                    </button>
                </div>
                
                <div id="tradeHistory" class="space-y-3">
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-400">No trades yet</p>
                        <p class="text-sm text-gray-500 mt-2">Your trade history will appear here</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Variables
        let ws = null;
        let isConnected = false;
        let isTrading = false;
        let autoGrowthEnabled = true;
        let currentStrategy = 'accumulators';
        
        // Account Data
        let balance = 0;
        let totalPnl = 0;
        let totalTrades = 0;
        let wins = 0;
        let losses = 0;
        
        // Market Data
        let tickData = [];
        let currentMarket = '1HZ10V';
        let tickSubscription = null;
        
        // Trading Data
        let currentContractId = null;
        let currentProfit = 0;
        let currentTicks = 0;
        let currentGrowthRate = 0.01;
        let tradeStartTime = null;
        
        // Strategy Settings
        let completedRuns = 0;
        let maxRuns = 5;
        let tradeHistory = [];
        
        // Volatility Analysis
        let volatilityLevel = 'LOW';
        let avgMovement = 0;
        let tickRange = 0;

        // ====================
        // API CONNECTION
        // ====================
        
        function connectAPI() {
            const token = document.getElementById('apiToken').value.trim();
            
            if (!token) {
                showNotification('Please enter your API token', 'error');
                return;
            }
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = 'Connecting...';
            
            ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
            
            ws.onopen = () => {
                ws.send(JSON.stringify({ authorize: token }));
            };
            
            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
                showNotification('Connection error', 'error');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'Connect';
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'Connect';
            };
        }
        
        function handleWebSocketMessage(data) {
            switch(data.msg_type) {
                case 'authorize':
                    handleAuthorize(data);
                    break;
                case 'balance':
                    handleBalance(data);
                    break;
                case 'tick':
                    handleTick(data);
                    break;
                case 'buy':
                    handleBuy(data);
                    break;
                case 'proposal_open_contract':
                    handleContractUpdate(data);
                    break;
                case 'sell':
                    handleSell(data);
                    break;
                default:
                    console.log('Unhandled message:', data);
            }
        }
        
        function handleAuthorize(data) {
            if (data.error) {
                showNotification('Authorization failed: ' + data.error.message, 'error');
                updateConnectionStatus(false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = 'Connect';
                return;
            }
            
            isConnected = true;
            balance = parseFloat(data.authorize.balance);
            
            updateConnectionStatus(true);
            updateBalance();
            subscribeToMarket();
            document.getElementById('startBtn').disabled = false;
            
            showNotification('Connected successfully!', 'success');
            
            // Subscribe to balance updates
            ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        }
        
        function handleBalance(data) {
            balance = parseFloat(data.balance.balance);
            updateBalance();
        }
        
        function handleTick(data) {
            if (!data.tick) return;
            
            const tick = parseFloat(data.tick.quote);
            tickData.push(tick);
            
            // Keep only last 30 ticks for analysis
            if (tickData.length > 30) {
                tickData.shift();
            }
            
            analyzeVolatility();
            updateTickDisplay();
        }
        
        function handleBuy(data) {
            if (data.error) {
                showNotification('Buy failed: ' + data.error.message, 'error');
                resetTrading();
                return;
            }
            
            currentContractId = data.buy.contract_id;
            currentTicks = 0;
            currentProfit = 0;
            tradeStartTime = Date.now();
            
            // Subscribe to contract updates
            ws.send(JSON.stringify({
                proposal_open_contract: 1,
                contract_id: currentContractId,
                subscribe: 1
            }));
            
            showActiveContract();
            addTradeToHistory('OPEN', 0);
            
            // Show live growth adjustment buttons
            document.getElementById('liveGrowthAdjust').classList.remove('hidden');
        }
        
        function handleContractUpdate(data) {
            if (!data.proposal_open_contract) return;
            
            const contract = data.proposal_open_contract;
            
            currentProfit = parseFloat(contract.profit || 0);
            currentTicks = parseInt(contract.tick_count || 0);
            
            updateActiveContractDisplay();
            updateTradeHistoryLive(currentProfit, currentTicks);
            
            // Check conditions
            const targetProfit = parseFloat(document.getElementById('takeProfit').value);
            const maxTicks = parseInt(document.getElementById('maxTicks').value);
            
            if (currentProfit >= targetProfit || currentTicks >= maxTicks) {
                sellContract();
            }
            
            // Check if contract is closed
            if (contract.status === 'sold' || contract.is_sold) {
                handleContractClosed(contract);
            }
        }
        
        function handleSell(data) {
            if (data.error) {
                console.error('Sell error:', data.error);
                return;
            }
            
            showNotification('Contract sold', 'info');
        }
        
        function handleContractClosed(contract) {
            const profit = parseFloat(contract.profit || 0);
            const buyPrice = parseFloat(contract.buy_price || 0);
            const sellPrice = parseFloat(contract.sell_price || 0);
            
            // Update stats
            totalPnl += profit;
            totalTrades++;
            
            if (profit > 0) {
                wins++;
                showNotification(`Win! +${profit.toFixed(2)}`, 'success');
            } else {
                losses++;
                showNotification(`Loss: ${profit.toFixed(2)}`, 'error');
            }
            
            updateStats();
            finalizeTradeHistory(profit > 0 ? 'WIN' : 'LOSS', profit);
            
            // Hide live growth adjustment
            document.getElementById('liveGrowthAdjust').classList.add('hidden');
            
            // Reset contract
            currentContractId = null;
            hideActiveContract();
            
            // Continue or stop
            completedRuns++;
            updateRunsDisplay();
            
            if (isTrading && completedRuns < maxRuns) {
                setTimeout(() => {
                    startAccumulator();
                }, 2000);
            } else {
                stopTrading();
                if (completedRuns >= maxRuns) {
                    showNotification(`Completed ${maxRuns} trade runs!`, 'success');
                }
            }
        }

        // ====================
        // MARKET FUNCTIONS
        // ====================
        
        function subscribeToMarket() {
            currentMarket = document.getElementById('market').value;
            
            if (tickSubscription) {
                ws.send(JSON.stringify({ forget: tickSubscription }));
            }
            
            ws.send(JSON.stringify({
                ticks: currentMarket,
                subscribe: 1
            }));
        }
        
        function changeMarket() {
            if (!isConnected) return;
            
            tickData = [];
            subscribeToMarket();
            showNotification('Market changed', 'info');
        }
        
        function analyzeVolatility() {
            if (tickData.length < 5) return;
            
            // Calculate average movement
            let totalMovement = 0;
            for (let i = 1; i < tickData.length; i++) {
                totalMovement += Math.abs(tickData[i] - tickData[i-1]);
            }
            avgMovement = totalMovement / (tickData.length - 1);
            
            // Calculate range
            const max = Math.max(...tickData);
            const min = Math.min(...tickData);
            tickRange = max - min;
            
            // Determine volatility level
            let newVolLevel = 'LOW';
            let recommendedGrowth = 0.05;
            let description = 'Slow & Tight Movement';
            let cssClass = 'vol-low';
            
            if (avgMovement > 0.02 || tickRange > 0.5) {
                newVolLevel = 'HIGH';
                recommendedGrowth = 0.01;
                description = 'Fast & Wide Movement';
                cssClass = 'vol-high';
            } else if (avgMovement > 0.01 || tickRange > 0.2) {
                newVolLevel = 'MEDIUM';
                recommendedGrowth = 0.03;
                description = 'Moderate Movement';
                cssClass = 'vol-medium';
            }
            
            volatilityLevel = newVolLevel;
            
            // Update display
            const indicator = document.getElementById('volatilityIndicator');
            indicator.className = `${cssClass} p-4 rounded-xl mb-4 text-center transition-all duration-500`;
            document.getElementById('volLevel').textContent = newVolLevel;
            document.getElementById('volDesc').textContent = description;
            
            // Auto-adjust growth rate if enabled and not in active trade
            if (autoGrowthEnabled && !currentContractId) {
                currentGrowthRate = recommendedGrowth;
                updateGrowthDisplay();
            }
        }
        
        function updateTickDisplay() {
            document.getElementById('avgMovement').textContent = avgMovement.toFixed(5);
            document.getElementById('tickRange').textContent = tickRange.toFixed(5);
            document.getElementById('ticksAnalyzed').textContent = tickData.length;
        }

        // ====================
        // TRADING FUNCTIONS
        // ====================
        
        function startTrading() {
            if (!isConnected) {
                showNotification('Please connect to API first', 'error');
                return;
            }
            
            if (tickData.length < 5) {
                showNotification('Collecting market data...', 'info');
                return;
            }
            
            isTrading = true;
            completedRuns = 0;
            maxRuns = parseInt(document.getElementById('tradeRuns').value);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('tradingStatus').textContent = 'ACTIVE';
            document.getElementById('tradingStatus').className = 'text-sm font-bold text-green-400';
            
            updateRunsDisplay();
            startAccumulator();
        }
        
        function startAccumulator() {
            const stake = parseFloat(document.getElementById('stake').value);
            const market = document.getElementById('market').value;
            
            // Use manual growth rate if auto-adjust is off
            if (!autoGrowthEnabled) {
                currentGrowthRate = parseFloat(document.getElementById('manualGrowthRate').value);
            }
            
            const buyRequest = {
                buy: 1,
                price: stake,
                parameters: {
                    amount: stake,
                    basis: 'stake',
                    contract_type: 'ACCU',
                    currency: 'USD',
                    growth_rate: currentGrowthRate,
                    symbol: market
                }
            };
            
            ws.send(JSON.stringify(buyRequest));
            document.getElementById('sellBtn').disabled = false;
        }
        
        function sellContract() {
            if (!currentContractId) return;
            
            ws.send(JSON.stringify({
                sell: currentContractId,
                price: 0
            }));
            
            document.getElementById('sellBtn').disabled = true;
        }
        
        function stopTrading() {
            isTrading = false;
            
            if (currentContractId) {
                sellContract();
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('sellBtn').disabled = true;
            document.getElementById('tradingStatus').textContent = 'STOPPED';
            document.getElementById('tradingStatus').className = 'text-sm font-bold text-red-400';
            
            showNotification('Trading stopped', 'info');
        }
        
        function adjustGrowthLive(newRate) {
            if (!currentContractId) {
                showNotification('No active trade to adjust', 'error');
                return;
            }
            
            // Sell current contract
            sellContract();
            
            // Update growth rate
            currentGrowthRate = newRate;
            autoGrowthEnabled = false;
            document.getElementById('autoGrowthToggle').classList.remove('active');
            updateGrowthDisplay();
            
            showNotification(`Growth rate changed to ${(newRate * 100).toFixed(0)}%`, 'success');
            
            // Start new trade with new rate after current sells
            setTimeout(() => {
                if (isTrading) {
                    startAccumulator();
                }
            }, 3000);
        }

        // ====================
        // GROWTH RATE CONTROLS
        // ====================
        
        function toggleAutoGrowth() {
            autoGrowthEnabled = !autoGrowthEnabled;
            
            const toggle = document.getElementById('autoGrowthToggle');
            const manualSection = document.getElementById('manualGrowthSection');
            
            if (autoGrowthEnabled) {
                toggle.classList.add('active');
                manualSection.classList.add('hidden');
                analyzeVolatility(); // Re-calculate
            } else {
                toggle.classList.remove('active');
                manualSection.classList.remove('hidden');
                currentGrowthRate = parseFloat(document.getElementById('manualGrowthRate').value);
            }
            
            updateGrowthDisplay();
        }
        
        function updateManualGrowth() {
            if (!autoGrowthEnabled) {
                currentGrowthRate = parseFloat(document.getElementById('manualGrowthRate').value);
                updateGrowthDisplay();
            }
        }
        
        function updateGrowthDisplay() {
            const percentage = (currentGrowthRate * 100).toFixed(0);
            document.getElementById('currentGrowth').textContent = `${percentage}%`;
            document.getElementById('activeGrowth').textContent = `${percentage}%`;
        }

        // ====================
        // DISPLAY UPDATES
        // ====================
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                text.textContent = 'Online';
                text.className = 'text-sm font-medium status-online';
            } else {
                dot.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                text.textContent = 'Offline';
                text.className = 'text-sm font-medium status-offline';
            }
        }
        
        function updateBalance() {
            document.getElementById('balance').textContent = `${balance.toFixed(2)}`;
        }
        
        function updateStats() {
            document.getElementById('totalPnl').textContent = `${totalPnl.toFixed(2)}`;
            document.getElementById('totalPnl').className = `text-xl sm:text-2xl font-bold ${totalPnl >= 0 ? 'profit' : 'loss'}`;
            
            const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            
            document.getElementById('totalTrades').textContent = totalTrades;
        }
        
        function updateRunsDisplay() {
            document.getElementById('completedRuns').textContent = completedRuns;
            document.getElementById('remainingRuns').textContent = Math.max(0, maxRuns - completedRuns);
        }
        
        function showActiveContract() {
            document.getElementById('activeContract').classList.remove('hidden');
            document.getElementById('noContract').classList.add('hidden');
        }
        
        function hideActiveContract() {
            document.getElementById('activeContract').classList.add('hidden');
            document.getElementById('noContract').classList.remove('hidden');
        }
        
        function updateActiveContractDisplay() {
            // Update profit
            document.getElementById('currentProfit').textContent = `${currentProfit.toFixed(2)}`;
            document.getElementById('currentProfit').className = `text-2xl font-bold ${currentProfit >= 0 ? 'profit' : 'loss'}`;
            
            // Update ticks
            document.getElementById('currentTicks').textContent = currentTicks;
            
            // Update duration
            if (tradeStartTime) {
                const duration = Math.floor((Date.now() - tradeStartTime) / 1000);
                document.getElementById('tradeDuration').textContent = `${duration}s`;
            }
            
            // Update progress bar
            const targetProfit = parseFloat(document.getElementById('takeProfit').value);
            const maxTicks = parseInt(document.getElementById('maxTicks').value);
            
            const profitProgress = Math.min((currentProfit / targetProfit) * 100, 100);
            document.getElementById('profitProgress').style.width = `${Math.max(0, profitProgress)}%`;
            
            document.getElementById('progressText').textContent = `${currentProfit.toFixed(2)} / ${targetProfit.toFixed(2)}`;
            document.getElementById('tickProgress').textContent = `Tick ${currentTicks} / ${maxTicks}`;
            document.getElementById('percentComplete').textContent = `${profitProgress.toFixed(1)}%`;
        }

        // ====================
        // TRADE HISTORY
        // ====================
        
        function addTradeToHistory(status, profit) {
            const container = document.getElementById('tradeHistory');
            
            // Remove empty state
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const market = document.getElementById('market').value;
            const stake = parseFloat(document.getElementById('stake').value);
            const tradeId = `trade-${Date.now()}`;
            
            const tradeCard = document.createElement('div');
            tradeCard.id = tradeId;
            tradeCard.className = 'bg-gray-800/50 border-l-4 border-yellow-500 rounded-xl p-4 animate-slide-in';
            
            tradeCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <span class="text-xs text-gray-400">${timestamp}</span>
                        <span class="ml-2 px-2 py-1 text-xs font-bold bg-yellow-500 text-gray-900 rounded">ACTIVE</span>
                    </div>
                    <span class="text-sm font-bold text-gray-300">${market}</span>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Stake</p>
                        <p class="font-bold">${stake.toFixed(2)}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Growth</p>
                        <p class="font-bold text-purple-400">${(currentGrowthRate * 100).toFixed(0)}%</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Profit</p>
                        <p class="font-bold profit" id="${tradeId}-profit">$0.00</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Ticks</p>
                        <p class="font-bold" id="${tradeId}-ticks">0</p>
                    </div>
                </div>
            `;
            
            container.insertBefore(tradeCard, container.firstChild);
            
            tradeHistory.unshift({ id: tradeId, status: 'ACTIVE' });
        }
        
        function updateTradeHistoryLive(profit, ticks) {
            if (tradeHistory.length === 0) return;
            
            const latestTrade = tradeHistory[0];
            const profitEl = document.getElementById(`${latestTrade.id}-profit`);
            const ticksEl = document.getElementById(`${latestTrade.id}-ticks`);
            
            if (profitEl) {
                profitEl.textContent = `${profit.toFixed(2)}`;
                profitEl.className = `font-bold ${profit >= 0 ? 'profit' : 'loss'}`;
            }
            
            if (ticksEl) {
                ticksEl.textContent = ticks;
            }
        }
        
        function finalizeTradeHistory(result, profit) {
            if (tradeHistory.length === 0) return;
            
            const latestTrade = tradeHistory[0];
            const tradeCard = document.getElementById(latestTrade.id);
            
            if (!tradeCard) return;
            
            const borderColor = result === 'WIN' ? 'border-green-500' : 'border-red-500';
            const badgeColor = result === 'WIN' ? 'bg-green-500' : 'bg-red-500';
            const badgeText = result === 'WIN' ? '‚úì WIN' : '‚úó LOSS';
            
            tradeCard.className = `bg-gray-800/50 border-l-4 ${borderColor} rounded-xl p-4`;
            
            const badge = tradeCard.querySelector('.bg-yellow-500');
            if (badge) {
                badge.className = `ml-2 px-2 py-1 text-xs font-bold ${badgeColor} text-white rounded`;
                badge.textContent = badgeText;
            }
            
            latestTrade.status = result;
        }
        
        function clearHistory() {
            if (confirm('Clear all trade history?')) {
                tradeHistory = [];
                document.getElementById('tradeHistory').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-400">No trades yet</p>
                        <p class="text-sm text-gray-500 mt-2">Your trade history will appear here</p>
                    </div>
                `;
            }
        }

        // ====================
        // STRATEGY SELECTION
        // ====================
        
        function selectStrategy(strategy) {
            currentStrategy = strategy;
            
            // Update UI - only accumulators is active for now
            if (strategy === 'accumulators') {
                document.getElementById('accumulatorsSection').classList.remove('hidden');
            } else {
                showNotification('This strategy is coming soon!', 'info');
            }
        }

        // ====================
        // UTILITIES
        // ====================
        
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-slide-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function resetTrading() {
            isTrading = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('sellBtn').disabled = true;
            document.getElementById('tradingStatus').textContent = 'IDLE';
            document.getElementById('tradingStatus').className = 'text-sm font-bold text-gray-400';
        }
        
        function showSettings() {
            showNotification('Settings panel coming soon!', 'info');
        }
        
        // Initialize
        updateGrowthDisplay();
    </script>
</body>

</html>
