<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Factor Trader Pro - Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes glow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(139, 92, 246, 0.7);
        }
      }
      .toast {
        animation: slideIn 0.3s ease;
      }
      .pulse {
        animation: pulse 2s ease-in-out infinite;
      }
      .spin {
        animation: spin 1s linear infinite;
      }
      .glow {
        animation: glow 2s ease-in-out infinite;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen"
  >
    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm"
    ></div>

    <!-- Auth Modal -->
    <div
      id="authModal"
      class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-gray-700"
      >
        <h2
          class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent"
        >
          üöÄ All Factor Trader Pro
        </h2>
        <p class="text-gray-400 text-center mb-6">
          Enter passcode to access advanced trading system
        </p>
        <input
          type="password"
          id="authPass"
          placeholder="Enter Passcode"
          class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          onclick="authenticate()"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-3 rounded-lg font-bold hover:opacity-90 transition"
        >
          UNLOCK SYSTEM
        </button>
        <p class="text-xs text-gray-500 text-center mt-4">
          Default passcode: 1234
        </p>
      </div>
    </div>

    <div id="mainApp" class="hidden p-2 sm:p-4">
      <div class="max-w-7xl mx-auto space-y-3 sm:space-y-4">
        <!-- Header Dashboard -->
        <div
          class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-2xl"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
          >
            <div>
              <h1 class="text-2xl sm:text-4xl font-bold">
                üöÄ ALL FACTOR TRADER PRO
              </h1>
              <p class="text-blue-100 text-xs sm:text-base mt-1">
                Advanced Multi-Strategy Deriv Trading System
              </p>
            </div>
            <div
              class="flex items-center gap-2 sm:gap-3 bg-black/30 px-3 sm:px-4 py-2 rounded-lg backdrop-blur"
            >
              <span
                id="connDot"
                class="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-red-500"
              ></span>
              <span id="connStatus" class="font-semibold text-sm sm:text-base"
                >Disconnected</span
              >
            </div>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4 hover:bg-white/20 transition"
            >
              <p class="text-xs text-blue-200">Balance</p>
              <p id="balance" class="text-lg sm:text-2xl font-bold">$0.00</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4 hover:bg-white/20 transition"
            >
              <p class="text-xs text-purple-200">Session PnL</p>
              <p id="totalPnL" class="text-lg sm:text-2xl font-bold">$0.00</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4 hover:bg-white/20 transition"
            >
              <p class="text-xs text-green-200">Win Rate</p>
              <p id="winRate" class="text-lg sm:text-2xl font-bold">0%</p>
            </div>
            <div
              class="bg-white/10 backdrop-blur rounded-lg sm:rounded-xl p-3 sm:p-4 hover:bg-white/20 transition"
            >
              <p class="text-xs text-orange-200">Total Trades</p>
              <p id="totalTrades" class="text-lg sm:text-2xl font-bold">0</p>
            </div>
          </div>

          <div
            class="grid grid-cols-2 sm:grid-cols-5 gap-2 sm:gap-3 mt-3 sm:mt-4"
          >
            <div class="bg-black/20 backdrop-blur p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Current Price</p>
              <p
                id="currentPrice"
                class="text-sm sm:text-lg font-bold text-blue-400"
              >
                -
              </p>
            </div>
            <div class="bg-black/20 backdrop-blur p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Signal</p>
              <p
                id="currentSignal"
                class="text-sm sm:text-lg font-bold text-yellow-400"
              >
                WAIT
              </p>
            </div>
            <div class="bg-black/20 backdrop-blur p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Confidence</p>
              <p
                id="confidence"
                class="text-sm sm:text-lg font-bold text-green-400"
              >
                0%
              </p>
            </div>
            <div class="bg-black/20 backdrop-blur p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Stake</p>
              <p
                id="currentStake"
                class="text-sm sm:text-lg font-bold text-purple-400"
              >
                $0
              </p>
            </div>
            <div class="bg-black/20 backdrop-blur p-2 sm:p-3 rounded-lg">
              <p class="text-xs">Status</p>
              <p
                id="tradeStatus"
                class="text-sm sm:text-lg font-bold text-orange-400"
              >
                IDLE
              </p>
            </div>
          </div>
        </div>

        <!-- API Connection -->
        <div
          class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
        >
          <h2
            class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex items-center gap-2"
          >
            üîê Deriv API Connection
          </h2>
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <input
              type="password"
              id="apiToken"
              placeholder="Enter Deriv API Token"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              onclick="connect()"
              class="bg-green-600 px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold hover:bg-green-700 transition text-sm sm:text-base"
            >
              Connect
            </button>
            <button
              onclick="disconnect()"
              class="bg-red-600 px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold hover:bg-red-700 transition text-sm sm:text-base"
            >
              Disconnect
            </button>
          </div>
        </div>

        <!-- Configuration Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
          <!-- Market & Strategy -->
          <div
            class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
          >
            <h2
              class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex items-center gap-2"
            >
              üìä Market & Strategy Selection
            </h2>

            <label class="text-xs sm:text-sm text-gray-400 mb-1 block"
              >Market Symbol</label
            >
            <select
              id="market"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 mb-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <optgroup label="Volatility Indices">
                <option value="R_10">Volatility 10 Index</option>
                <option value="R_25">Volatility 25 Index</option>
                <option value="R_50">Volatility 50 Index</option>
                <option value="R_75">Volatility 75 Index</option>
                <option value="R_100">Volatility 100 Index</option>
                <option value="1HZ10V">Volatility 10 (1s) Index</option>
                <option value="1HZ25V">Volatility 25 (1s) Index</option>
                <option value="1HZ50V">Volatility 50 (1s) Index</option>
                <option value="1HZ75V">Volatility 75 (1s) Index</option>
                <option value="1HZ100V">Volatility 100 (1s) Index</option>
              </optgroup>
              <optgroup label="Crash/Boom Indices">
                <option value="BOOM300N">Boom 300 Index</option>
                <option value="BOOM500">Boom 500 Index</option>
                <option value="BOOM1000">Boom 1000 Index</option>
                <option value="CRASH300N">Crash 300 Index</option>
                <option value="CRASH500">Crash 500 Index</option>
                <option value="CRASH1000">Crash 1000 Index</option>
              </optgroup>
            </select>

            <label class="text-xs sm:text-sm text-gray-400 mb-1 block"
              >Contract Type</label
            >
            <select
              id="contractType"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 mb-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="CALL">Rise/Fall</option>
              <option value="CALLE">Rise Equals</option>
              <option value="PUTE">Fall Equals</option>
              <option value="DIGITEVEN">Even/Odd</option>
              <option value="DIGITMATCH">Matches/Differs</option>
              <option value="DIGITOVER">Over/Under</option>
            </select>

            <label class="text-xs sm:text-sm text-gray-400 mb-1 block"
              >Trading Strategy</label
            >
            <select
              id="strategy"
              class="w-full bg-gray-700 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <optgroup label="üîµ RISE Strategies">
                <option value="RISE-TREND">RISE: Trend + Momentum (EMA/RSI/ADX)</option>
                <option value="RISE-SCALP">RISE: Momentum Scalping (EMA/MACD/BB)</option>
                <option value="RISE-VOL">RISE: Volatility Confirmation (BB/RSI/EMA)</option>
              </optgroup>
              <optgroup label="üî¥ FALL Strategies">
                <option value="FALL-TREND">FALL: Trend + Momentum (EMA/RSI/ADX)</option>
                <option value="FALL-SCALP">FALL: Momentum Scalping (EMA/MACD/BB)</option>
                <option value="FALL-VOL">FALL: Volatility Confirmation (BB/RSI/EMA)</option>
              </optgroup>
              <optgroup label="‚ö° Advanced Combos">
                <option value="ADAPTIVE">Adaptive: Auto-Switch Best Strategy</option>
                <option value="MULTI-CONFIRM">Multi-Confirm: Triple Indicator Lock</option>
                <option value="PRECISION">Precision: High Win Rate (70%+)</option>
              </optgroup>
            </select>
          </div>

          <!-- Risk Management -->
          <div
            class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
          >
            <h2
              class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex items-center gap-2"
            >
              ‚öôÔ∏è Risk Management & Parameters
            </h2>
            <div class="grid grid-cols-2 gap-2 sm:gap-3">
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Stake Amount ($)</label
                >
                <input
                  type="number"
                  id="stake"
                  value="1"
                  min="0.35"
                  step="0.1"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Duration (ticks)</label
                >
                <input
                  type="number"
                  id="duration"
                  value="7"
                  min="1"
                  max="10"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Max Loss ($)</label
                >
                <input
                  type="number"
                  id="maxLoss"
                  value="50"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Max Profit ($)</label
                >
                <input
                  type="number"
                  id="maxProfit"
                  value="100"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Min Confidence (%)</label
                >
                <input
                  type="number"
                  id="minConfidence"
                  value="70"
                  min="0"
                  max="100"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="text-xs sm:text-sm text-gray-400"
                  >Trade Cooldown</label
                >
                <input
                  type="number"
                  id="tradeDelay"
                  value="5"
                  min="3"
                  max="10"
                  class="w-full bg-gray-700 rounded px-2 sm:px-3 py-2 mt-1 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
            <label
              class="flex items-center gap-2 mt-3 text-sm sm:text-base cursor-pointer hover:text-blue-400 transition"
            >
              <input
                type="checkbox"
                id="martingale"
                class="w-4 h-4 sm:w-5 sm:h-5"
              />
              <span>Enable Martingale (Max 3 steps)</span>
            </label>
            <label
              class="flex items-center gap-2 mt-2 text-sm sm:text-base cursor-pointer hover:text-blue-400 transition"
            >
              <input
                type="checkbox"
                id="soundNotif"
                checked
                class="w-4 h-4 sm:w-5 sm:h-5"
              />
              <span>Sound Notifications</span>
            </label>
          </div>
        </div>

        <!-- Trading Controls -->
        <div
          class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
        >
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
            <button
              onclick="startTrading()"
              id="startBtn"
              class="bg-green-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-green-700 transition glow"
            >
              üöÄ START AUTO
            </button>
            <button
              onclick="stopTrading()"
              id="stopBtn"
              disabled
              class="bg-red-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg opacity-50 transition"
            >
              ‚õî STOP AUTO
            </button>
            <button
              onclick="singleTrade()"
              class="bg-blue-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-blue-700 transition"
            >
              ‚ö° SINGLE TRADE
            </button>
            <button
              onclick="reset()"
              class="bg-yellow-600 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-lg hover:bg-yellow-700 transition"
            >
              üîÑ RESET SESSION
            </button>
          </div>
        </div>

        <!-- Indicators Panel -->
        <div
          class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
        >
          <h2 class="text-lg sm:text-xl font-bold mb-3 flex items-center gap-2">
            üìà Live Technical Indicators
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-gray-700 p-3 rounded-lg">
              <p class="text-xs text-gray-400">RSI (14)</p>
              <p id="rsiValue" class="text-lg font-bold text-blue-400">--</p>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg">
              <p class="text-xs text-gray-400">ADX (14)</p>
              <p id="adxValue" class="text-lg font-bold text-purple-400">--</p>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg">
              <p class="text-xs text-gray-400">EMA 20</p>
              <p id="emaValue" class="text-lg font-bold text-green-400">--</p>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg">
              <p class="text-xs text-gray-400">MACD</p>
              <p id="macdValue" class="text-lg font-bold text-orange-400">--</p>
            </div>
          </div>
        </div>

        <!-- Trade History -->
        <div
          class="bg-gray-800 rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-xl border border-gray-700"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
          >
            <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
              üìú Trade History
            </h2>
            <button
              onclick="exportCSV()"
              class="bg-purple-600 px-3 sm:px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm sm:text-base"
            >
              üì• Export CSV
            </button>
          </div>
          <div class="overflow-x-auto -mx-4 sm:mx-0">
            <table class="w-full text-xs sm:text-sm min-w-[700px]">
              <thead class="bg-gray-700">
                <tr>
                  <th class="p-2 sm:p-3 text-left">Time</th>
                  <th class="p-2 sm:p-3 text-left">Strategy</th>
                  <th class="p-2 sm:p-3 text-left">Type</th>
                  <th class="p-2 sm:p-3 text-left">Signal</th>
                  <th class="p-2 sm:p-3 text-left">Stake</th>
                  <th class="p-2 sm:p-3 text-left">Result</th>
                  <th class="p-2 sm:p-3 text-left">PnL</th>
                </tr>
              </thead>
              <tbody id="history">
                <tr>
                  <td colspan="7" class="p-6 sm:p-8 text-center text-gray-500">
                    No trades yet - Start trading to see history
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============= GLOBAL STATE =============
      let ws = null;
      let isConnected = false;
      let isTrading = false;
      let isProcessing = false;
      let balance = 0;
      let totalPnL = 0;
      let totalTrades = 0;
      let totalWins = 0;
      let currentStake = 1;
      let martingaleStep = 0;
      let priceHistory = [];
      let tradeHistory = [];
      let lastTradeTime = 0;
      let activeContractId = null;
      let ticksSinceLastTrade = 0;

      // Technical indicator values
      let indicators = {
        rsi: 50,
        adx: 0,
        ema20: 0,
        ema50: 0,
        macd: { line: 0, signal: 0, histogram: 0 },
        bb: { upper: 0, middle: 0, lower: 0 }
      };

      // ============= AUTHENTICATION =============
      function authenticate() {
        const pass = document.getElementById("authPass").value;
        if (pass === "1234" || pass === "admin" || pass === "deriv") {
          document.getElementById("authModal").classList.add("hidden");
          document.getElementById("mainApp").classList.remove("hidden");
          showToast(
            "üéâ Authentication successful! Welcome to All Factor Trader Pro",
            "success"
          );
          loadSessionData();
        } else {
          showToast("‚ùå Invalid passcode", "error");
          document.getElementById("authPass").value = "";
        }
      }

      document.getElementById("authPass").addEventListener("keypress", (e) => {
        if (e.key === "Enter") authenticate();
      });

      // ============= SESSION PERSISTENCE =============
      function saveSessionData() {
        const sessionData = {
          balance,
          totalPnL,
          totalTrades,
          totalWins,
          tradeHistory: tradeHistory.slice(0, 100),
          timestamp: Date.now()
        };
        try {
          localStorage.setItem('tradingSession', JSON.stringify(sessionData));
        } catch (e) {
          console.log('Storage not available');
        }
      }

      function loadSessionData() {
        try {
          const stored = localStorage.getItem('tradingSession');
          if (stored) {
            const data = JSON.parse(stored);
            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
              totalPnL = data.totalPnL || 0;
              totalTrades = data.totalTrades || 0;
              totalWins = data.totalWins || 0;
              tradeHistory = data.tradeHistory || [];
              updateUI();
              updateHistory();
              showToast("üìÇ Previous session loaded", "info");
            }
          }
        } catch (e) {
          console.log('Could not load session');
        }
      }

      // ============= TOAST NOTIFICATIONS =============
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast px-4 py-3 rounded-lg shadow-2xl text-sm sm:text-base ${
          type === "success"
            ? "bg-green-600"
            : type === "error"
            ? "bg-red-600"
            : type === "warning"
            ? "bg-yellow-600"
            : "bg-blue-600"
        }`;
        toast.textContent = message;
        document.getElementById("toastContainer").appendChild(toast);

        if (document.getElementById("soundNotif").checked) {
          playSound(type);
        }

        setTimeout(() => toast.remove(), 5000);
      }

      function playSound(type) {
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value =
            type === "success" ? 800 : type === "error" ? 400 : 600;
          oscillator.type = "sine";

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 0.5
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
          console.log("Audio not supported");
        }
      }

      // ============= UI UPDATES =============
      function updateUI() {
        document.getElementById("balance").textContent = `$${balance.toFixed(2)}`;
        document.getElementById("totalPnL").textContent = `$${totalPnL.toFixed(2)}`;
        document.getElementById("totalPnL").className = `text-lg sm:text-2xl font-bold ${
          totalPnL >= 0 ? "text-green-400" : "text-red-400"
        }`;
        document.getElementById("winRate").textContent =
          totalTrades > 0
            ? `${((totalWins / totalTrades) * 100).toFixed(1)}%`
            : "0%";
        document.getElementById("totalTrades").textContent = totalTrades;
        document.getElementById("currentStake").textContent = `${currentStake.toFixed(2)}`;
        
        // Update indicators display
        document.getElementById("rsiValue").textContent = indicators.rsi.toFixed(1);
        document.getElementById("adxValue").textContent = indicators.adx.toFixed(1);
        document.getElementById("emaValue").textContent = indicators.ema20 > 0 ? indicators.ema20.toFixed(5) : "--";
        document.getElementById("macdValue").textContent = indicators.macd.histogram.toFixed(4);
        
        saveSessionData();
      }

      function updateConnectionStatus(connected) {
        isConnected = connected;
        document.getElementById("connStatus").textContent = connected
          ? "‚úÖ Connected"
          : "‚ùå Disconnected";
        document.getElementById("connDot").className = `w-2 h-2 sm:w-3 sm:h-3 rounded-full ${
          connected ? "bg-green-500 pulse" : "bg-red-500"
        }`;
      }

      function updateTradeStatus(status) {
        const statusEl = document.getElementById("tradeStatus");
        statusEl.textContent = status;
        const colors = {
          IDLE: "text-gray-400",
          ANALYZING: "text-yellow-400",
          SIGNAL: "text-green-400 pulse",
          TRADING: "text-blue-400 pulse",
          WAITING: "text-orange-400",
          COOLDOWN: "text-purple-400"
        };
        statusEl.className = `text-sm sm:text-lg font-bold ${
          colors[status] || "text-gray-400"
        }`;
      }

      // ============= TECHNICAL INDICATORS LIBRARY =============
      function calculateEMA(data, period) {
        if (data.length < period) return null;
        const k = 2 / (period + 1);
        let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
        for (let i = period; i < data.length; i++) {
          ema = data[i] * k + ema * (1 - k);
        }
        return ema;
      }

      function calculateSMA(data, period) {
        if (data.length < period) return null;
        return data.slice(-period).reduce((a, b) => a + b, 0) / period;
      }

      function calculateRSI(data, period = 14) {
        if (data.length < period + 1) return 50;
        let gains = 0, losses = 0;
        for (let i = data.length - period; i < data.length; i++) {
          const change = data[i] - data[i - 1];
          if (change > 0) gains += change;
          else losses -= change;
        }
        const avgGain = gains / period;
        const avgLoss = losses / period;
        const rs = avgGain / (avgLoss || 0.0001);
        return 100 - 100 / (1 + rs);
      }

      function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
        if (data.length < slow) return null;
        
        const emaFast = [];
        const emaSlow = [];
        
        let fastK = 2 / (fast + 1);
        let slowK = 2 / (slow + 1);
        
        let fastEma = data.slice(0, fast).reduce((a, b) => a + b) / fast;
        let slowEma = data.slice(0, slow).reduce((a, b) => a + b) / slow;
        
        for (let i = Math.max(fast, slow); i < data.length; i++) {
          fastEma = data[i] * fastK + fastEma * (1 - fastK);
          slowEma = data[i] * slowK + slowEma * (1 - slowK);
          emaFast.push(fastEma);
          emaSlow.push(slowEma);
        }
        
        const macdLine = emaFast.map((v, i) => v - emaSlow[i]);
        
        if (macdLine.length < signal) return null;
        
        let signalK = 2 / (signal + 1);
        let signalEma = macdLine.slice(0, signal).reduce((a, b) => a + b) / signal;
        const signalLine = [signalEma];
        
        for (let i = signal; i < macdLine.length; i++) {
          signalEma = macdLine[i] * signalK + signalEma * (1 - signalK);
          signalLine.push(signalEma);
        }
        
        const histogram = macdLine.slice(-signalLine.length).map((v, i) => v - signalLine[i]);
        
        return {
          line: macdLine[macdLine.length - 1],
          signal: signalLine[signalLine.length - 1],
          histogram: histogram[histogram.length - 1]
        };
      }

      function calculateADX(data, period = 14) {
        if (data.length < period + 1) return 0;
        
        let plusDM = 0, minusDM = 0, tr = 0;
        
        for (let i = data.length - period; i < data.length; i++) {
          if (i === 0) continue;
          
          const high = data[i];
          const low = data[i];
          const prevHigh = data[i - 1];
          const prevLow = data[i - 1];
          const prevClose = data[i - 1];
          
          const upMove = high - prevHigh;
          const downMove = prevLow - low;
          
          if (upMove > downMove && upMove > 0) plusDM += upMove;
          if (downMove > upMove && downMove > 0) minusDM += downMove;
          
          const trueRange = Math.max(
            high - low,
            Math.abs(high - prevClose),
            Math.abs(low - prevClose)
          );
          tr += trueRange;
        }
        
        const avgPlusDM = plusDM / period;
        const avgMinusDM = minusDM / period;
        const avgTR = tr / period;
        
        const plusDI = avgTR > 0 ? (avgPlusDM / avgTR) * 100 : 0;
        const minusDI = avgTR > 0 ? (avgMinusDM / avgTR) * 100 : 0;
        
        const dx = (plusDI + minusDI) > 0 ? 
          (Math.abs(plusDI - minusDI) / (plusDI + minusDI)) * 100 : 0;
        
        return dx;
      }

      function calculateBollingerBands(data, period = 20, stdDev = 2) {
        if (data.length < period) return null;
        
        const sma = calculateSMA(data, period);
        const slice = data.slice(-period);
        const variance = slice.reduce((sum, val) => 
          sum + Math.pow(val - sma, 2), 0) / period;
        const std = Math.sqrt(variance);
        
        return {
          upper: sma + (std * stdDev),
          middle: sma,
          lower: sma - (std * stdDev)
        };
      }

      function getEMASlope(data, period) {
        if (data.length < period + 5) return 0;
        const ema1 = calculateEMA(data.slice(0, -5), period);
        const ema2 = calculateEMA(data, period);
        if (!ema1 || !ema2) return 0;
        return ema2 - ema1;
      }

      function updateIndicators() {
        if (priceHistory.length < 30) return;
        
        indicators.rsi = calculateRSI(priceHistory, 14);
        indicators.adx = calculateADX(priceHistory, 14);
        indicators.ema20 = calculateEMA(priceHistory, 20);
        indicators.ema50 = calculateEMA(priceHistory, 50);
        
        const macd = calculateMACD(priceHistory);
        if (macd) indicators.macd = macd;
        
        const bb = calculateBollingerBands(priceHistory);
        if (bb) indicators.bb = bb;
        
        updateUI();
      }

      // ============= ADVANCED TRADING STRATEGIES =============
      
      // RISE: Trend + Momentum Strategy
      function strategyRiseTrend() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const prevPrice = priceHistory[priceHistory.length - 2];
        const rsi = indicators.rsi;
        const prevRSI = calculateRSI(priceHistory.slice(0, -1), 14);
        const adx = indicators.adx;
        const ema20 = indicators.ema20;
        const emaSlope = getEMASlope(priceHistory, 20);
        
        // Market Qualification
        if (adx <= 20) return null;
        if (emaSlope <= 0) return null;
        if (price <= ema20) return null;
        
        // Momentum Alignment
        if (rsi < 55 || rsi > 65) return null;
        if (rsi <= prevRSI) return null;
        
        // Tick Confirmation
        const pricePulledBack = prevPrice < price && prevPrice >= ema20 * 0.999;
        const nextTickHigher = price > prevPrice;
        
        if (!pricePulledBack || !nextTickHigher) return null;
        
        const confidence = 0.75 + (adx / 100) * 0.15;
        
        return {
          signal: "CALL",
          confidence: Math.min(confidence, 0.95),
          expiry: 7,
          reason: "RISE: Trend+Momentum Confirmed"
        };
      }

      // FALL: Trend + Momentum Strategy
      function strategyFallTrend() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const prevPrice = priceHistory[priceHistory.length - 2];
        const rsi = indicators.rsi;
        const prevRSI = calculateRSI(priceHistory.slice(0, -1), 14);
        const adx = indicators.adx;
        const ema20 = indicators.ema20;
        const emaSlope = getEMASlope(priceHistory, 20);
        
        // Market Qualification
        if (adx <= 20) return null;
        if (emaSlope >= 0) return null;
        if (price >= ema20) return null;
        
        // Momentum Alignment
        if (rsi < 35 || rsi > 45) return null;
        if (rsi >= prevRSI) return null;
        
        // Tick Confirmation
        const pricePulledBack = prevPrice > price && prevPrice <= ema20 * 1.001;
        const nextTickLower = price < prevPrice;
        
        if (!pricePulledBack || !nextTickLower) return null;
        
        const confidence = 0.75 + (adx / 100) * 0.15;
        
        return {
          signal: "PUT",
          confidence: Math.min(confidence, 0.95),
          expiry: 7,
          reason: "FALL: Trend+Momentum Confirmed"
        };
      }

      // RISE: Momentum Scalping
      function strategyRiseScalp() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const ema9 = calculateEMA(priceHistory, 9);
        const ema21 = calculateEMA(priceHistory, 21);
        const prevEma9 = calculateEMA(priceHistory.slice(0, -1), 9);
        const prevEma21 = calculateEMA(priceHistory.slice(0, -1), 21);
        const macd = indicators.macd;
        const bb = indicators.bb;
        
        if (!ema9 || !ema21 || !prevEma9 || !prevEma21 || !bb) return null;
        
        const emaCross = prevEma9 <= prevEma21 && ema9 > ema21;
        const macdBullish = macd.histogram > 0 && macd.line > macd.signal;
        const priceRespectsBand = price > bb.lower && price < bb.upper;
        
        if (!emaCross || !macdBullish || !priceRespectsBand) return null;
        
        const confidence = 0.72;
        
        return {
          signal: "CALL",
          confidence: confidence,
          expiry: 5,
          reason: "RISE: Scalp Signal (EMA/MACD/BB)"
        };
      }

      // FALL: Momentum Scalping
      function strategyFallScalp() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const ema9 = calculateEMA(priceHistory, 9);
        const ema21 = calculateEMA(priceHistory, 21);
        const prevEma9 = calculateEMA(priceHistory.slice(0, -1), 9);
        const prevEma21 = calculateEMA(priceHistory.slice(0, -1), 21);
        const macd = indicators.macd;
        const bb = indicators.bb;
        
        if (!ema9 || !ema21 || !prevEma9 || !prevEma21 || !bb) return null;
        
        const emaCross = prevEma9 >= prevEma21 && ema9 < ema21;
        const macdBearish = macd.histogram < 0 && macd.line < macd.signal;
        const priceRespectsBand = price > bb.lower && price < bb.upper;
        
        if (!emaCross || !macdBearish || !priceRespectsBand) return null;
        
        const confidence = 0.72;
        
        return {
          signal: "PUT",
          confidence: confidence,
          expiry: 5,
          reason: "FALL: Scalp Signal (EMA/MACD/BB)"
        };
      }

      // RISE: Volatility Confirmation
      function strategyRiseVol() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const prevPrice = priceHistory[priceHistory.length - 2];
        const bb = indicators.bb;
        const rsi = indicators.rsi;
        const ema20 = indicators.ema20;
        
        if (!bb) return null;
        
        const priceExpandingUp = prevPrice <= bb.lower && price > bb.lower;
        const rsiConfirms = rsi > 50 && rsi < 70;
        const aboveEMA = price > ema20;
        
        if (!priceExpandingUp || !rsiConfirms || !aboveEMA) return null;
        
        const confidence = 0.70;
        
        return {
          signal: "CALL",
          confidence: confidence,
          expiry: 8,
          reason: "RISE: Volatility Expansion (BB/RSI)"
        };
      }

      // FALL: Volatility Confirmation
      function strategyFallVol() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const prevPrice = priceHistory[priceHistory.length - 2];
        const bb = indicators.bb;
        const rsi = indicators.rsi;
        const ema20 = indicators.ema20;
        
        if (!bb) return null;
        
        const priceExpandingDown = prevPrice >= bb.upper && price < bb.upper;
        const rsiConfirms = rsi < 50 && rsi > 30;
        const belowEMA = price < ema20;
        
        if (!priceExpandingDown || !rsiConfirms || !belowEMA) return null;
        
        const confidence = 0.70;
        
        return {
          signal: "PUT",
          confidence: confidence,
          expiry: 8,
          reason: "FALL: Volatility Expansion (BB/RSI)"
        };
      }

      // Adaptive Strategy - Auto-selects best
      function strategyAdaptive() {
        const strategies = [
          strategyRiseTrend(),
          strategyFallTrend(),
          strategyRiseScalp(),
          strategyFallScalp(),
          strategyRiseVol(),
          strategyFallVol()
        ];
        
        const validSignals = strategies.filter(s => s !== null);
        if (validSignals.length === 0) return null;
        
        validSignals.sort((a, b) => b.confidence - a.confidence);
        return validSignals[0];
      }

      // Multi-Confirm Strategy - Triple lock
      function strategyMultiConfirm() {
        if (priceHistory.length < 50) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const rsi = indicators.rsi;
        const adx = indicators.adx;
        const ema20 = indicators.ema20;
        const macd = indicators.macd;
        const bb = indicators.bb;
        
        if (!bb) return null;
        
        let bullishScore = 0;
        let bearishScore = 0;
        
        // RSI check
        if (rsi > 55 && rsi < 70) bullishScore++;
        if (rsi < 45 && rsi > 30) bearishScore++;
        
        // Trend check
        if (price > ema20 && adx > 20) bullishScore++;
        if (price < ema20 && adx > 20) bearishScore++;
        
        // MACD check
        if (macd.histogram > 0 && macd.line > macd.signal) bullishScore++;
        if (macd.histogram < 0 && macd.line < macd.signal) bearishScore++;
        
        if (bullishScore >= 3) {
          return {
            signal: "CALL",
            confidence: 0.85,
            expiry: 10,
            reason: "Multi-Confirm: 3/3 Bullish"
          };
        }
        
        if (bearishScore >= 3) {
          return {
            signal: "PUT",
            confidence: 0.85,
            expiry: 10,
            reason: "Multi-Confirm: 3/3 Bearish"
          };
        }
        
        return null;
      }

      // Precision Strategy - High win rate
      function strategyPrecision() {
        if (priceHistory.length < 60) return null;
        
        const price = priceHistory[priceHistory.length - 1];
        const rsi = indicators.rsi;
        const adx = indicators.adx;
        const ema20 = indicators.ema20;
        const ema50 = indicators.ema50;
        const macd = indicators.macd;
        
        if (!ema50 || adx < 25) return null;
        
        const strongUptrend = price > ema20 && ema20 > ema50 && getEMASlope(priceHistory, 20) > 0;
        const strongDowntrend = price < ema20 && ema20 < ema50 && getEMASlope(priceHistory, 20) < 0;
        
        if (strongUptrend && rsi > 58 && rsi < 68 && macd.histogram > 0) {
          return {
            signal: "CALL",
            confidence: 0.90,
            expiry: 9,
            reason: "Precision: Strong Bull Alignment"
          };
        }
        
        if (strongDowntrend && rsi < 42 && rsi > 32 && macd.histogram < 0) {
          return {
            signal: "PUT",
            confidence: 0.90,
            expiry: 9,
            reason: "Precision: Strong Bear Alignment"
          };
        }
        
        return null;
      }

      // ============= STRATEGY ROUTER =============
      function analyzeMarket() {
        if (priceHistory.length < 30) return null;
        
        updateIndicators();
        
        // Check trade cooldown
        if (ticksSinceLastTrade < parseInt(document.getElementById("tradeDelay").value)) {
          updateTradeStatus("COOLDOWN");
          return null;
        }
        
        const strategy = document.getElementById("strategy").value;
        let result = null;
        
        const strategyMap = {
          "RISE-TREND": strategyRiseTrend,
          "FALL-TREND": strategyFallTrend,
          "RISE-SCALP": strategyRiseScalp,
          "FALL-SCALP": strategyFallScalp,
          "RISE-VOL": strategyRiseVol,
          "FALL-VOL": strategyFallVol,
          "ADAPTIVE": strategyAdaptive,
          "MULTI-CONFIRM": strategyMultiConfirm,
          "PRECISION": strategyPrecision
        };

        result = strategyMap[strategy] ? strategyMap[strategy]() : strategyAdaptive();

        if (result) {
          document.getElementById("currentSignal").textContent = result.signal;
          document.getElementById("confidence").textContent = `${(
            result.confidence * 100
          ).toFixed(0)}%`;
          updateTradeStatus("SIGNAL");

          const minConf =
            parseFloat(document.getElementById("minConfidence").value) / 100;
          if (isTrading && !isProcessing && result.confidence >= minConf) {
            executeTrade(result);
          }
        } else {
          document.getElementById("currentSignal").textContent = "WAIT";
          document.getElementById("confidence").textContent = "0%";
          if (isTrading && !isProcessing) {
            updateTradeStatus("ANALYZING");
          }
        }

        return result;
      }

      // ============= TRADE EXECUTION =============
      function executeTrade(signal) {
        if (isProcessing || !isConnected || !ws) return;

        isProcessing = true;
        updateTradeStatus("TRADING");

        const martingaleEnabled = document.getElementById("martingale").checked;
        const baseStake = parseFloat(document.getElementById("stake").value);
        currentStake =
          martingaleEnabled && martingaleStep > 0 ? currentStake : baseStake;

        let tradeType = signal.signal;
        const contractType = document.getElementById("contractType").value;

        if (contractType === "CALLE" && tradeType === "CALL")
          tradeType = "CALLE";
        if (contractType === "PUTE" && tradeType === "PUT") tradeType = "PUTE";
        if (contractType.startsWith("DIGIT")) tradeType = contractType;

        const proposal = {
          proposal: 1,
          amount: currentStake,
          basis: "stake",
          contract_type: tradeType,
          currency: "USD",
          duration:
            signal.expiry ||
            parseInt(document.getElementById("duration").value),
          duration_unit: "t",
          symbol: document.getElementById("market").value,
        };

        showToast(
          `üìä Placing ${tradeType} - ${currentStake.toFixed(2)} | ${
            signal.reason
          }`,
          "info"
        );

        try {
          ws.send(JSON.stringify(proposal));
        } catch (error) {
          showToast("‚ùå Failed to send trade proposal", "error");
          isProcessing = false;
          updateTradeStatus("IDLE");
        }
      }

      // ============= DERIV API CONNECTION =============
      function connect() {
        const token = document.getElementById("apiToken").value.trim();
        if (!token) {
          showToast("‚ö†Ô∏è Please enter your Deriv API token", "error");
          return;
        }

        showToast("üîÑ Connecting to Deriv...", "info");

        try {
          ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=1089");

          ws.onopen = () => {
            ws.send(JSON.stringify({ authorize: token }));
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              if (data.error) {
                showToast(`‚ùå API Error: ${data.error.message}`, "error");
                updateConnectionStatus(false);
                return;
              }

              handleWebSocketMessage(data);
            } catch (error) {
              console.error("Message parse error:", error);
            }
          };

          ws.onerror = (error) => {
            showToast("‚ùå WebSocket connection error", "error");
            updateConnectionStatus(false);
          };

          ws.onclose = () => {
            updateConnectionStatus(false);
            isTrading = false;
            showToast("üîå Disconnected from Deriv", "warning");
          };
        } catch (error) {
          showToast("‚ùå Failed to establish connection", "error");
          updateConnectionStatus(false);
        }
      }

      function handleWebSocketMessage(data) {
        if (data.msg_type === "authorize" && data.authorize) {
          balance = parseFloat(data.authorize.balance);
          updateConnectionStatus(true);
          updateUI();
          showToast("‚úÖ Connected successfully!", "success");

          const market = document.getElementById("market").value;
          ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
          ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        } else if (data.msg_type === "tick") {
          const price = parseFloat(data.tick.quote);
          priceHistory.push(price);
          if (priceHistory.length > 200) priceHistory.shift();

          document.getElementById("currentPrice").textContent =
            price.toFixed(5);
          
          ticksSinceLastTrade++;

          if (priceHistory.length >= 30 && !isProcessing) {
            analyzeMarket();
          }
        } else if (data.msg_type === "proposal" && data.proposal) {
          ws.send(
            JSON.stringify({
              buy: data.proposal.id,
              price: data.proposal.ask_price,
            })
          );
        } else if (data.msg_type === "buy" && data.buy) {
          activeContractId = data.buy.contract_id;
          ws.send(
            JSON.stringify({
              proposal_open_contract: 1,
              contract_id: data.buy.contract_id,
              subscribe: 1,
            })
          );
          ticksSinceLastTrade = 0;
        } else if (data.msg_type === "proposal_open_contract") {
          const contract = data.proposal_open_contract;
          if (contract.status === "sold" || contract.is_sold) {
            handleContractResult(contract);
          }
        } else if (data.msg_type === "balance") {
          balance = parseFloat(data.balance.balance);
          updateUI();
        }
      }

      function handleContractResult(contract) {
        const profit = parseFloat(contract.profit);
        const isWin = profit > 0;

        totalPnL += profit;
        totalTrades++;
        if (isWin) totalWins++;

        tradeHistory.unshift({
          time: new Date().toLocaleTimeString(),
          strategy: document.getElementById("strategy").value,
          type: contract.contract_type,
          signal: contract.contract_type,
          stake: parseFloat(contract.buy_price),
          result: isWin ? "Win" : "Loss",
          pnl: profit,
        });

        const martingaleEnabled = document.getElementById("martingale").checked;
        if (isWin) {
          showToast(`‚úÖ WIN! +${profit.toFixed(2)}`, "success");
          martingaleStep = 0;
          currentStake = parseFloat(document.getElementById("stake").value);
        } else {
          showToast(`‚ùå LOSS: ${profit.toFixed(2)}`, "error");
          if (martingaleEnabled && martingaleStep < 3) {
            martingaleStep++;
            currentStake *= 2;
            showToast(
              `‚ö†Ô∏è Martingale Step ${martingaleStep}: ${currentStake.toFixed(
                2
              )}`,
              "warning"
            );
          } else {
            martingaleStep = 0;
            currentStake = parseFloat(document.getElementById("stake").value);
          }
        }

        updateHistory();
        updateUI();
        isProcessing = false;
        activeContractId = null;

        if (isTrading) {
          updateTradeStatus("ANALYZING");
        } else {
          updateTradeStatus("IDLE");
        }

        const maxLoss = parseFloat(document.getElementById("maxLoss").value);
        const maxProfit = parseFloat(
          document.getElementById("maxProfit").value
        );

        if (Math.abs(totalPnL) >= maxLoss && totalPnL < 0) {
          stopTrading();
          showToast("üõë Max loss limit reached!", "error");
        }
        if (totalPnL >= maxProfit) {
          stopTrading();
          showToast("üéâ Profit target achieved!", "success");
        }
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
          isTrading = false;
          isProcessing = false;
          updateConnectionStatus(false);
          updateTradeStatus("IDLE");
        }
      }

      // ============= TRADING CONTROLS =============
      function startTrading() {
        if (!isConnected) {
          showToast("‚ö†Ô∏è Please connect to Deriv API first", "error");
          return;
        }
        if (priceHistory.length < 30) {
          showToast("‚è≥ Collecting market data...", "warning");
          return;
        }

        isTrading = true;
        document.getElementById("startBtn").disabled = true;
        document.getElementById("startBtn").classList.add("opacity-50");
        document.getElementById("stopBtn").disabled = false;
        document.getElementById("stopBtn").classList.remove("opacity-50");
        updateTradeStatus("ANALYZING");
        showToast("üöÄ Automated trading started!", "success");
      }

      function stopTrading() {
        isTrading = false;
        document.getElementById("startBtn").disabled = false;
        document.getElementById("startBtn").classList.remove("opacity-50");
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("stopBtn").classList.add("opacity-50");
        updateTradeStatus("IDLE");
        showToast("‚õî Automated trading stopped", "info");
      }

      function singleTrade() {
        if (!isConnected) {
          showToast("‚ö†Ô∏è Please connect to Deriv API first", "error");
          return;
        }

        if (isProcessing) {
          showToast("‚è≥ Trade already in progress...", "warning");
          return;
        }

        const signal = analyzeMarket();
        if (signal && signal.confidence >= 0.5) {
          executeTrade(signal);
        } else {
          showToast("‚ùå No valid trading signal detected", "warning");
        }
      }

      function reset() {
        if (
          !confirm(
            "‚ö†Ô∏è Reset all session data? This will clear your PnL and trade history."
          )
        )
          return;

        totalPnL = 0;
        totalTrades = 0;
        totalWins = 0;
        martingaleStep = 0;
        currentStake = parseFloat(document.getElementById("stake").value);
        priceHistory = [];
        tradeHistory = [];
        ticksSinceLastTrade = 0;

        document.getElementById("history").innerHTML =
          '<tr><td colspan="7" class="p-6 sm:p-8 text-center text-gray-500">No trades yet - Start trading to see history</td></tr>';
        document.getElementById("currentSignal").textContent = "WAIT";
        document.getElementById("confidence").textContent = "0%";

        try {
          localStorage.removeItem('tradingSession');
        } catch (e) {}

        updateUI();
        showToast("üîÑ Session reset successfully!", "success");
      }

      // ============= HISTORY MANAGEMENT =============
      function updateHistory() {
        const tbody = document.getElementById("history");
        if (tradeHistory.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="p-6 sm:p-8 text-center text-gray-500">No trades yet - Start trading to see history</td></tr>';
          return;
        }

        tbody.innerHTML = tradeHistory
          .slice(0, 50)
          .map(
            (trade) => `
        <tr class="hover:bg-gray-700 border-b border-gray-700 transition">
          <td class="p-2 sm:p-3 text-xs sm:text-sm">${trade.time}</td>
          <td class="p-2 sm:p-3">
            <span class="text-xs bg-gray-700 px-2 py-1 rounded">${
              trade.strategy
            }</span>
          </td>
          <td class="p-2 sm:p-3 text-xs sm:text-sm">${trade.type}</td>
          <td class="p-2 sm:p-3">
            <span class="text-xs ${
              trade.signal === "CALL" || trade.signal === "CALLE"
                ? "text-green-400"
                : "text-red-400"
            } font-semibold">
              ${trade.signal}
            </span>
          </td>
          <td class="p-2 sm:p-3 text-xs sm:text-sm">${trade.stake.toFixed(
            2
          )}</td>
          <td class="p-2 sm:p-3">
            <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold ${
              trade.result === "Win"
                ? "bg-green-600 text-white"
                : "bg-red-600 text-white"
            }">
              ${trade.result}
            </span>
          </td>
          <td class="p-2 sm:p-3 font-bold text-xs sm:text-sm ${
            trade.pnl >= 0 ? "text-green-400" : "text-red-400"
          }">
            ${trade.pnl >= 0 ? "+" : ""}${trade.pnl.toFixed(2)}
          </td>
        </tr>
      `
          )
          .join("");
      }

      function exportCSV() {
        if (tradeHistory.length === 0) {
          showToast("‚ö†Ô∏è No trades to export", "warning");
          return;
        }

        const headers = [
          "Time",
          "Strategy",
          "Type",
          "Signal",
          "Stake",
          "Result",
          "PnL",
        ];
        const rows = tradeHistory.map((t) => [
          t.time,
          t.strategy,
          t.type,
          t.signal,
          t.stake.toFixed(2),
          t.result,
          t.pnl.toFixed(2),
        ]);

        const csv = [headers, ...rows].map((row) => row.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `deriv_trades_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showToast("üì• Trade history exported successfully!", "success");
      }

      // ============= MARKET CHANGE HANDLER =============
      document.getElementById("market").addEventListener("change", () => {
        if (isConnected && ws) {
          const market = document.getElementById("market").value;
          ws.send(JSON.stringify({ forget_all: "ticks" }));
          ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
          priceHistory = [];
          showToast(`üîÑ Switched to ${market}`, "info");
        }
      });

      // ============= REAL-TIME UPDATES =============
      setInterval(() => {
        if (isConnected && priceHistory.length > 0) {
          const currentPrice = priceHistory[priceHistory.length - 1];
          const prevPrice =
            priceHistory[priceHistory.length - 2] || currentPrice;
          const priceChange = ((currentPrice - prevPrice) / prevPrice) * 100;

          const priceEl = document.getElementById("currentPrice");
          if (priceChange > 0) {
            priceEl.className = "text-sm sm:text-lg font-bold text-green-400";
          } else if (priceChange < 0) {
            priceEl.className = "text-sm sm:text-lg font-bold text-red-400";
          } else {
            priceEl.className = "text-sm sm:text-lg font-bold text-blue-400";
          }
        }
      }, 500);

      // ============= KEYBOARD SHORTCUTS =============
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case "s":
              e.preventDefault();
              if (isTrading) stopTrading();
              else startTrading();
              break;
            case "t":
              e.preventDefault();
              singleTrade();
              break;
            case "r":
              e.preventDefault();
              reset();
              break;
          }
        }
      });

      // ============= WARNING BANNER =============
      function showWarningBanner() {
        const banner = document.createElement("div");
        banner.className =
          "fixed bottom-0 left-0 right-0 bg-yellow-600 text-black p-3 text-center text-xs sm:text-sm z-40";
        banner.innerHTML = `
        <strong>‚ö†Ô∏è TRADING WARNING:</strong> Binary options trading carries significant risk. 
        Only trade with funds you can afford to lose. This is for educational purposes only.
        <button onclick="this.parentElement.remove()" class="ml-4 underline">Dismiss</button>
      `;
        document.body.appendChild(banner);
        setTimeout(() => banner.remove(), 15000);
      }

      // ============= INITIALIZE =============
      function initialize() {
        updateUI();
        updateTradeStatus("IDLE");
        updateConnectionStatus(false);
        showWarningBanner();
      }

      initialize();
    </script>
  </body>
</html>