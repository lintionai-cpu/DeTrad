<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Factor Trader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .toast { animation: slideIn 0.3s ease; }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen p-4">
  
  <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm"></div>
  
  <div class="max-w-7xl mx-auto space-y-4">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-4xl font-bold">üöÄ ALL FACTOR TRADER</h1>
          <p class="text-blue-100 mt-1">Advanced Multi-Strategy Deriv Trading System</p>
        </div>
        <div class="flex items-center gap-3 bg-black/30 px-4 py-2 rounded-lg">
          <span id="connDot" class="w-3 h-3 rounded-full bg-red-500"></span>
          <span id="connStatus" class="font-semibold">Disconnected</span>
        </div>
      </div>
      
      <div class="grid grid-cols-4 gap-4">
        <div class="bg-white/10 backdrop-blur rounded-xl p-4">
          <p class="text-xs text-blue-200">Balance</p>
          <p id="balance" class="text-2xl font-bold">$0.00</p>
        </div>
        <div class="bg-white/10 backdrop-blur rounded-xl p-4">
          <p class="text-xs text-purple-200">PnL</p>
          <p id="totalPnL" class="text-2xl font-bold">$0.00</p>
        </div>
        <div class="bg-white/10 backdrop-blur rounded-xl p-4">
          <p class="text-xs text-green-200">Win Rate</p>
          <p id="winRate" class="text-2xl font-bold">0%</p>
        </div>
        <div class="bg-white/10 backdrop-blur rounded-xl p-4">
          <p class="text-xs text-orange-200">Trades</p>
          <p id="totalTrades" class="text-2xl font-bold">0</p>
        </div>
      </div>
      
      <div class="grid grid-cols-5 gap-3 mt-4">
        <div class="bg-black/20 p-3 rounded-lg">
          <p class="text-xs">Price</p>
          <p id="currentPrice" class="text-lg font-bold text-blue-400">-</p>
        </div>
        <div class="bg-black/20 p-3 rounded-lg">
          <p class="text-xs">Signal</p>
          <p id="currentSignal" class="text-lg font-bold text-yellow-400">WAIT</p>
        </div>
        <div class="bg-black/20 p-3 rounded-lg">
          <p class="text-xs">Confidence</p>
          <p id="confidence" class="text-lg font-bold text-green-400">0%</p>
        </div>
        <div class="bg-black/20 p-3 rounded-lg">
          <p class="text-xs">Stake</p>
          <p id="currentStake" class="text-lg font-bold text-purple-400">$0</p>
        </div>
        <div class="bg-black/20 p-3 rounded-lg">
          <p class="text-xs">Regime</p>
          <p id="marketRegime" class="text-lg font-bold text-orange-400">NORM</p>
        </div>
      </div>
    </div>
    
    <!-- Connection -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
      <h2 class="text-xl font-bold mb-4">üîê API Connection</h2>
      <div class="flex gap-3">
        <input type="password" id="apiToken" placeholder="Enter Deriv API Token" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
        <button onclick="connect()" class="bg-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">Connect</button>
        <button onclick="disconnect()" class="bg-red-600 px-6 py-3 rounded-lg font-semibold hover:bg-red-700">Disconnect</button>
      </div>
    </div>
    
    <!-- Configuration -->
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">üìä Market & Strategy</h2>
        <select id="market" class="w-full bg-gray-700 rounded-lg px-4 py-3 mb-3">
          <option value="R_10">Volatility 10</option>
          <option value="R_25">Volatility 25</option>
          <option value="R_50">Volatility 50</option>
          <option value="R_75">Volatility 75</option>
          <option value="R_100">Volatility 100</option>
          <option value="1HZ10V">Vol 10 (1s)</option>
          <option value="1HZ25V">Vol 25 (1s)</option>
          <option value="1HZ50V">Vol 50 (1s)</option>
        </select>
        <select id="strategy" class="w-full bg-gray-700 rounded-lg px-4 py-3">
          <optgroup label="Rise/Fall">
            <option value="tickVelocity">Tick Velocity</option>
            <option value="microStructure">Micro Structure</option>
            <option value="tickImbalance">Tick Imbalance</option>
            <option value="fibonacci">Fibonacci</option>
            <option value="entropy">Entropy</option>
          </optgroup>
          <optgroup label="Digits">
            <option value="markov">Markov Chain</option>
            <option value="benford">Benford Law</option>
            <option value="autocorr">Autocorrelation</option>
            <option value="primeBias">Prime Bias</option>
          </optgroup>
        </select>
      </div>
      
      <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è Risk Management</h2>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Stake ($)</label>
            <input type="number" id="stake" value="1" min="0.35" step="0.1" class="w-full bg-gray-700 rounded px-3 py-2 mt-1">
          </div>
          <div>
            <label class="text-sm">Max Loss ($)</label>
            <input type="number" id="maxLoss" value="50" class="w-full bg-gray-700 rounded px-3 py-2 mt-1">
          </div>
          <div>
            <label class="text-sm">Max Profit ($)</label>
            <input type="number" id="maxProfit" value="100" class="w-full bg-gray-700 rounded px-3 py-2 mt-1">
          </div>
          <div>
            <label class="text-sm">Duration (ticks)</label>
            <input type="number" id="duration" value="5" min="1" class="w-full bg-gray-700 rounded px-3 py-2 mt-1">
          </div>
        </div>
        <label class="flex items-center gap-2 mt-3">
          <input type="checkbox" id="martingale" class="w-5 h-5">
          <span>Enable Martingale (3 steps max)</span>
        </label>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
      <div class="grid grid-cols-4 gap-4">
        <button onclick="startTrading()" id="startBtn" class="bg-green-600 px-6 py-4 rounded-xl font-bold text-lg hover:bg-green-700">
          üöÄ START
        </button>
        <button onclick="stopTrading()" id="stopBtn" disabled class="bg-red-600 px-6 py-4 rounded-xl font-bold text-lg opacity-50">
          ‚õî STOP
        </button>
        <button onclick="singleTrade()" class="bg-blue-600 px-6 py-4 rounded-xl font-bold text-lg hover:bg-blue-700">
          ‚ö° SINGLE
        </button>
        <button onclick="reset()" class="bg-yellow-600 px-6 py-4 rounded-xl font-bold text-lg hover:bg-yellow-700">
          üîÑ RESET
        </button>
      </div>
    </div>
    
    <!-- History -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-bold">üìú Trade History</h2>
        <button onclick="exportCSV()" class="bg-purple-600 px-4 py-2 rounded-lg hover:bg-purple-700">üì• Export</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-700"><tr>
            <th class="p-3 text-left">Time</th>
            <th class="p-3 text-left">Strategy</th>
            <th class="p-3 text-left">Signal</th>
            <th class="p-3 text-left">Stake</th>
            <th class="p-3 text-left">Result</th>
            <th class="p-3 text-left">PnL</th>
          </tr></thead>
          <tbody id="history"><tr><td colspan="6" class="p-8 text-center text-gray-500">No trades yet</td></tr></tbody>
        </table>
      </div>
    </div>
    
  </div>
  
  <script>
    let ws, conn = false, trading = false, processing = false;
    let bal = 0, pnl = 0, trades = 0, wins = 0;
    let stake = 1, mStep = 0;
    let prices = [], digits = [];
    let history = [];
    
    function toast(m, t = 'info') {
      const d = document.createElement('div');
      d.className = `toast px-4 py-3 rounded-lg shadow-2xl ${t === 'success' ? 'bg-green-600' : t === 'error' ? 'bg-red-600' : t === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'}`;
      d.textContent = m;
      document.getElementById('toastContainer').appendChild(d);
      setTimeout(() => d.remove(), 5000);
    }
    
    function updateUI() {
      document.getElementById('balance').textContent = `$${bal.toFixed(2)}`;
      document.getElementById('totalPnL').textContent = `$${pnl.toFixed(2)}`;
      document.getElementById('totalPnL').className = `text-2xl font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
      document.getElementById('winRate').textContent = trades > 0 ? `${((wins/trades)*100).toFixed(1)}%` : '0%';
      document.getElementById('totalTrades').textContent = trades;
      document.getElementById('currentStake').textContent = `$${stake.toFixed(2)}`;
    }
    
    function atr(n = 14) {
      if (prices.length < n + 1) return 0.001;
      let s = 0;
      for (let i = prices.length - n; i < prices.length; i++)
        if (i > 0) s += Math.abs(prices[i] - prices[i-1]);
      return s / n;
    }
    
    function linReg(y) {
      const n = y.length, x = Array.from({length: n}, (_, i) => i);
      const sx = x.reduce((a,b)=>a+b,0), sy = y.reduce((a,b)=>a+b,0);
      const sxy = x.reduce((a,b,i)=>a+b*y[i],0), sx2 = x.reduce((a,b)=>a+b*b,0);
      return {slope: (n*sxy-sx*sy)/(n*sx2-sx*sx)};
    }
    
    function analyzeVelocity() {
      if (prices.length < 11) return null;
      const v = [];
      for (let i = prices.length-10; i < prices.length; i++)
        if (i > 0) v.push(prices[i]-prices[i-1]);
      const a = v.reduce((a,b)=>a+b,0)/v.length;
      const s = linReg(v).slope;
      const m = Math.abs(a);
      if (a > 0.0001 && s > 0) return {sig: 'CALL', conf: Math.min(m*10000,1), prob: 0.55};
      if (a < -0.0001 && s < 0) return {sig: 'PUT', conf: Math.min(m*10000,1), prob: 0.55};
      return null;
    }
    
    function analyzeMicro() {
      if (prices.length < 50) return null;
      const c = {};
      prices.slice(-50).forEach(p => { const k = Math.round(p*10000); c[k] = (c[k]||0)+1; });
      const m = Object.entries(c).filter(([,n])=>n>=10).map(([p,n])=>({p:parseFloat(p)/10000,n}));
      if (!m.length) return null;
      const cp = prices[prices.length-1];
      const n = m.reduce((a,b)=>Math.abs(b.p-cp)<Math.abs(a.p-cp)?b:a);
      const t = atr(14)*1.5;
      if (cp > n.p+t) return {sig:'CALL',conf:0.7,prob:0.6};
      if (cp < n.p-t) return {sig:'PUT',conf:0.7,prob:0.6};
      return null;
    }
    
    function analyzeImbalance() {
      if (prices.length < 50) return null;
      const d = [];
      for (let i = prices.length-49; i < prices.length; i++)
        d.push(prices[i]>prices[i-1]?1:-1);
      const im = d.reduce((a,b)=>a+b,0);
      if (Math.abs(im) > 35) {
        const c = Math.min(Math.abs(im)/50,1);
        return {sig:im>35?'PUT':'CALL',conf:c,prob:0.52+c*0.15};
      }
      return null;
    }
    
    function analyzeFib() {
      if (prices.length < 100) return null;
      const r = prices.slice(-100);
      const h = Math.max(...r), l = Math.min(...r);
      const rng = h-l, cp = prices[prices.length-1];
      const e = (cp-l)/rng;
      if (e > 1.618 && cp < l+rng*2.618) return {sig:'PUT',conf:0.75,prob:0.62};
      if (e < 0.382) return {sig:'CALL',conf:0.7,prob:0.58};
      return null;
    }
    
    function analyzeEntropy() {
      if (prices.length < 100) return null;
      const d = prices.slice(-100).map((p,i,a)=>i>0?(p>a[i-1]?'U':'D'):null).filter(x=>x);
      const ct = {U:0,D:0};
      d.forEach(x=>ct[x]++);
      const t = d.length;
      let e = 0;
      Object.values(ct).forEach(c=>{if(c>0){const p=c/t; e-=p*Math.log2(p);}});
      const n = e/Math.log2(2);
      if (n < 0.5) {
        const up = ct.U/t;
        if (up > 0.7) return {sig:'CALL',conf:1-n,prob:up};
        if (up < 0.3) return {sig:'PUT',conf:1-n,prob:1-up};
      }
      return null;
    }
    
    function analyzeMarkov() {
      if (digits.length < 1000) return null;
      const ch = {};
      for (let i = 1; i < digits.length; i++) {
        const p = digits[i-1], c = digits[i];
        if (!ch[p]) ch[p] = {};
        ch[p][c] = (ch[p][c]||0)+1;
      }
      const l = digits[digits.length-1], tr = ch[l];
      if (!tr) return null;
      const s = Object.entries(tr).sort((a,b)=>b[1]-a[1]);
      const [d,cnt] = s[0];
      const tot = Object.values(tr).reduce((a,b)=>a+b,0);
      if (cnt >= 15) return {sig:'DIGITMATCH',digit:parseInt(d),conf:cnt/tot,prob:cnt/tot};
      return null;
    }
    
    function analyzeBenford() {
      if (digits.length < 500) return null;
      const exp = {0:.1197,1:.1139,2:.1088,3:.1043,4:.1003,5:.0967,6:.0934,7:.0904,8:.0876,9:.0850};
      const ct = {};
      digits.slice(-500).forEach(d=>ct[d]=(ct[d]||0)+1);
      const act = {};
      for (let i = 0; i <= 9; i++) act[i] = (ct[i]||0)/500;
      let md = 0, td = 0;
      for (let i = 0; i <= 9; i++) {
        const dv = act[i]-exp[i];
        if (Math.abs(dv) > Math.abs(md)) {md = dv; td = i;}
      }
      if (Math.abs(md) > 0.02) return {sig:'DIGITDIFF',digit:td,conf:Math.abs(md)*10,prob:0.55};
      return null;
    }
    
    function analyze() {
      if (prices.length < 10) return;
      const st = document.getElementById('strategy').value;
      let r = null;
      if (st === 'tickVelocity') r = analyzeVelocity();
      else if (st === 'microStructure') r = analyzeMicro();
      else if (st === 'tickImbalance') r = analyzeImbalance();
      else if (st === 'fibonacci') r = analyzeFib();
      else if (st === 'entropy') r = analyzeEntropy();
      else if (st === 'markov') r = analyzeMarkov();
      else if (st === 'benford') r = analyzeBenford();
      
      if (r) {
        document.getElementById('currentSignal').textContent = r.sig + (r.digit !== undefined ? ` ${r.digit}` : '');
        document.getElementById('confidence').textContent = `${(r.conf*100).toFixed(0)}%`;
        const reg = prices.length >= 20 && atr(14)/prices[prices.length-1] > 0.015 ? 'HIGH' : 'NORM';
        document.getElementById('marketRegime').textContent = reg;
        
        if (trading && !processing && r.conf > 0.5) trade(r);
      }
    }
    
    function trade(r) {
      if (processing) return;
      processing = true;
      
      const mart = document.getElementById('martingale').checked;
      const baseStake = parseFloat(document.getElementById('stake').value);
      stake = mart && mStep > 0 ? stake : baseStake;
      
      const prop = {
        proposal: 1,
        amount: stake,
        basis: 'stake',
        contract_type: r.sig,
        currency: 'USD',
        duration: parseInt(document.getElementById('duration').value),
        duration_unit: 't',
        symbol: document.getElementById('market').value
      };
      
      if (r.digit !== undefined) prop.barrier = r.digit.toString();
      
      ws.send(JSON.stringify(prop));
    }
    
    function connect() {
      const tok = document.getElementById('apiToken').value.trim();
      if (!tok) return toast('Enter API token', 'error');
      
      ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
      ws.onopen = () => ws.send(JSON.stringify({authorize: tok}));
      ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.error) return toast(d.error.message, 'error');
        
        if (d.msg_type === 'authorize' && d.authorize) {
          conn = true;
          bal = parseFloat(d.authorize.balance);
          document.getElementById('connStatus').textContent = 'Connected';
          document.getElementById('connDot').className = 'w-3 h-3 rounded-full bg-green-500 pulse';
          ws.send(JSON.stringify({ticks: document.getElementById('market').value, subscribe: 1}));
          toast('Connected!', 'success');
          updateUI();
        } else if (d.msg_type === 'tick') {
          const p = parseFloat(d.tick.quote);
          const dg = parseInt(p.toString().slice(-1));
          prices.push(p); if (prices.length > 200) prices.shift();
          digits.push(dg); if (digits.length > 1000) digits.shift();
          document.getElementById('currentPrice').textContent = p.toFixed(5);
          if (prices.length >= 10) analyze();
        } else if (d.msg_type === 'proposal' && d.proposal) {
          ws.send(JSON.stringify({buy: d.proposal.id, price: d.proposal.ask_price}));
        } else if (d.msg_type === 'buy' && d.buy) {
          ws.send(JSON.stringify({proposal_open_contract: 1, contract_id: d.buy.contract_id, subscribe: 1}));
        } else if (d.msg_type === 'proposal_open_contract') {
          const c = d.proposal_open_contract;
          if (c.status === 'sold' || c.is_sold) {
            const pr = parseFloat(c.profit);
            const win = pr > 0;
            pnl += pr;
            trades++;
            if (win) {
              wins++;
              toast(`WIN! +$${pr.toFixed(2)}`, 'success');
              mStep = 0;
              stake = parseFloat(document.getElementById('stake').value);
            } else {
              toast(`LOSS: $${pr.toFixed(2)}`, 'error');
              const mart = document.getElementById('martingale').checked;
              if (mart && mStep < 3) { mStep++; stake *= 2; }
              else { mStep = 0; stake = parseFloat(document.getElementById('stake').value); }
            }
            
            history.unshift({
              time: new Date().toLocaleTimeString(),
              strategy: document.getElementById('strategy').value,
              signal: c.contract_type,
              stake: parseFloat(c.buy_price),
              result: win ? 'Win' : 'Loss',
              pnl: pr
            });
            
            updateHistory();
            updateUI();
            processing = false;
            
            if (Math.abs(pnl) >= parseFloat(document.getElementById('maxLoss').value)) {
              stopTrading();
              toast('Max loss reached!', 'error');
            }
            if (pnl >= parseFloat(document.getElementById('maxProfit').value)) {
              stopTrading();
              toast('Profit target! üéâ', 'success');
            }
          }
        } else if (d.msg_type === 'balance') {
          bal = parseFloat(d.balance.balance);
          updateUI();
        }
      };
      ws.onerror = () => toast('Connection error', 'error');
      ws.onclose = () => { conn = false; trading = false; document.getElementById('connStatus').textContent = 'Disconnected'; document.getElementById('connDot').className = 'w-3 h-3 rounded-full bg-red-500'; };
    }
    
    function disconnect() {
      if (ws) ws.close();
      trading = false;
      toast('Disconnected', 'info');
    }
    
    function startTrading() {
      if (!conn) return toast('Not connected!', 'error');
      if (prices.length < 10) return toast('Waiting for data...', 'warning');
      trading = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      toast('Trading started!', 'success');
    }
    
    function stopTrading() {
      trading = false;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      toast('Trading stopped', 'info');
    }
    
    function singleTrade() {
      if (!conn) return toast('Not connected!', 'error');
      if (prices.length < 10) return toast('Waiting for data...', 'warning');
      if (processing) return toast('Trade in progress...', 'warning');
      analyze();
    }
    
    function reset() {
      if (!confirm('Reset session?')) return;
      pnl = 0; trades = 0; wins = 0; mStep = 0;
      stake = parseFloat(document.getElementById('stake').value);
      prices = []; digits = []; history = [];
      document.getElementById('history').innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">No trades yet</td></tr>';
      updateUI();
      toast('Session reset!', 'success');
    }
    
    function updateHistory() {
      document.getElementById('history').innerHTML = history.slice(0, 50).map(h => 
        `<tr class="hover:bg-gray-700"><td class="p-3">${h.time}</td><td class="p-3 text-xs">${h.strategy}</td><td class="p-3">${h.signal}</td><td class="p-3">$${h.stake.toFixed(2)}</td><td class="p-3"><span class="px-3 py-1 rounded-full text-xs ${h.result==='Win'?'bg-green-600':'bg-red-600'}">${h.result}</span></td><td class="p-3 font-bold ${h.pnl>=0?'text-green-400':'text-red-400'}">${h.pnl>=0?'+':''}${h.pnl.toFixed(2)}</td></tr>`
      ).join('');
    }
    
    function exportCSV() {
      if (!history.length) return toast('No history', 'warning');
      const csv = [['Time','Strategy','Signal','Stake','Result','PnL'], ...history.map(h=>[h.time,h.strategy,h.signal,h.stake.toFixed(2),h.result,h.pnl.toFixed(2)])].map(r=>r.join(',')).join('\n');
      const b = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(b);
      a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      toast('Exported!', 'success');
    }
    
    updateUI();
  </script>
</body>
</html>