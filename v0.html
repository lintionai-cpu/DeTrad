<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuantumFX Pro - Live Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-dark: #0f172a;
        --secondary-dark: #1e293b;
        --accent-blue: #3b82f6;
        --accent-green: #10b981;
        --accent-red: #ef4444;
      }

      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        min-height: 100vh;
      }

      .card-glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .strategy-active {
        box-shadow: 0 0 0 2px var(--accent-green);
        animation: pulse-border 2s infinite;
      }

      @keyframes pulse-border {
        0%,
        100% {
          box-shadow: 0 0 0 2px var(--accent-green);
        }
        50% {
          box-shadow: 0 0 0 4px var(--accent-green);
        }
      }

      .trade-buy {
        border-left: 4px solid var(--accent-green);
      }
      .trade-sell {
        border-left: 4px solid var(--accent-red);
      }
      .market-up {
        color: var(--accent-green);
      }
      .market-down {
        color: var(--accent-red);
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 3px solid var(--accent-blue);
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .pulse-connect {
        animation: pulse-green 2s infinite;
      }

      @keyframes pulse-green {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }

      .indicator-active {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6) !important;
      }

      .toast {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .tab-active {
        border-bottom: 2px solid var(--accent-blue);
        color: white;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(30, 41, 59, 0.5);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--accent-blue);
        border-radius: 4px;
      }

      .price-flash {
        animation: flash 0.3s;
      }

      @keyframes flash {
        0%,
        100% {
          background-color: transparent;
        }
        50% {
          background-color: rgba(59, 130, 246, 0.3);
        }
      }
    </style>
  </head>
  <body>
    <div
      id="authModal"
      class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
    >
      <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 card-glass">
        <div class="text-center mb-6">
          <div
            class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-lock text-2xl"></i>
          </div>
          <h3 class="text-2xl font-bold mb-2">Connect to Deriv</h3>
          <p class="text-gray-400">Enter your API token to start trading</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">API Token</label>
            <input
              type="password"
              id="apiTokenInput"
              class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter your Deriv API token"
            />
          </div>

          <div class="flex items-center space-x-2 text-sm text-gray-400">
            <i class="fas fa-info-circle"></i>
            <span
              >Get token from
              <a
                href="https://app.deriv.com/account/api-token"
                target="_blank"
                class="text-blue-400"
                >Deriv.com</a
              ></span
            >
          </div>

          <button
            onclick="connectLive()"
            class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition"
          >
            <i class="fas fa-plug mr-2"></i>Connect
          </button>
        </div>
      </div>
    </div>

    <header class="sticky top-0 z-50 card-glass shadow-lg">
      <div class="container mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-2">
            <div class="bg-blue-600 p-2 rounded-lg">
              <i class="fas fa-chart-line text-white"></i>
            </div>
            <div>
              <h1 class="text-xl font-bold">
                Quantum<span class="text-blue-400">FX</span>
                <span
                  class="text-xs bg-gradient-to-r from-blue-500 to-purple-500 px-2 py-1 rounded"
                  >PRO</span
                >
              </h1>
              <div class="text-xs" id="connectionStatus">
                <span class="text-red-400">● Disconnected</span>
              </div>
            </div>
          </div>

          <nav class="hidden md:flex space-x-6">
            <a href="#dashboard" class="tab-active font-medium">Dashboard</a>
            <a
              href="#strategies"
              class="text-gray-400 hover:text-white transition"
              >Strategies</a
            >
            <a
              href="#execution"
              class="text-gray-400 hover:text-white transition"
              >Execution</a
            >
          </nav>

          <button
            id="connectBtn"
            onclick="showAuthModal()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium pulse-connect"
          >
            <i class="fas fa-plug mr-2"></i>Connect
          </button>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6">
      <div class="mb-8">
        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"
        >
          <div>
            <h2 class="text-2xl font-bold">Live Trading Dashboard</h2>
            <p class="text-gray-400" id="accountInfo">
              Connect to start trading
            </p>
          </div>
          <div class="mt-4 md:mt-0 flex flex-wrap gap-4">
            <div
              class="bg-green-900/30 border border-green-700 rounded-lg px-4 py-2 min-w-[120px]"
            >
              <div class="text-sm text-gray-300">Balance</div>
              <div class="text-xl font-bold" id="balance">$0.00</div>
            </div>
            <div
              class="bg-blue-900/30 border border-blue-700 rounded-lg px-4 py-2 min-w-[120px]"
            >
              <div class="text-sm text-gray-300">Open P&L</div>
              <div class="text-xl font-bold" id="openPL">$0.00</div>
            </div>
            <div
              class="bg-purple-900/30 border border-purple-700 rounded-lg px-4 py-2 min-w-[120px]"
            >
              <div class="text-sm text-gray-300">Today's P&L</div>
              <div class="text-xl font-bold" id="dailyProfit">$0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <section id="strategies" class="card-glass rounded-xl p-5">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold flex items-center">
                <i class="fas fa-robot mr-2 text-purple-400"></i> Trading
                Strategies
              </h3>
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-400">Auto Trade:</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    id="autoTradeToggle"
                    class="sr-only peer"
                  />
                  <div
                    class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"
                  ></div>
                </label>
              </div>
            </div>

            <div
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
              id="strategyContainer"
            ></div>
          </section>

          <section class="card-glass rounded-xl p-5">
            <h3 class="text-xl font-bold mb-6 flex items-center">
              <i class="fas fa-chart-bar mr-2 text-yellow-400"></i> Technical
              Indicators
            </h3>
            <div
              class="grid grid-cols-2 md:grid-cols-4 gap-4"
              id="indicatorsContainer"
            ></div>
          </section>
        </div>

        <div class="space-y-6">
          <section id="execution" class="card-glass rounded-xl p-5">
            <h3 class="text-xl font-bold mb-6 flex items-center">
              <i class="fas fa-play-circle mr-2 text-green-400"></i> Trade
              Execution
            </h3>

            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-2">Market</label>
                <select
                  id="marketSelect"
                  class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3"
                >
                  <option value="">Loading...</option>
                </select>
              </div>

              <div>
                <label class="block text-sm text-gray-300 mb-2"
                  >Current Price</label
                >
                <div
                  class="bg-gray-800 border border-gray-700 rounded px-4 py-3 text-xl font-bold"
                  id="currentPrice"
                >
                  --
                </div>
              </div>

              <div>
                <label class="block text-sm text-gray-300 mb-2"
                  >Amount ($)</label
                >
                <input
                  type="number"
                  id="tradeAmount"
                  value="10"
                  class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3"
                  min="1"
                  step="0.01"
                />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-2"
                    >Duration</label
                  >
                  <input
                    type="number"
                    id="tradeDuration"
                    value="5"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3"
                    min="1"
                  />
                </div>
                <div>
                  <label class="block text-sm text-gray-300 mb-2">Unit</label>
                  <select
                    id="durationUnit"
                    class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3"
                  >
                    <option value="t">Ticks</option>
                    <option value="s">Seconds</option>
                    <option value="m">Minutes</option>
                  </select>
                </div>
              </div>

              <div class="pt-4">
                <div class="grid grid-cols-2 gap-3">
                  <button
                    id="higherButton"
                    class="bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold transition"
                  >
                    <i class="fas fa-arrow-up mr-2"></i> CALL
                  </button>
                  <button
                    id="lowerButton"
                    class="bg-red-600 hover:bg-red-700 py-3 rounded-lg font-bold transition"
                  >
                    <i class="fas fa-arrow-down mr-2"></i> PUT
                  </button>
                </div>
              </div>

              <div
                class="flex justify-between mt-4 pt-4 border-t border-gray-700"
              >
                <button
                  onclick="setAmount(5)"
                  class="px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm"
                >
                  $5
                </button>
                <button
                  onclick="setAmount(10)"
                  class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm"
                >
                  $10
                </button>
                <button
                  onclick="setAmount(25)"
                  class="px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm"
                >
                  $25
                </button>
                <button
                  onclick="setAmount(50)"
                  class="px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm"
                >
                  $50
                </button>
              </div>
            </div>
          </section>

          <section class="card-glass rounded-xl p-5">
            <h3 class="text-xl font-bold mb-6 flex items-center">
              <i class="fas fa-history mr-2 text-blue-400"></i> Recent Trades
            </h3>
            <div class="space-y-3 max-h-80 overflow-y-auto" id="recentTrades">
              <div class="text-center text-gray-500 py-8">No trades yet</div>
            </div>
          </section>
        </div>
      </div>
    </main>

    <script>
      let api,
        strategyEngine,
        autoTrade = false;

      class DerivAPI {
        constructor() {
          this.ws = null;
          this.connected = false;
          this.account = null;
          this.callbacks = new Map();
          this.reqId = 1;
          this.symbols = [];
          this.ticks = new Map();
        }

        connect(token) {
          return new Promise((resolve, reject) => {
            this.ws = new WebSocket(
              "wss://ws.derivws.com/websockets/v3?app_id=1089"
            );

            this.ws.onopen = () => {
              this.connected = true;
              this.updateStatus(true);
              if (token) {
                this.authorize(token).then(resolve).catch(reject);
              } else {
                this.loadSymbols();
                resolve();
              }
            };

            this.ws.onmessage = (msg) => {
              const data = JSON.parse(msg.data);
              this.handleMessage(data);
            };

            this.ws.onerror = () => this.updateStatus(false);
            this.ws.onclose = () => {
              this.connected = false;
              this.updateStatus(false);
            };
          });
        }

        send(req) {
          return new Promise((resolve, reject) => {
            if (!this.connected) {
              reject(new Error("Not connected"));
              return;
            }
            const id = this.reqId++;
            req.req_id = id;
            this.callbacks.set(id, { resolve, reject });
            this.ws.send(JSON.stringify(req));
            setTimeout(() => {
              if (this.callbacks.has(id)) {
                this.callbacks.delete(id);
                reject(new Error("Timeout"));
              }
            }, 30000);
          });
        }

        handleMessage(data) {
          const id = data.req_id;
          if (id && this.callbacks.has(id)) {
            const { resolve, reject } = this.callbacks.get(id);
            this.callbacks.delete(id);
            data.error ? reject(data.error) : resolve(data);
          } else {
            this.handleSub(data);
          }
        }

        async authorize(token) {
          const res = await this.send({ authorize: token });
          if (res.authorize) {
            this.account = res.authorize;
            localStorage.setItem("deriv_token", token);
            this.updateAccount();
            this.loadSymbols();
            this.send({ balance: 1, subscribe: 1 });
            this.send({ transaction: 1, subscribe: 1 });
            showNotification(`Connected as ${this.account.email}`, "success");
            document.getElementById("authModal").classList.add("hidden");
          }
        }

        async loadSymbols() {
          const res = await this.send({
            active_symbols: "brief",
            product_type: "basic",
          });
          if (res.active_symbols) {
            this.symbols = res.active_symbols.filter(
              (s) => s.market === "forex" || s.market === "synthetic_index"
            );
            this.populateMarkets();
          }
        }

        populateMarkets() {
          const sel = document.getElementById("marketSelect");
          sel.innerHTML = '<optgroup label="Synthetics">';
          this.symbols
            .filter((s) => s.market === "synthetic_index")
            .forEach((s) => {
              sel.innerHTML += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
          sel.innerHTML += '</optgroup><optgroup label="Forex">';
          this.symbols
            .filter((s) => s.market === "forex")
            .slice(0, 20)
            .forEach((s) => {
              sel.innerHTML += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
          sel.innerHTML += "</optgroup>";
          if (this.symbols.length) {
            sel.value = this.symbols[0].symbol;
            this.subscribeToTicks(this.symbols[0].symbol);
          }
        }

        async subscribeToTicks(symbol) {
          await this.send({ ticks: symbol, subscribe: 1 });
        }

        handleSub(data) {
          if (data.tick) {
            const { symbol, quote, epoch } = data.tick;
            const price = parseFloat(quote);
            if (!this.ticks.has(symbol)) this.ticks.set(symbol, []);
            this.ticks.get(symbol).push({ price, time: epoch * 1000 });
            if (this.ticks.get(symbol).length > 100)
              this.ticks.get(symbol).shift();

            if (symbol === document.getElementById("marketSelect").value) {
              this.updatePrice(price);
            }
            strategyEngine?.processTick(symbol, data.tick);
          }

          if (data.balance && this.account) {
            this.account.balance = data.balance.balance;
            this.updateAccount();
          }

          if (data.transaction) {
            const { action, amount } = data.transaction;
            if (action === "buy") {
              showNotification("Trade placed", "success");
            } else if (action === "sell") {
              const profit = parseFloat(amount);
              showNotification(
                profit > 0
                  ? `Won $${profit.toFixed(2)}`
                  : `Lost $${Math.abs(profit).toFixed(2)}`,
                profit > 0 ? "success" : "error"
              );
            }
          }

          if (data.proposal_open_contract) {
            console.log("Contract update:", data.proposal_open_contract);
          }
        }

        async placeTrade(params) {
          const prop = await this.send({
            proposal: 1,
            amount: parseFloat(params.amount),
            basis: "stake",
            contract_type: params.type,
            currency: "USD",
            duration: parseInt(params.duration),
            duration_unit: params.unit,
            symbol: params.symbol,
          });

          if (prop.proposal) {
            const buy = await this.send({
              buy: prop.proposal.id,
              price: parseFloat(params.amount),
            });

            if (buy.buy) {
              this.addTrade({
                id: buy.buy.contract_id,
                symbol: params.symbol,
                type: params.type,
                amount: params.amount,
                time: Date.now(),
              });

              await this.send({
                proposal_open_contract: 1,
                contract_id: buy.buy.contract_id,
                subscribe: 1,
              });

              return buy;
            }
          }
        }

        updatePrice(price) {
          const el = document.getElementById("currentPrice");
          el.textContent = price.toFixed(5);
          el.classList.add("price-flash");
          setTimeout(() => el.classList.remove("price-flash"), 300);
        }

        updateAccount() {
          if (!this.account) return;
          document.getElementById("balance").textContent = `$${parseFloat(
            this.account.balance
          ).toFixed(2)}`;
          document.getElementById(
            "accountInfo"
          ).textContent = `${this.account.email} • ${this.account.currency}`;
        }

        updateStatus(connected) {
          const status = document.getElementById("connectionStatus");
          const btn = document.getElementById("connectBtn");
          if (connected) {
            status.innerHTML =
              '<span class="text-green-400">● Connected</span>';
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Connected';
            btn.className =
              "px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium";
          } else {
            status.innerHTML =
              '<span class="text-red-400">● Disconnected</span>';
            btn.innerHTML = '<i class="fas fa-plug mr-2"></i>Connect';
            btn.className =
              "px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium pulse-connect";
          }
        }

        addTrade(trade) {
          const container = document.getElementById("recentTrades");
          if (container.querySelector(".text-gray-500"))
            container.innerHTML = "";

          const div = document.createElement("div");
          div.className = `${
            trade.type === "CALL" ? "trade-buy" : "trade-sell"
          } p-3 rounded-lg bg-gray-800/30`;
          div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold">${trade.type} ${
            trade.symbol
          }</div>
                            <div class="text-xs text-gray-400">${new Date(
                              trade.time
                            ).toLocaleTimeString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">$${trade.amount}</div>
                            <div class="text-xs text-gray-400">Open</div>
                        </div>
                    </div>
                `;
          container.insertBefore(div, container.firstChild);
          if (container.children.length > 10)
            container.removeChild(container.lastChild);
        }
      }

      class TechnicalIndicators {
        static RSI(prices, period = 14) {
          if (prices.length < period + 1) return 50;
          let gains = 0,
            losses = 0;
          for (let i = 1; i <= period; i++) {
            const change =
              prices[prices.length - i] - prices[prices.length - i - 1];
            change > 0 ? (gains += change) : (losses -= change);
          }
          const avgGain = gains / period;
          const avgLoss = losses / period;
          return avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
        }

        static MACD(prices) {
          const ema12 = this.EMA(prices, 12);
          const ema26 = this.EMA(prices, 26);
          return ema12 - ema26;
        }

        static EMA(prices, period) {
          const k = 2 / (period + 1);
          let ema = prices[0];
          for (let i = 1; i < prices.length; i++) {
            ema = prices[i] * k + ema * (1 - k);
          }
          return ema;
        }

        static BollingerBands(prices, period = 20, std = 2) {
          if (prices.length < period) return null;
          const slice = prices.slice(-period);
          const mean = slice.reduce((a, b) => a + b) / period;
          const variance =
            slice.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / period;
          const stdDev = Math.sqrt(variance);
          return {
            upper: mean + stdDev * std,
            middle: mean,
            lower: mean - stdDev * std,
          };
        }

        static ATR(prices, period = 14) {
          if (prices.length < 2) return 0;
          let totalRange = 0;
          for (
            let i = prices.length - 1;
            i > Math.max(0, prices.length - period - 1);
            i--
          ) {
            totalRange += Math.abs(prices[i] - prices[i - 1]);
          }
          return totalRange / Math.min(period, prices.length - 1);
        }
      }

      class StrategyEngine {
        constructor(api) {
          this.api = api;
          this.strategies = {
            rsi_reversal: {
              name: "RSI Reversal",
              active: false,
              trades: 0,
              wins: 0,
            },
            macd_cross: {
              name: "MACD Cross",
              active: false,
              trades: 0,
              wins: 0,
            },
            bollinger: {
              name: "Bollinger Bands",
              active: false,
              trades: 0,
              wins: 0,
            },
            momentum: { name: "Momentum", active: false, trades: 0, wins: 0 },
          };
          this.lastTrade = 0;
        }

        processTick(symbol, tick) {
          if (!autoTrade || Date.now() - this.lastTrade < 30000) return;

          const ticks = this.api.ticks.get(symbol);
          if (!ticks || ticks.length < 30) return;

          const prices = ticks.map((t) => t.price);
          this.checkStrategies(symbol, prices);
        }

        checkStrategies(symbol, prices) {
          Object.entries(this.strategies).forEach(([id, strat]) => {
            if (!strat.active) return;

            let signal = null;

            if (id === "rsi_reversal") {
              const rsi = TechnicalIndicators.RSI(prices);
              if (rsi < 30) signal = "CALL";
              else if (rsi > 70) signal = "PUT";
            } else if (id === "macd_cross") {
              const macd = TechnicalIndicators.MACD(prices);
              if (macd > 0) signal = "CALL";
              else if (macd < 0) signal = "PUT";
            } else if (id === "bollinger") {
              const bb = TechnicalIndicators.BollingerBands(prices);
              if (bb && prices[prices.length - 1] < bb.lower) signal = "CALL";
              else if (bb && prices[prices.length - 1] > bb.upper)
                signal = "PUT";
            }

            if (signal) {
              this.executeTrade(symbol, signal);
              this.lastTrade = Date.now();
            }
          });
        }

        async executeTrade(symbol, type) {
          try {
            await this.api.placeTrade({
              symbol,
              type,
              amount: 10,
              duration: 5,
              unit: "t",
            });
          } catch (e) {
            console.error("Auto trade failed:", e);
          }
        }

        toggleStrategy(id) {
          this.strategies[id].active = !this.strategies[id].active;
          updateStrategyUI(id, this.strategies[id]);
        }
      }

      function initApp() {
        api = new DerivAPI();
        strategyEngine = new StrategyEngine(api);

        populateStrategies();
        populateIndicators();
        setupEventListeners();

        const savedToken = localStorage.getItem("deriv_token");
        if (savedToken) {
          setTimeout(
            () => api.connect(savedToken).catch(() => showAuthModal()),
            1000
          );
        } else {
          showAuthModal();
        }
      }

      function populateStrategies() {
        const container = document.getElementById("strategyContainer");
        Object.entries(strategyEngine.strategies).forEach(([id, strat]) => {
          const div = document.createElement("div");
          div.className =
            "bg-gray-800/50 rounded-lg p-4 border border-gray-700 cursor-pointer hover:bg-gray-800/70 transition";
          div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold">${strat.name}</h4>
                            <span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">Paused</span>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold">0%</div>
                            <div class="text-xs text-gray-400">Win Rate</div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span><i class="fas fa-bolt text-yellow-500 mr-1"></i> Trades: ${strat.trades}</span>
                        <span><i class="fas fa-check-circle text-green-400 mr-1"></i> Wins: ${strat.wins}</span>
                    </div>
                `;
          div.onclick = () => strategyEngine.toggleStrategy(id);
          div.dataset.strategyId = id;
          container.appendChild(div);
        });
      }

      function updateStrategyUI(id, strat) {
        const card = document.querySelector(`[data-strategy-id="${id}"]`);
        if (!card) return;

        const statusSpan = card.querySelector("span");
        if (strat.active) {
          card.classList.add("strategy-active");
          statusSpan.className =
            "text-xs bg-green-900 text-green-300 px-2 py-1 rounded";
          statusSpan.textContent = "Active";
          showNotification(`${strat.name} activated`, "success");
        } else {
          card.classList.remove("strategy-active");
          statusSpan.className =
            "text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded";
          statusSpan.textContent = "Paused";
          showNotification(`${strat.name} paused`, "warning");
        }
      }

      function populateIndicators() {
        const indicators = [
          { id: "rsi", name: "RSI", value: "--", color: "blue" },
          { id: "macd", name: "MACD", value: "--", color: "green" },
          { id: "bb", name: "Bollinger", value: "--", color: "yellow" },
          { id: "atr", name: "ATR", value: "--", color: "purple" },
        ];

        const container = document.getElementById("indicatorsContainer");
        indicators.forEach((ind) => {
          const div = document.createElement("div");
          div.className = "bg-gray-800/50 rounded p-3";
          div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">${ind.name}</span>
                        <span class="text-xs px-2 py-1 rounded bg-${ind.color}-900/50">${ind.value}</span>
                    </div>
                    <div class="text-lg font-bold">--</div>
                `;
          container.appendChild(div);
        });

        setInterval(() => updateIndicators(), 2000);
      }

      function updateIndicators() {
        if (!api?.connected) return;

        const symbol = document.getElementById("marketSelect").value;
        const ticks = api.ticks.get(symbol);

        if (!ticks || ticks.length < 20) return;

        const prices = ticks.map((t) => t.price);
        const container = document.getElementById("indicatorsContainer");

        const rsi = TechnicalIndicators.RSI(prices);
        const rsiDiv = container.children[0];
        rsiDiv.querySelector(".text-lg").textContent = rsi.toFixed(1);
        rsiDiv.querySelector("span:last-child").textContent =
          rsi < 30 ? "Oversold" : rsi > 70 ? "Overbought" : "Neutral";

        const macd = TechnicalIndicators.MACD(prices);
        const macdDiv = container.children[1];
        macdDiv.querySelector(".text-lg").textContent = macd.toFixed(5);
        macdDiv.querySelector("span:last-child").textContent =
          macd > 0 ? "Bullish" : "Bearish";

        const bb = TechnicalIndicators.BollingerBands(prices);
        if (bb) {
          const bbDiv = container.children[2];
          const pos =
            prices[prices.length - 1] > bb.upper
              ? "Upper"
              : prices[prices.length - 1] < bb.lower
              ? "Lower"
              : "Middle";
          bbDiv.querySelector(".text-lg").textContent = pos;
          bbDiv.querySelector("span:last-child").textContent =
            bb.middle.toFixed(5);
        }

        const atr = TechnicalIndicators.ATR(prices);
        const atrDiv = container.children[3];
        atrDiv.querySelector(".text-lg").textContent = atr.toFixed(5);
        atrDiv.querySelector("span:last-child").textContent =
          atr > 0.01 ? "High" : "Low";
      }

      function setupEventListeners() {
        document.getElementById("autoTradeToggle").onchange = (e) => {
          autoTrade = e.target.checked;
          showNotification(
            `Auto trading ${autoTrade ? "enabled" : "disabled"}`,
            autoTrade ? "success" : "warning"
          );
        };

        document.getElementById("higherButton").onclick = () =>
          placeTrade("CALL");
        document.getElementById("lowerButton").onclick = () =>
          placeTrade("PUT");

        document.getElementById("marketSelect").onchange = (e) => {
          api.subscribeToTicks(e.target.value);
        };
      }

      async function placeTrade(type) {
        if (!api?.connected) {
          showNotification("Connect to Deriv first", "error");
          return;
        }

        const symbol = document.getElementById("marketSelect").value;
        const amount = document.getElementById("tradeAmount").value;
        const duration = document.getElementById("tradeDuration").value;
        const unit = document.getElementById("durationUnit").value;

        try {
          await api.placeTrade({ symbol, type, amount, duration, unit });
        } catch (e) {
          showNotification(e.message || "Trade failed", "error");
        }
      }

      function setAmount(amt) {
        document.getElementById("tradeAmount").value = amt;
      }

      function showAuthModal() {
        document.getElementById("authModal").classList.remove("hidden");
      }

      async function connectLive() {
        const token = document.getElementById("apiTokenInput").value.trim();
        if (!token) {
          showNotification("Enter API token", "warning");
          return;
        }

        try {
          await api.connect(token);
        } catch (e) {
          showNotification(e.message || "Connection failed", "error");
        }
      }

      function showNotification(msg, type = "info") {
        const colors = {
          success: "bg-green-900 text-green-300 border-green-700",
          error: "bg-red-900 text-red-300 border-red-700",
          warning: "bg-yellow-900 text-yellow-300 border-yellow-700",
          info: "bg-blue-900 text-blue-300 border-blue-700",
        };

        const icons = {
          success: "check-circle",
          error: "exclamation-circle",
          warning: "exclamation-triangle",
          info: "info-circle",
        };

        const toast = document.createElement("div");
        toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 toast ${colors[type]} border`;
        toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icons[type]} mr-2"></i>
                    <span>${msg}</span>
                </div>
            `;

        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      window.onload = initApp;
    </script>
  </body>
</html>
