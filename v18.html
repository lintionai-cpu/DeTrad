<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumFX Pro - Advanced Trading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.4);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-disconnected {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .trade-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .trade-card.buy { border-left-color: var(--success); }
        .trade-card.sell { border-left-color: var(--danger); }

        .strategy-active {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .modal-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .toast {
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { 
            background: var(--primary); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }

        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-70 modal-overlay flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                    <i class="fas fa-chart-line text-3xl text-white"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                    Connect to Deriv
                </h2>
                <p class="text-gray-400">Enter your API token to start trading</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">API Token</label>
                    <input 
                        type="password" 
                        id="apiTokenInput" 
                        class="w-full input-field rounded-lg px-4 py-3 text-white"
                        placeholder="Enter your Deriv API token"
                    >
                </div>
                
                <div class="flex items-start space-x-2 text-sm text-gray-400 bg-blue-900/20 p-3 rounded-lg border border-blue-800/30">
                    <i class="fas fa-info-circle mt-0.5"></i>
                    <div>
                        <p>Get your API token from <a href="https://app.deriv.com/account/api-token" target="_blank" class="text-blue-400 hover:text-blue-300 underline">Deriv Dashboard</a></p>
                        <p class="text-xs mt-1">Make sure to enable trading permissions</p>
                    </div>
                </div>
                
                <button onclick="connectToAPI()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                    <i class="fas fa-plug mr-2"></i>Connect Platform
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="glass-card rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-cog mr-3 text-indigo-400"></i>
                    Strategy Configuration
                </h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="strategySettings"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-40 glass-card shadow-2xl">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">
                            Quantum<span class="bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">FX</span>
                            <span class="text-xs bg-gradient-to-r from-indigo-500 to-purple-500 px-2 py-1 rounded-full ml-2">PRO</span>
                        </h1>
                        <div class="text-xs flex items-center" id="connectionStatus">
                            <span class="status-dot status-disconnected mr-2"></span>
                            <span class="text-gray-400">Disconnected</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden md:block">
                        <div class="text-sm text-gray-400">Account Balance</div>
                        <div class="text-xl font-bold text-white" id="headerBalance">$0.00</div>
                    </div>
                    <button id="connectBtn" onclick="showAuthModal()" class="btn-primary px-6 py-2 rounded-lg font-semibold text-white">
                        <i class="fas fa-plug mr-2"></i>Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Account Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card rounded-xl p-5 metric-card">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-gray-400">Balance</div>
                    <i class="fas fa-wallet text-indigo-400"></i>
                </div>
                <div class="text-3xl font-bold text-white" id="balance">$0.00</div>
            </div>
            
            <div class="glass-card rounded-xl p-5 metric-card">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-gray-400">Today's P&L</div>
                    <i class="fas fa-chart-line text-green-400"></i>
                </div>
                <div class="text-3xl font-bold" id="dailyPL">$0.00</div>
            </div>
            
            <div class="glass-card rounded-xl p-5 metric-card">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-gray-400">Total Trades</div>
                    <i class="fas fa-exchange-alt text-blue-400"></i>
                </div>
                <div class="text-3xl font-bold text-white" id="totalTrades">0</div>
            </div>
            
            <div class="glass-card rounded-xl p-5 metric-card">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-gray-400">Win Rate</div>
                    <i class="fas fa-trophy text-yellow-400"></i>
                </div>
                <div class="text-3xl font-bold text-white" id="winRate">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - Trading Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Trading Parameters -->
                <section class="glass-card rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-sliders-h mr-3 text-indigo-400"></i>
                        Trading Parameters
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Market Symbol</label>
                            <select id="symbolSelect" class="w-full input-field rounded-lg px-4 py-3 text-white">
                                <option value="">Loading markets...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Timeframe</label>
                            <select id="timeframeSelect" class="w-full input-field rounded-lg px-4 py-3 text-white">
                                <option value="60">1 Minute</option>
                                <option value="180">3 Minutes</option>
                                <option value="300">5 Minutes</option>
                                <option value="900">15 Minutes</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Initial Stake ($)</label>
                            <input type="number" id="initialStake" value="1.00" min="0.35" step="0.01" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Target Profit ($)</label>
                            <input type="number" id="targetProfit" value="10.00" min="1" step="1" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Trade Duration</label>
                            <input type="number" id="tradeDuration" value="1" min="1" max="10" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Duration Unit</label>
                            <select id="durationUnit" class="w-full input-field rounded-lg px-4 py-3 text-white">
                                <option value="t">Ticks</option>
                                <option value="m">Minutes</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Risk Management -->
                <section class="glass-card rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-shield-alt mr-3 text-yellow-400"></i>
                        Risk Management
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-2 flex items-center justify-between p-4 bg-gray-900/40 rounded-lg">
                            <div>
                                <div class="font-semibold text-white">Martingale System</div>
                                <div class="text-sm text-gray-400">Automatically increase stake after losses</div>
                            </div>
                            <div class="toggle-switch" id="martingaleToggle" onclick="toggleMartingale()"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Martingale Multiplier</label>
                            <input type="number" id="martingaleMultiplier" value="2.0" min="1.5" max="3" step="0.1" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Consecutive Runs</label>
                            <input type="number" id="maxRuns" value="5" min="1" max="10" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Max Loss Stop ($)</label>
                            <input type="number" id="maxLoss" value="50.00" min="10" step="5" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Daily Profit Limit ($)</label>
                            <input type="number" id="dailyProfitLimit" value="100.00" min="10" step="10" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                    </div>
                </section>

                <!-- Trading Strategies -->
                <section class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center">
                            <i class="fas fa-robot mr-3 text-purple-400"></i>
                            Trading Strategies
                        </h3>
                        <button id="startTradingBtn" onclick="toggleTrading()" 
                                class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition transform hover:scale-105">
                            <i class="fas fa-play mr-2"></i>Start Trading
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="strategyContainer"></div>
                </section>

                <!-- Live Chart -->
                <section class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold flex items-center">
                            <i class="fas fa-chart-area mr-3 text-blue-400"></i>
                            Live Market Chart
                        </h3>
                        <button onclick="resetChart()" class="text-sm px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                            <i class="fas fa-redo mr-2"></i>Reset
                        </button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="tradingChart"></canvas>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-3 gap-3">
                        <div class="bg-gray-900/40 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-400 mb-1">Current Price</div>
                            <div class="text-lg font-bold text-white" id="currentPrice">--</div>
                        </div>
                        <div class="bg-gray-900/40 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-400 mb-1">EMA Status</div>
                            <div class="text-lg font-bold" id="emaStatus">--</div>
                        </div>
                        <div class="bg-gray-900/40 rounded-lg p-3 text-center">
                            <div class="text-xs text-gray-400 mb-1">Trend</div>
                            <div class="text-lg font-bold" id="trendIndicator">--</div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Panel -->
            <div class="space-y-6">
                <!-- Active Trades -->
                <section class="glass-card rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-3 text-yellow-400"></i>
                        Active Trades
                    </h3>
                    <div id="activeTradesContainer" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                            <p>No active trades</p>
                        </div>
                    </div>
                </section>

                <!-- Trade History -->
                <section class="glass-card rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-3 text-blue-400"></i>
                        Recent Trades
                    </h3>
                    <div id="tradeHistoryContainer" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-clock text-4xl mb-2 opacity-50"></i>
                            <p>No trades yet</p>
                        </div>
                    </div>
                </section>

                <!-- Performance Stats -->
                <section class="glass-card rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-purple-400"></i>
                        Performance
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-900/40 rounded-lg">
                            <span class="text-gray-400">Wins</span>
                            <span class="font-bold text-green-400 text-lg" id="totalWins">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-900/40 rounded-lg">
                            <span class="text-gray-400">Losses</span>
                            <span class="font-bold text-red-400 text-lg" id="totalLosses">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-900/40 rounded-lg">
                            <span class="text-gray-400">Profit Factor</span>
                            <span class="font-bold text-white text-lg" id="profitFactor">0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-900/40 rounded-lg">
                            <span class="text-gray-400">Average Win</span>
                            <span class="font-bold text-white text-lg" id="avgWin">$0.00</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // State Management
        const state = {
            ws: null,
            isConnected: false,
            isTrading: false,
            currentSymbol: null,
            currentTimeframe: 60,
            candles: [],
            activeContracts: new Map(),
            tradeHistory: [],
            accountBalance: 0,
            dailyProfit: 0,
            totalWins: 0,
            totalLosses: 0,
            currentRun: 0,
            martingaleEnabled: false,
            currentStake: 1,
            chart: null,
            strategies: {
                ema_cross: {
                    name: 'EMA Crossover + Confirmation',
                    active: false,
                    params: { fastPeriod: 12, slowPeriod: 50, confirmCandle: true }
                },
                sma_cross: {
                    name: 'SMA Crossover + Confirmation',
                    active: false,
                    params: { fastPeriod: 12, slowPeriod: 50, confirmCandle: true }
                },
                macd_ma: {
                    name: 'MACD + Moving Average',
                    active: false,
                    params: { macdFast: 12, macdSlow: 26, macdSignal: 9, maPeriod: 2, confirmCandle: true }
                }
            }
        };

        // WebSocket Functions
        function connectToAPI() {
            const token = document.getElementById('apiTokenInput').value.trim();
            if (!token) {
                showToast('Please enter your API token', 'error');
                return;
            }

            try {
                state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
                
                state.ws.onopen = () => {
                    sendMessage({ authorize: token });
                };

                state.ws.onmessage = (msg) => {
                    try {
                        const data = JSON.parse(msg.data);
                        handleMessage(data);
                    } catch (error) {
                        console.error('Message parse error:', error);
                    }
                };

                state.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showToast('Connection error. Please check your internet.', 'error');
                    updateConnectionStatus(false);
                };

                state.ws.onclose = () => {
                    state.isConnected = false;
                    updateConnectionStatus(false);
                    if (state.isTrading) {
                        showToast('Connection lost. Reconnecting...', 'warning');
                        setTimeout(connectToAPI, 5000);
                    }
                };
            } catch (error) {
                console.error('Connection error:', error);
                showToast('Failed to connect. Please try again.', 'error');
            }
        }

        function sendMessage(msg) {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify(msg));
            } else {
                console.error('WebSocket not connected');
            }
        }

        function handleMessage(data) {
            try {
                if (data.error) {
                    showToast(data.error.message, 'error');
                    return;
                }

                if (data.authorize) {
                    state.isConnected = true;
                    state.accountBalance = parseFloat(data.authorize.balance) || 0;
                    updateConnectionStatus(true);
                    updateAccountInfo();
                    loadMarkets();
                    document.getElementById('authModal').classList.add('hidden');
                    showToast('Connected successfully!', 'success');
                    sendMessage({ balance: 1, subscribe: 1 });
                }

                if (data.active_symbols) {
                    populateMarkets(data.active_symbols);
                }

                if (data.candles) {
                    processCandles(data.candles);
                }

                if (data.ohlc) {
                    updateCandle(data.ohlc);
                }

                if (data.balance) {
                    state.accountBalance = parseFloat(data.balance.balance) || 0;
                    updateAccountInfo();
                }

                if (data.proposal_open_contract && data.proposal_open_contract.contract_id) {
                    updateContract(data.proposal_open_contract);
                }

                if (data.buy) {
                    handleTradeOpened(data.buy);
                }

                if (data.proposal && data.proposal.id) {
                    executeBuy(data.proposal);
                }
            } catch (error) {
                console.error('Handle message error:', error);
            }
        }

        // Market Functions
        function loadMarkets() {
            sendMessage({ active_symbols: 'brief', product_type: 'basic' });
        }

        function populateMarkets(symbols) {
            const select = document.getElementById('symbolSelect');
            let html = '<optgroup label="Volatility Indices">';
            
            symbols.filter(s => s.market === 'synthetic_index').forEach(s => {
                html += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
            
            html += '</optgroup><optgroup label="Forex">';
            
            symbols.filter(s => s.market === 'forex').slice(0, 20).forEach(s => {
                html += `<option value="${s.symbol}">${s.display_name}</option>`;
            });
            
            html += '</optgroup>';
            select.innerHTML = html;
            
            if (symbols.length > 0) {
                state.currentSymbol = symbols[0].symbol;
                subscribeToCandles();
            }
        }

        function subscribeToCandles() {
            if (!state.currentSymbol) return;
            
            sendMessage({
                ticks_history: state.currentSymbol,
                adjust_start_time: 1,
                count: 100,
                end: 'latest',
                start: 1,
                style: 'candles',
                granularity: state.currentTimeframe
            });

            sendMessage({
                ticks_history: state.currentSymbol,
                adjust_start_time: 1,
                count: 1,
                end: 'latest',
                start: 1,
                style: 'candles',
                granularity: state.currentTimeframe,
                subscribe: 1
            });
        }

        function processCandles(data) {
            state.candles = data.map(c => ({
                time: c.epoch * 1000,
                open: parseFloat(c.open),
                high: parseFloat(c.high),
                low: parseFloat(c.low),
                close: parseFloat(c.close)
            }));
            
            if (state.candles.length > 0) {
                updateMarketData();
                updateChart();
                if (state.isTrading) analyzeMarket();
            }
        }

        function updateCandle(ohlc) {
            const newCandle = {
                time: ohlc.epoch * 1000,
                open: parseFloat(ohlc.open),
                high: parseFloat(ohlc.high),
                low: parseFloat(ohlc.low),
                close: parseFloat(ohlc.close)
            };

            if (state.candles.length > 0 && state.candles[state.candles.length - 1].time === newCandle.time) {
                state.candles[state.candles.length - 1] = newCandle;
            } else {
                state.candles.push(newCandle);
                if (state.candles.length > 100) state.candles.shift();
                if (state.isTrading) analyzeMarket();
            }

            updateMarketData();
            updateChart();
        }

        // Technical Analysis
        function calculateEMA(data, period) {
            if (data.length < period) return data[data.length - 1];
            const k = 2 / (period + 1);
            let ema = data[0];
            for (let i = 1; i < data.length; i++) {
                ema = data[i] * k + ema * (1 - k);
            }
            return ema;
        }

        function calculateSMA(data, period) {
            if (data.length < period) return data[data.length - 1];
            const slice = data.slice(-period);
            return slice.reduce((a, b) => a + b, 0) / period;
        }

        function calculateMACD(data) {
            const emaFast = calculateEMA(data, 12);
            const emaSlow = calculateEMA(data, 26);
            const macdLine = emaFast - emaSlow;
            const signal = macdLine * 0.9;
            const histogram = macdLine - signal;
            return { MACD: macdLine, signal, histogram };
        }

        function updateMarketData() {
            if (state.candles.length === 0) return;
            
            const latest = state.candles[state.candles.length - 1];
            const closes = state.candles.map(c => c.close);
            
            document.getElementById('currentPrice').textContent = latest.close.toFixed(5);
            
            if (closes.length >= 50) {
                const ema12 = calculateEMA(closes, 12);
                const ema50 = calculateEMA(closes, 50);
                const status = ema12 > ema50 ? 'Bullish' : 'Bearish';
                const statusEl = document.getElementById('emaStatus');
                statusEl.textContent = status;
                statusEl.className = `text-lg font-bold ${ema12 > ema50 ? 'text-green-400' : 'text-red-400'}`;
                
                const trend = closes[closes.length - 1] > calculateSMA(closes, 20) ? 'Up' : 'Down';
                const trendEl = document.getElementById('trendIndicator');
                trendEl.textContent = trend;
                trendEl.className = `text-lg font-bold ${trend === 'Up' ? 'text-green-400' : 'text-red-400'}`;
            }
        }

        // Strategy Analysis
        function analyzeMarket() {
            if (!state.isTrading || state.candles.length < 50 || state.activeContracts.size > 0) return;
            
            const closes = state.candles.map(c => c.close);
            
            for (const [key, strategy] of Object.entries(state.strategies)) {
                if (!strategy.active) continue;

                let signal = null;
                if (key === 'ema_cross') signal = checkEMACross(closes, strategy.params);
                else if (key === 'sma_cross') signal = checkSMACross(closes, strategy.params);
                else if (key === 'macd_ma') signal = checkMACDMA(closes, strategy.params);

                if (signal) {
                    executeTrade(signal, key);
                    break;
                }
            }
        }

        function checkEMACross(closes, params) {
            const emaFast = calculateEMA(closes, params.fastPeriod);
            const emaFastPrev = calculateEMA(closes.slice(0, -1), params.fastPeriod);
            const emaSlow = calculateEMA(closes, params.slowPeriod);
            const emaSlowPrev = calculateEMA(closes.slice(0, -1), params.slowPeriod);
            
            const latest = state.candles[state.candles.length - 1];
            const isBullish = latest.close > latest.open;

            if (emaFastPrev <= emaSlowPrev && emaFast > emaSlow) {
                if (!params.confirmCandle || isBullish) return 'CALL';
            }
            
            if (emaFastPrev >= emaSlowPrev && emaFast < emaSlow) {
                if (!params.confirmCandle || !isBullish) return 'PUT';
            }
            
            return null;
        }

        function checkSMACross(closes, params) {
            const smaFast = calculateSMA(closes, params.fastPeriod);
            const smaFastPrev = calculateSMA(closes.slice(0, -1), params.fastPeriod);
            const smaSlow = calculateSMA(closes, params.slowPeriod);
            const smaSlowPrev = calculateSMA(closes.slice(0, -1), params.slowPeriod);
            
            const latest = state.candles[state.candles.length - 1];
            const isBullish = latest.close > latest.open;

            if (smaFastPrev <= smaSlowPrev && smaFast > smaSlow) {
                if (!params.confirmCandle || isBullish) return 'CALL';
            }
            
            if (smaFastPrev >= smaSlowPrev && smaFast < smaSlow) {
                if (!params.confirmCandle || !isBullish) return 'PUT';
            }
            
            return null;
        }

        function checkMACDMA(closes, params) {
            const macd = calculateMACD(closes);
            const macdPrev = calculateMACD(closes.slice(0, -1));
            const latest = state.candles[state.candles.length - 1];
            const isBullish = latest.close > latest.open;

            if (macdPrev.histogram <= 0 && macd.histogram > 0) {
                if (!params.confirmCandle || isBullish) return 'CALL';
            }
            
            if (macdPrev.histogram >= 0 && macd.histogram < 0) {
                if (!params.confirmCandle || !isBullish) return 'PUT';
            }
            
            return null;
        }

        // Trading Functions
        function executeTrade(type, strategyKey) {
            try {
                console.log(`Attempting to execute ${type} trade using ${strategyKey}...`);
                
                const maxRuns = parseInt(document.getElementById('maxRuns').value) || 5;
                if (state.currentRun >= maxRuns) {
                    showToast('Max consecutive runs reached', 'warning');
                    stopTrading();
                    return;
                }

                const targetProfit = parseFloat(document.getElementById('targetProfit').value) || 10;
                if (state.dailyProfit >= targetProfit) {
                    showToast('Daily profit target reached!', 'success');
                    stopTrading();
                    return;
                }

                const maxLoss = parseFloat(document.getElementById('maxLoss').value) || 50;
                if (state.dailyProfit <= -maxLoss) {
                    showToast('Max loss limit reached!', 'error');
                    stopTrading();
                    return;
                }

                const initialStake = parseFloat(document.getElementById('initialStake').value) || 1;
                const multiplier = parseFloat(document.getElementById('martingaleMultiplier').value) || 2;
                
                state.currentStake = state.martingaleEnabled && state.currentRun > 0 ? 
                    state.currentStake * multiplier : initialStake;

                const duration = parseInt(document.getElementById('tradeDuration').value) || 1;
                const durationUnit = document.getElementById('durationUnit').value || 't';

                console.log('Trade params:', {
                    type,
                    stake: state.currentStake,
                    duration,
                    durationUnit,
                    symbol: state.currentSymbol
                });

                sendMessage({
                    proposal: 1,
                    amount: state.currentStake,
                    basis: 'stake',
                    contract_type: type,
                    currency: 'USD',
                    duration: duration,
                    duration_unit: durationUnit,
                    symbol: state.currentSymbol
                });
            } catch (error) {
                console.error('Execute trade error:', error);
                showToast('Failed to execute trade', 'error');
            }
        }

        function executeBuy(proposal) {
            try {
                if (!proposal || !proposal.id) {
                    showToast('Invalid proposal received', 'error');
                    return;
                }

                sendMessage({
                    buy: proposal.id,
                    price: state.currentStake
                });
            } catch (error) {
                console.error('Execute buy error:', error);
                showToast('Failed to execute trade', 'error');
            }
        }

        function handleTradeOpened(buyData) {
            const contract = {
                id: buyData.contract_id,
                buyPrice: parseFloat(buyData.buy_price),
                type: buyData.contract_type,
                startTime: Date.now(),
                profit: 0,
                status: 'open'
            };

            state.activeContracts.set(contract.id, contract);
            state.currentRun++;
            
            updateActiveTradesUI();
            
            sendMessage({
                proposal_open_contract: 1,
                contract_id: contract.id,
                subscribe: 1
            });

            showToast(`${contract.type} trade opened - ${contract.buyPrice.toFixed(2)}`, 'info');
        }

        function updateContract(contractData) {
            try {
                if (!contractData || !contractData.contract_id) {
                    console.warn('Invalid contract data received');
                    return;
                }

                const contract = state.activeContracts.get(contractData.contract_id);
                if (!contract) {
                    console.warn('Contract not found:', contractData.contract_id);
                    return;
                }

                // Update contract details
                contract.currentPrice = parseFloat(contractData.bid_price || contractData.current_spot || 0);
                contract.profit = parseFloat(contractData.profit || 0);
                contract.status = contractData.status || 'open';
                contract.is_sold = contractData.is_sold || 0;
                
                console.log('Contract update:', {
                    id: contract.id,
                    status: contract.status,
                    profit: contract.profit,
                    is_sold: contract.is_sold
                });

                // Check if contract is finished
                if (contract.status === 'sold' || contract.is_sold === 1) {
                    handleTradeClosed(contract);
                } else {
                    updateActiveTradesUI();
                }
            } catch (error) {
                console.error('Update contract error:', error);
            }
        }

        function handleTradeClosed(contract) {
            state.activeContracts.delete(contract.id);
            
            const isWin = contract.profit > 0;
            
            if (isWin) {
                state.totalWins++;
                state.currentRun = 0;
                state.currentStake = parseFloat(document.getElementById('initialStake').value);
            } else {
                state.totalLosses++;
            }

            state.dailyProfit += contract.profit;
            
            state.tradeHistory.unshift({
                ...contract,
                endTime: Date.now()
            });

            if (state.tradeHistory.length > 50) state.tradeHistory.pop();

            updateAccountInfo();
            updateActiveTradesUI();
            updateTradeHistoryUI();
            
            showToast(
                `Trade ${isWin ? 'Won' : 'Lost'}: ${Math.abs(contract.profit).toFixed(2)}`,
                isWin ? 'success' : 'error'
            );

            if (state.isTrading) {
                setTimeout(() => analyzeMarket(), 2000);
            }
        }

        // Chart Functions
        function initChart() {
            const ctx = document.getElementById('tradingChart').getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#6366f1',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#94a3b8', maxTicksLimit: 8 }
                        },
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: value => value.toFixed(5)
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!state.chart || state.candles.length === 0) return;
            
            const times = state.candles.map(c => new Date(c.time).toLocaleTimeString());
            const prices = state.candles.map(c => c.close);
            
            state.chart.data.labels = times;
            state.chart.data.datasets[0].data = prices;
            state.chart.update('none');
        }

        function resetChart() {
            if (state.chart) {
                state.chart.resetZoom();
            }
        }

        // UI Functions
        function toggleTrading() {
            if (!state.isConnected) {
                showToast('Please connect to Deriv first', 'error');
                return;
            }

            state.isTrading = !state.isTrading;
            const btn = document.getElementById('startTradingBtn');
            
            if (state.isTrading) {
                btn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Trading';
                btn.className = 'bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold transition transform hover:scale-105';
                showToast('Trading started', 'success');
                state.currentRun = 0;
                analyzeMarket();
            } else {
                stopTrading();
            }
        }

        function stopTrading() {
            state.isTrading = false;
            const btn = document.getElementById('startTradingBtn');
            btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Trading';
            btn.className = 'bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition transform hover:scale-105';
            showToast('Trading stopped', 'warning');
        }

        function toggleMartingale() {
            state.martingaleEnabled = !state.martingaleEnabled;
            const toggle = document.getElementById('martingaleToggle');
            toggle.classList.toggle('active');
            showToast(`Martingale ${state.martingaleEnabled ? 'enabled' : 'disabled'}`, 'info');
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const btn = document.getElementById('connectBtn');
            
            if (connected) {
                status.innerHTML = '<span class="status-dot status-connected mr-2"></span><span class="text-green-400">Connected</span>';
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Connected';
                btn.className = 'bg-green-600 px-6 py-2 rounded-lg font-semibold text-white';
            } else {
                status.innerHTML = '<span class="status-dot status-disconnected mr-2"></span><span class="text-gray-400">Disconnected</span>';
                btn.innerHTML = '<i class="fas fa-plug mr-2"></i>Connect';
                btn.className = 'btn-primary px-6 py-2 rounded-lg font-semibold text-white';
            }
        }

        function updateAccountInfo() {
            document.getElementById('balance').textContent = `${state.accountBalance.toFixed(2)}`;
            document.getElementById('headerBalance').textContent = `${state.accountBalance.toFixed(2)}`;
            
            const plEl = document.getElementById('dailyPL');
            plEl.textContent = `${state.dailyProfit.toFixed(2)}`;
            plEl.className = `text-3xl font-bold ${state.dailyProfit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            const totalTrades = state.totalWins + state.totalLosses;
            document.getElementById('totalTrades').textContent = totalTrades;
            
            const winRate = totalTrades > 0 ? (state.totalWins / totalTrades * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
            
            document.getElementById('totalWins').textContent = state.totalWins;
            document.getElementById('totalLosses').textContent = state.totalLosses;
            
            const wins = state.tradeHistory.filter(t => t.profit > 0);
            const totalProfit = wins.reduce((sum, t) => sum + t.profit, 0);
            const totalLoss = Math.abs(state.tradeHistory.filter(t => t.profit < 0).reduce((sum, t) => sum + t.profit, 0));
            const profitFactor = totalLoss > 0 ? (totalProfit / totalLoss) : 0;
            document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
            
            const avgWin = wins.length > 0 ? (totalProfit / wins.length) : 0;
            document.getElementById('avgWin').textContent = `${avgWin.toFixed(2)}`;
        }

        function updateActiveTradesUI() {
            const container = document.getElementById('activeTradesContainer');
            
            if (state.activeContracts.size === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                        <p>No active trades</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            state.activeContracts.forEach(contract => {
                const div = document.createElement('div');
                div.className = `trade-card ${contract.type === 'CALL' ? 'buy' : 'sell'} glass-card p-4 rounded-lg`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-white">${contract.type}</div>
                        <div class="text-sm font-semibold ${contract.profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${contract.profit >= 0 ? '+' : ''}${contract.profit.toFixed(2)}
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Stake: ${contract.buyPrice.toFixed(2)}</span>
                        <span>${new Date(contract.startTime).toLocaleTimeString()}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateTradeHistoryUI() {
            const container = document.getElementById('tradeHistoryContainer');
            
            if (state.tradeHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-clock text-4xl mb-2 opacity-50"></i>
                        <p>No trades yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            state.tradeHistory.slice(0, 20).forEach(trade => {
                const div = document.createElement('div');
                div.className = `trade-card ${trade.type === 'CALL' ? 'buy' : 'sell'} glass-card p-3 rounded-lg`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <div class="font-semibold text-white">${trade.type}</div>
                            <div class="text-xs text-gray-400">${new Date(trade.endTime).toLocaleString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${trade.profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${trade.profit >= 0 ? '+' : ''}${trade.profit.toFixed(2)}
                            </div>
                            <div class="text-xs text-gray-400">Stake: ${trade.buyPrice.toFixed(2)}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function initStrategies() {
            const container = document.getElementById('strategyContainer');
            container.innerHTML = '';

            Object.entries(state.strategies).forEach(([key, strategy]) => {
                const div = document.createElement('div');
                div.className = 'glass-card rounded-lg p-4 transition';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold text-white mb-1">${strategy.name}</h4>
                            <span class="text-xs px-2 py-1 rounded ${strategy.active ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-400'}">
                                ${strategy.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <button onclick="openSettings('${key}')" class="text-indigo-400 hover:text-indigo-300">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="toggle-switch ${strategy.active ? 'active' : ''}" onclick="toggleStrategy('${key}')"></div>
                        <span class="text-sm text-gray-400">Enable Strategy</span>
                    </div>
                `;
                div.dataset.key = key;
                if (strategy.active) div.classList.add('strategy-active');
                container.appendChild(div);
            });
        }

        function toggleStrategy(key) {
            state.strategies[key].active = !state.strategies[key].active;
            initStrategies();
            showToast(`${state.strategies[key].name} ${state.strategies[key].active ? 'activated' : 'deactivated'}`, 'info');
        }

        function openSettings(key) {
            const strategy = state.strategies[key];
            const container = document.getElementById('strategySettings');
            
            let html = `<h4 class="font-bold text-lg mb-4 text-white">${strategy.name}</h4><div class="space-y-4">`;
            
            Object.entries(strategy.params).forEach(([param, value]) => {
                const label = param.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                
                if (typeof value === 'boolean') {
                    html += `
                        <div class="flex items-center justify-between p-4 bg-gray-900/40 rounded-lg">
                            <span class="text-white">${label}</span>
                            <div class="toggle-switch ${value ? 'active' : ''}" onclick="updateParam('${key}', '${param}', !state.strategies['${key}'].params['${param}'])"></div>
                        </div>
                    `;
                } else {
                    html += `
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">${label}</label>
                            <input type="number" value="${value}" 
                                   onchange="updateParam('${key}', '${param}', parseFloat(this.value))" 
                                   class="w-full input-field rounded-lg px-4 py-3 text-white">
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function updateParam(key, param, value) {
            state.strategies[key].params[param] = value;
            showToast('Settings updated', 'success');
            initStrategies();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
        }

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-600 border-green-500',
                error: 'bg-red-600 border-red-500',
                warning: 'bg-yellow-600 border-yellow-500',
                info: 'bg-blue-600 border-blue-500'
            };

            const icons = {
                success: 'check-circle',
                error: 'times-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl border-l-4 flex items-center`;
            toast.innerHTML = `
                <i class="fas fa-${icons[type]} mr-3 text-xl"></i>
                <span class="font-medium">${message}</span>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Event Listeners
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            state.currentSymbol = e.target.value;
            state.candles = [];
            subscribeToCandles();
        });

        document.getElementById('timeframeSelect').addEventListener('change', (e) => {
            state.currentTimeframe = parseInt(e.target.value);
            state.candles = [];
            subscribeToCandles();
        });

        // Initialize
        window.addEventListener('load', () => {
            initStrategies();
            updateAccountInfo();
            initChart();
        });
    </script>
</body>
</html>