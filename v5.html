<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DerivAI ‚Äî Intelligent Trading Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-deep:#04080f;
  --bg-base:#07111d;
  --bg-card:#0c1929;
  --bg-card2:#101f33;
  --bg-hover:#142540;
  --border:#1a3050;
  --border-glow:rgba(0,212,255,0.2);
  --text-primary:#d4eaff;
  --text-secondary:#6a8aaa;
  --text-muted:#364e68;
  --cyan:#00d4ff;
  --green:#00ff88;
  --red:#ff3366;
  --orange:#ff8c42;
  --yellow:#ffcc00;
  --purple:#a855f7;
  --nav-w:220px;
  --header-h:60px;
  --font-display:'Orbitron',monospace;
  --font-body:'Rajdhani',sans-serif;
  --font-mono:'Share Tech Mono',monospace;
}
html,body{height:100%;overflow:hidden;background:var(--bg-deep);color:var(--text-primary);font-family:var(--font-body);font-size:15px}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg-deep)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--cyan)}

/* LOGIN */
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg-deep);z-index:9999;flex-direction:column;gap:0}
.login-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 40%,rgba(0,212,255,0.06) 0%,transparent 60%),radial-gradient(ellipse at 70% 60%,rgba(0,255,136,0.04) 0%,transparent 50%);pointer-events:none}
.login-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,212,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;animation:gridPulse 4s ease-in-out infinite}
@keyframes gridPulse{0%,100%{opacity:0.5}50%{opacity:1}}
.login-box{position:relative;background:var(--bg-card);border:1px solid var(--border);border-top:2px solid var(--cyan);padding:48px 44px;width:460px;box-shadow:0 0 60px rgba(0,212,255,0.08),0 40px 80px rgba(0,0,0,0.5)}
.login-logo{font-family:var(--font-display);font-size:28px;color:var(--cyan);letter-spacing:4px;text-align:center;margin-bottom:4px;text-shadow:0 0 30px rgba(0,212,255,0.5)}
.login-sub{text-align:center;color:var(--text-secondary);font-family:var(--font-body);font-size:13px;letter-spacing:2px;text-transform:uppercase;margin-bottom:36px}
.login-field{margin-bottom:20px}
.login-field label{display:block;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:8px}
.login-field input,.login-field select{width:100%;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-primary);padding:12px 16px;font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s}
.login-field input:focus,.login-field select:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,212,255,0.1)}
.login-field select{cursor:pointer}
.login-field select option{background:var(--bg-card);color:var(--text-primary)}
.login-note{font-size:12px;color:var(--text-muted);margin-top:6px;line-height:1.5}
.login-note a{color:var(--cyan);text-decoration:none}
.btn-connect{width:100%;background:var(--cyan);color:var(--bg-deep);border:none;padding:14px;font-family:var(--font-display);font-size:12px;letter-spacing:3px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:8px;text-transform:uppercase}
.btn-connect:hover{background:#33ddff;box-shadow:0 0 30px rgba(0,212,255,0.4)}
.btn-connect:disabled{opacity:0.5;cursor:not-allowed}
.login-status{text-align:center;margin-top:16px;font-size:12px;color:var(--text-secondary);min-height:20px}
.login-status.error{color:var(--red)}
.login-status.success{color:var(--green)}
.login-status.connecting{color:var(--yellow);animation:blink 1s infinite}
@keyframes blink{50%{opacity:0.4}}

/* APP LAYOUT */
#app{display:none;height:100vh;flex-direction:column}
#app.visible{display:flex}

/* HEADER */
.app-header{height:var(--header-h);background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:20px;flex-shrink:0;z-index:100}
.header-logo{font-family:var(--font-display);font-size:16px;color:var(--cyan);letter-spacing:3px;white-space:nowrap;text-shadow:0 0 20px rgba(0,212,255,0.3)}
.header-sep{width:1px;height:30px;background:var(--border);flex-shrink:0}
.conn-indicator{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-secondary)}
.conn-dot{width:8px;height:8px;border-radius:50%;background:var(--text-muted);transition:background 0.3s}
.conn-dot.connected{background:var(--green);box-shadow:0 0 8px rgba(0,255,136,0.6);animation:connPulse 2s infinite}
.conn-dot.connecting{background:var(--yellow);animation:blink 0.8s infinite}
.conn-dot.error{background:var(--red)}
@keyframes connPulse{0%,100%{box-shadow:0 0 8px rgba(0,255,136,0.6)}50%{box-shadow:0 0 16px rgba(0,255,136,0.9)}}
.header-account{display:flex;align-items:center;gap:16px;margin-left:auto;flex-shrink:0}
.acct-chip{background:var(--bg-deep);border:1px solid var(--border);padding:6px 14px;font-size:12px;color:var(--text-secondary)}
.acct-chip span{color:var(--text-primary);font-family:var(--font-mono)}
.balance-display{display:flex;flex-direction:column;align-items:flex-end}
.balance-label{font-size:10px;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase}
.balance-val{font-family:var(--font-mono);font-size:20px;color:var(--green);font-weight:700;text-shadow:0 0 20px rgba(0,255,136,0.3)}
.header-auto{display:flex;align-items:center;gap:10px;padding:0 16px;border-left:1px solid var(--border)}
.auto-label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary)}
.toggle-switch{position:relative;width:44px;height:24px;cursor:pointer}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-track{position:absolute;inset:0;background:var(--bg-deep);border:1px solid var(--border);border-radius:12px;transition:all 0.3s}
.toggle-thumb{position:absolute;top:3px;left:3px;width:16px;height:16px;background:var(--text-muted);border-radius:50%;transition:all 0.3s}
.toggle-switch input:checked + .toggle-track{background:rgba(0,255,136,0.15);border-color:var(--green)}
.toggle-switch input:checked + .toggle-track + .toggle-thumb{left:23px;background:var(--green);box-shadow:0 0 8px rgba(0,255,136,0.6)}
.auto-status{font-size:11px;font-family:var(--font-mono);color:var(--text-muted)}
.auto-status.on{color:var(--green)}

/* BODY LAYOUT */
.app-body{display:flex;flex:1;overflow:hidden}

/* NAV */
.app-nav{width:var(--nav-w);background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.nav-section{padding:16px 0 8px}
.nav-section-label{font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);padding:0 20px 8px;font-family:var(--font-display)}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 20px;cursor:pointer;transition:all 0.2s;border-left:2px solid transparent;color:var(--text-secondary);font-size:14px;font-weight:500;user-select:none}
.nav-item:hover{background:var(--bg-hover);color:var(--text-primary);border-left-color:var(--border)}
.nav-item.active{background:rgba(0,212,255,0.07);color:var(--cyan);border-left-color:var(--cyan)}
.nav-item .ni{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--red);color:white;font-size:10px;padding:2px 6px;border-radius:10px;font-family:var(--font-mono);min-width:20px;text-align:center}
.nav-badge.green{background:var(--green);color:var(--bg-deep)}
.nav-badge.cyan{background:var(--cyan);color:var(--bg-deep)}
.nav-divider{height:1px;background:var(--border);margin:8px 16px}
.nav-footer{margin-top:auto;padding:16px;border-top:1px solid var(--border)}
.nav-logout{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;color:var(--text-muted);font-size:13px;transition:color 0.2s;border:1px solid transparent;font-family:var(--font-body);font-weight:500;background:none;width:100%;text-align:left}
.nav-logout:hover{color:var(--red);border-color:rgba(255,51,102,0.3)}

/* MAIN CONTENT */
.app-main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow-y:auto;padding:24px;height:100%}
.page.active{display:block}

/* PAGE HEADERS */
.page-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-title{font-family:var(--font-display);font-size:18px;letter-spacing:2px;color:var(--text-primary)}
.page-title span{color:var(--cyan)}
.page-actions{display:flex;gap:10px;align-items:center}
.btn{padding:8px 18px;font-family:var(--font-body);font-size:13px;font-weight:600;letter-spacing:1px;cursor:pointer;border:none;transition:all 0.2s;outline:none}
.btn-primary{background:var(--cyan);color:var(--bg-deep)}
.btn-primary:hover{background:#33ddff;box-shadow:0 0 20px rgba(0,212,255,0.3)}
.btn-secondary{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--cyan);color:var(--cyan)}
.btn-danger{background:transparent;color:var(--red);border:1px solid rgba(255,51,102,0.3)}
.btn-danger:hover{background:rgba(255,51,102,0.1)}
.btn-success{background:var(--green);color:var(--bg-deep)}
.btn-success:hover{box-shadow:0 0 20px rgba(0,255,136,0.3)}
.btn-sm{padding:5px 12px;font-size:12px}

/* STAT CARDS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg-card);border:1px solid var(--border);padding:16px 18px;position:relative;overflow:hidden;transition:border-color 0.2s}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.cyan::before{background:var(--cyan)}
.stat-card.green::before{background:var(--green)}
.stat-card.red::before{background:var(--red)}
.stat-card.orange::before{background:var(--orange)}
.stat-card.purple::before{background:var(--purple)}
.stat-card.yellow::before{background:var(--yellow)}
.stat-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;font-family:var(--font-display)}
.stat-val{font-family:var(--font-mono);font-size:26px;color:var(--text-primary);line-height:1}
.stat-val.cyan{color:var(--cyan)}
.stat-val.green{color:var(--green);text-shadow:0 0 20px rgba(0,255,136,0.3)}
.stat-val.red{color:var(--red)}
.stat-val.orange{color:var(--orange)}
.stat-sub{font-size:11px;color:var(--text-muted);margin-top:6px}
.stat-sub .up{color:var(--green)}
.stat-sub .dn{color:var(--red)}

/* CARDS */
.card{background:var(--bg-card);border:1px solid var(--border);padding:20px;margin-bottom:16px}
.card-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.card-title{font-family:var(--font-display);font-size:12px;letter-spacing:2px;color:var(--text-secondary);text-transform:uppercase}
.card-body{overflow:hidden}

/* GRID LAYOUTS */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* TABLE */
.data-table{width:100%;border-collapse:collapse;font-family:var(--font-body)}
.data-table th{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);padding:10px 14px;border-bottom:1px solid var(--border);text-align:left;font-weight:600;white-space:nowrap;position:sticky;top:0;background:var(--bg-card);z-index:1}
.data-table td{padding:10px 14px;border-bottom:1px solid rgba(26,48,80,0.5);font-size:13px;vertical-align:middle;white-space:nowrap}
.data-table tr:hover td{background:var(--bg-hover)}
.data-table tr:last-child td{border-bottom:none}
.tbl-mono{font-family:var(--font-mono);font-size:12px}
.tbl-badge{display:inline-block;padding:2px 8px;font-size:10px;letter-spacing:1px;font-weight:700;text-transform:uppercase;font-family:var(--font-mono)}
.badge-rise{background:rgba(0,255,136,0.15);color:var(--green);border:1px solid rgba(0,255,136,0.3)}
.badge-fall{background:rgba(255,51,102,0.15);color:var(--red);border:1px solid rgba(255,51,102,0.3)}
.badge-rise-eq{background:rgba(0,255,136,0.08);color:#80ffbb;border:1px solid rgba(0,255,136,0.2)}
.badge-fall-eq{background:rgba(255,51,102,0.08);color:#ff80a0;border:1px solid rgba(255,51,102,0.2)}
.badge-pending{background:rgba(255,204,0,0.1);color:var(--yellow);border:1px solid rgba(255,204,0,0.3)}
.badge-won{background:rgba(0,255,136,0.1);color:var(--green);border:1px solid rgba(0,255,136,0.2)}
.badge-lost{background:rgba(255,51,102,0.1);color:var(--red);border:1px solid rgba(255,51,102,0.2)}

/* MARKET WATCH */
.mw-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.mw-card{background:var(--bg-card);border:1px solid var(--border);padding:16px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.mw-card:hover{border-color:var(--cyan);background:var(--bg-hover)}
.mw-card.selected{border-color:var(--cyan);background:rgba(0,212,255,0.05)}
.mw-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.mw-sym-name{font-family:var(--font-display);font-size:11px;letter-spacing:2px;color:var(--text-secondary)}
.mw-sym-id{font-family:var(--font-mono);font-size:9px;color:var(--text-muted);margin-top:2px}
.mw-price-block{text-align:right}
.mw-price{font-family:var(--font-mono);font-size:20px;color:var(--text-primary);line-height:1;transition:color 0.3s}
.mw-price.up{color:var(--green)}
.mw-price.dn{color:var(--red)}
.mw-price-change{font-family:var(--font-mono);font-size:11px;margin-top:2px}
.mw-mini-chart{height:50px;position:relative}
.mw-stats{display:flex;gap:16px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.mw-stat{display:flex;flex-direction:column;gap:2px}
.mw-stat-lbl{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase}
.mw-stat-val{font-family:var(--font-mono);font-size:11px;color:var(--text-secondary)}
.mw-direction-arrow{font-size:20px;line-height:1}
.mw-direction-arrow.up{color:var(--green);filter:drop-shadow(0 0 6px rgba(0,255,136,0.6))}
.mw-direction-arrow.dn{color:var(--red);filter:drop-shadow(0 0 6px rgba(255,51,102,0.6))}
.mw-signal-pill{position:absolute;top:10px;right:10px;font-size:9px;letter-spacing:1px;padding:2px 6px;font-family:var(--font-mono);font-weight:700}

/* SIGNALS */
.sig-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.sig-card{background:var(--bg-card);border:1px solid var(--border);padding:18px;position:relative;overflow:hidden;transition:all 0.2s}
.sig-card::after{content:'';position:absolute;top:0;right:0;width:3px;height:100%;transition:width 0.3s}
.sig-card.rise-sig::after{background:var(--green)}
.sig-card.fall-sig::after{background:var(--red)}
.sig-card.rise-eq-sig::after{background:rgba(0,255,136,0.5)}
.sig-card.fall-eq-sig::after{background:rgba(255,51,102,0.5)}
.sig-card:hover{border-color:rgba(0,212,255,0.3)}
.sig-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.sig-sym{font-family:var(--font-display);font-size:13px;letter-spacing:2px;color:var(--text-primary)}
.sig-time{font-family:var(--font-mono);font-size:10px;color:var(--text-muted)}
.sig-main{display:flex;align-items:center;gap:16px;margin-bottom:14px}
.sig-direction{font-family:var(--font-display);font-size:22px;font-weight:900}
.sig-direction.rise{color:var(--green);text-shadow:0 0 20px rgba(0,255,136,0.4)}
.sig-direction.fall{color:var(--red);text-shadow:0 0 20px rgba(255,51,102,0.4)}
.sig-conf-block{flex:1}
.sig-conf-label{font-size:10px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px}
.sig-conf-bar{height:6px;background:var(--bg-deep);border:1px solid var(--border);position:relative;overflow:hidden}
.sig-conf-fill{height:100%;transition:width 0.5s}
.fill-green{background:linear-gradient(90deg,var(--green),rgba(0,255,136,0.5))}
.fill-red{background:linear-gradient(90deg,var(--red),rgba(255,51,102,0.5))}
.sig-conf-pct{font-family:var(--font-mono);font-size:18px;font-weight:700;margin-top:4px}
.conf-green{color:var(--green)}
.conf-red{color:var(--red)}
.conf-yellow{color:var(--yellow)}
.sig-details{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.sig-detail{background:var(--bg-deep);padding:8px 10px}
.sig-detail-lbl{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:3px}
.sig-detail-val{font-family:var(--font-mono);font-size:12px;color:var(--text-primary)}
.sig-indicators{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.ind-pill{font-size:9px;letter-spacing:1px;padding:2px 7px;font-family:var(--font-mono);font-weight:700;text-transform:uppercase}
.ind-bull{background:rgba(0,255,136,0.1);color:var(--green);border:1px solid rgba(0,255,136,0.3)}
.ind-bear{background:rgba(255,51,102,0.1);color:var(--red);border:1px solid rgba(255,51,102,0.3)}
.ind-neutral{background:rgba(106,138,170,0.1);color:var(--text-secondary);border:1px solid var(--border)}
.sig-actions{display:flex;gap:8px}

/* ANALYTICS */
.analytics-sym-select{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.sym-tab{padding:6px 14px;font-size:11px;letter-spacing:1px;font-family:var(--font-mono);cursor:pointer;border:1px solid var(--border);color:var(--text-secondary);background:transparent;transition:all 0.2s;text-transform:uppercase}
.sym-tab:hover{border-color:var(--cyan);color:var(--cyan)}
.sym-tab.active{background:rgba(0,212,255,0.1);border-color:var(--cyan);color:var(--cyan)}
.chart-container{position:relative;height:220px}
.analytics-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.tick-tape{font-family:var(--font-mono);font-size:11px;display:flex;gap:2px;flex-wrap:wrap;max-height:80px;overflow:hidden}
.tick-dot{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;font-size:9px;font-weight:700}
.tick-dot.up{background:rgba(0,255,136,0.2);color:var(--green)}
.tick-dot.dn{background:rgba(255,51,102,0.2);color:var(--red)}
.tick-dot.eq{background:rgba(106,138,170,0.2);color:var(--text-secondary)}
.indicator-table{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ind-row{background:var(--bg-deep);padding:10px 12px;border:1px solid var(--border)}
.ind-row-name{font-size:10px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px}
.ind-row-val{font-family:var(--font-mono);font-size:14px;color:var(--text-primary)}
.ind-row-signal{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* ACTIVE TRADES */
.trade-card{background:var(--bg-card);border:1px solid var(--border);padding:16px 20px;margin-bottom:10px;display:flex;align-items:center;gap:20px;transition:border-color 0.2s}
.trade-card:hover{border-color:var(--border-glow)}
.trade-sym{min-width:140px}
.trade-sym-name{font-family:var(--font-display);font-size:12px;letter-spacing:2px;color:var(--text-secondary)}
.trade-contract{font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-top:3px}
.trade-progress{flex:1}
.trade-progress-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.trade-progress-label{font-size:11px;color:var(--text-secondary)}
.trade-progress-bar{height:4px;background:var(--bg-deep);border:1px solid var(--border);position:relative;overflow:hidden}
.trade-progress-fill{height:100%;background:var(--cyan);transition:width 0.5s}
.trade-pnl{min-width:100px;text-align:right}
.trade-pnl-val{font-family:var(--font-mono);font-size:18px;font-weight:700}
.trade-stake{min-width:80px;text-align:center}
.trade-stake-lbl{font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px}
.trade-stake-val{font-family:var(--font-mono);font-size:14px;color:var(--text-primary)}
.no-trades{text-align:center;padding:60px 20px;color:var(--text-muted)}
.no-trades .icon{font-size:48px;margin-bottom:16px}
.no-trades p{font-size:14px;color:var(--text-secondary)}

/* SETTINGS */
.settings-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:24px}
.stab{padding:10px 24px;font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;color:var(--text-muted);border-bottom:2px solid transparent;transition:all 0.2s;font-family:var(--font-display)}
.stab:hover{color:var(--text-secondary)}
.stab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.stab-content{display:none}
.stab-content.active{display:block}
.settings-group{background:var(--bg-card);border:1px solid var(--border);padding:20px;margin-bottom:16px}
.settings-group-title{font-family:var(--font-display);font-size:11px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:18px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.settings-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
.form-field{display:flex;flex-direction:column;gap:6px}
.form-field label{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary)}
.form-field input,.form-field select{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-primary);padding:9px 12px;font-family:var(--font-mono);font-size:13px;outline:none;transition:border-color 0.2s;width:100%}
.form-field input:focus,.form-field select:focus{border-color:var(--cyan)}
.form-field select option{background:var(--bg-card)}
.form-field .hint{font-size:10px;color:var(--text-muted);line-height:1.5;margin-top:2px}
.form-field input[type="range"]{accent-color:var(--cyan);height:auto;padding:0;border:none;background:transparent}
.range-display{font-family:var(--font-mono);font-size:13px;color:var(--cyan)}
.checkbox-field{display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 0}
.checkbox-field input[type="checkbox"]{width:16px;height:16px;accent-color:var(--cyan);cursor:pointer}
.checkbox-field span{font-size:13px;color:var(--text-primary)}
.sym-checkboxes{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
.sym-checkbox{display:flex;align-items:center;gap:6px;background:var(--bg-deep);border:1px solid var(--border);padding:5px 10px;cursor:pointer;transition:all 0.2s}
.sym-checkbox:hover{border-color:var(--cyan)}
.sym-checkbox input{accent-color:var(--cyan);cursor:pointer}
.sym-checkbox span{font-size:11px;font-family:var(--font-mono);color:var(--text-secondary)}
.sym-checkbox.checked{border-color:rgba(0,212,255,0.4);background:rgba(0,212,255,0.05)}
.sym-checkbox.checked span{color:var(--cyan)}
.save-row{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}

/* TOASTS */
#toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--bg-card2);border:1px solid var(--border);padding:12px 18px;font-size:13px;color:var(--text-primary);display:flex;align-items:center;gap:10px;animation:toastIn 0.3s ease;min-width:240px;max-width:360px;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--red)}
.toast.info{border-left:3px solid var(--cyan)}
.toast.warn{border-left:3px solid var(--yellow)}
.toast-icon{font-size:16px;flex-shrink:0}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(20px)}}
.toast.out{animation:toastOut 0.3s ease forwards}

/* HISTORY FILTER */
.filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border)}
.filter-row label{font-size:11px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase}
.filter-row select,.filter-row input{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-primary);padding:6px 10px;font-family:var(--font-mono);font-size:12px;outline:none}
.filter-row select:focus,.filter-row input:focus{border-color:var(--cyan)}

/* AI INSIGHT BOX */
.ai-insight{background:linear-gradient(135deg,rgba(0,212,255,0.05) 0%,rgba(0,255,136,0.03) 100%);border:1px solid rgba(0,212,255,0.15);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.ai-icon{font-size:20px;flex-shrink:0}
.ai-text{font-size:12px;color:var(--text-secondary);line-height:1.6}
.ai-text strong{color:var(--cyan)}

/* RISK METER */
.risk-meter{height:8px;background:var(--bg-deep);border:1px solid var(--border);position:relative;overflow:hidden;margin-bottom:4px}
.risk-fill{height:100%;transition:width 0.5s}
.risk-low{background:linear-gradient(90deg,var(--green),#66ffaa)}
.risk-med{background:linear-gradient(90deg,var(--yellow),#ffaa33)}
.risk-high{background:linear-gradient(90deg,var(--orange),var(--red))}

/* PNLCOLOR */
.pnl-positive{color:var(--green)}
.pnl-negative{color:var(--red)}
.pnl-zero{color:var(--text-secondary)}

/* PULSE ANIMATION */
.pulse-green{animation:pulseGreen 1s ease}
.pulse-red{animation:pulseRed 1s ease}
@keyframes pulseGreen{0%{text-shadow:0 0 0 rgba(0,255,136,0)}50%{text-shadow:0 0 20px rgba(0,255,136,0.8)}100%{text-shadow:0 0 0 rgba(0,255,136,0)}}
@keyframes pulseRed{0%{text-shadow:0 0 0 rgba(255,51,102,0)}50%{text-shadow:0 0 20px rgba(255,51,102,0.8)}100%{text-shadow:0 0 0 rgba(255,51,102,0)}}

/* LOADING */
.loading-dots{display:inline-flex;gap:4px}
.loading-dots span{width:6px;height:6px;background:var(--cyan);border-radius:50%;animation:ldots 1.2s infinite ease-in-out}
.loading-dots span:nth-child(2){animation-delay:0.2s}
.loading-dots span:nth-child(3){animation-delay:0.4s}
@keyframes ldots{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1)}}

/* SPARK LINE CANVAS */
canvas.sparkline{display:block;width:100%;height:100%}

/* ENSEMBLE ML PANEL */
.model-panel{display:flex;flex-direction:column;gap:6px}
.model-row{display:grid;grid-template-columns:110px 1fr 60px 70px;align-items:center;gap:8px;padding:7px 10px;background:var(--bg-deep);border:1px solid var(--border);transition:border-color 0.2s}
.model-row:hover{border-color:var(--border-glow)}
.model-name{font-size:10px;letter-spacing:1px;color:var(--text-secondary);text-transform:uppercase;font-family:var(--font-display)}
.model-bar-wrap{height:6px;background:rgba(26,48,80,0.8);position:relative;overflow:hidden}
.model-bar-fill{height:100%;transition:width 0.5s,background 0.3s}
.model-vote{font-family:var(--font-mono);font-size:11px;font-weight:700;text-align:right}
.model-acc{font-family:var(--font-mono);font-size:10px;color:var(--text-muted);text-align:right}
.model-vote.bull{color:var(--green)}
.model-vote.bear{color:var(--red)}
.model-vote.neut{color:var(--text-muted)}
.ensemble-result{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(0,255,136,0.04));border:1px solid rgba(0,212,255,0.2);padding:12px 16px;margin-bottom:8px}
.ensemble-vote-row{display:flex;align-items:center;gap:12px}
.ensemble-label{font-family:var(--font-display);font-size:9px;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px}
.ensemble-direction{font-family:var(--font-display);font-size:24px;font-weight:900;letter-spacing:2px}
.ensemble-direction.rise{color:var(--green);text-shadow:0 0 20px rgba(0,255,136,0.4)}
.ensemble-direction.fall{color:var(--red);text-shadow:0 0 20px rgba(255,51,102,0.4)}
.ensemble-votes{display:flex;gap:10px;font-family:var(--font-mono);font-size:12px;flex-wrap:wrap}
.ev-bull{color:var(--green)}
.ev-bear{color:var(--red)}
.ev-neut{color:var(--text-muted)}
.ct-scoring{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px}
.ct-score-row{background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;display:flex;align-items:center;justify-content:space-between;transition:border-color 0.2s}
.ct-score-row.best{border-color:var(--cyan);background:rgba(0,212,255,0.05)}
.ct-score-name{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text-secondary);font-family:var(--font-display)}
.ct-score-val{font-family:var(--font-mono);font-size:13px;font-weight:700}
.model-weight-badge{font-size:9px;background:rgba(168,85,247,0.15);color:var(--purple);border:1px solid rgba(168,85,247,0.3);padding:1px 5px;font-family:var(--font-mono)}
.model-perf-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px}
.model-perf-chip{background:var(--bg-deep);border:1px solid var(--border);padding:6px 8px;text-align:center}
.model-perf-name{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.model-perf-acc{font-family:var(--font-mono);font-size:13px}

/* RESPONSIVE tweaks */
@media(max-width:900px){
  .app-nav{display:none}
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
  .analytics-grid{grid-template-columns:1fr}
}

/* SCROLLABLE TABLE WRAPPER */
.tbl-wrap{overflow-x:auto;overflow-y:auto;max-height:500px}

/* AI NEURAL INDICATOR */
.neural-badge{display:inline-flex;align-items:center;gap:5px;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--cyan);font-family:var(--font-display);padding:3px 8px;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.05)}
.neural-dot{width:5px;height:5px;background:var(--cyan);border-radius:50%;animation:connPulse 1.5s infinite}

/* MARKET SESSIONS */
.session-bar{display:flex;gap:8px;padding:8px 0;margin-bottom:16px;border-bottom:1px solid var(--border)}
.session-chip{font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:4px 10px;font-family:var(--font-display);border:1px solid var(--border);color:var(--text-muted)}
.session-chip.live{border-color:rgba(0,255,136,0.4);color:var(--green);background:rgba(0,255,136,0.05)}
.session-time{margin-left:auto;font-family:var(--font-mono);font-size:12px;color:var(--text-secondary)}

/* PNL CHART */
.pnl-mini{display:flex;gap:2px;align-items:flex-end;height:32px;margin-top:8px}
.pnl-bar{flex:1;min-width:4px;transition:height 0.3s}
.pnl-bar.pos{background:var(--green);opacity:0.7}
.pnl-bar.neg{background:var(--red);opacity:0.7}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-grid"></div>
  <div class="login-box">
    <div class="login-logo">DERIV¬∑AI</div>
    <div class="login-sub">Intelligent Trading Terminal</div>
    <div class="login-field">
      <label>API Token</label>
      <input type="password" id="apiToken" placeholder="Enter your Deriv API token‚Ä¶" autocomplete="off"/>
      <div class="login-note">Get your API token at <a href="https://app.deriv.com/account/api-token" target="_blank">app.deriv.com</a> with Read + Trade permissions.</div>
    </div>
    <div class="login-field">
      <label>App ID</label>
      <input type="text" id="appId" value="1089" placeholder="App ID (default: 1089)"/>
      <div class="login-note">Use 1089 for testing. Create your own at <a href="https://api.deriv.com/playground" target="_blank">api.deriv.com</a> for production.</div>
    </div>
    <div class="login-field">
      <label>Server</label>
      <select id="serverSelect">
        <option value="wss://ws.binaryws.com/websockets/v3">Binary WebSocket (ws.binaryws.com)</option>
        <option value="wss://ws.derivws.com/websockets/v3">Deriv WebSocket (ws.derivws.com)</option>
      </select>
    </div>
    <button class="btn-connect" id="connectBtn" onclick="initConnect()">CONNECT TO DERIV</button>
    <div class="login-status" id="loginStatus"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- MAIN APP -->
<div id="app">
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-logo">DERIV¬∑AI</div>
    <div class="header-sep"></div>
    <div class="conn-indicator">
      <div class="conn-dot" id="connDot"></div>
      <span id="connStatus">Connecting‚Ä¶</span>
    </div>
    <div class="header-sep"></div>
    <div class="conn-indicator" style="font-family:var(--font-mono);font-size:11px">
      <span id="liveClock" style="color:var(--text-secondary)">--:--:--</span>
    </div>
    <div class="header-account">
      <div class="acct-chip">Account: <span id="hdrAccount">‚Äî</span></div>
      <div class="acct-chip">Currency: <span id="hdrCurrency">‚Äî</span></div>
      <div class="balance-display">
        <div class="balance-label">Balance</div>
        <div class="balance-val" id="hdrBalance">0.00</div>
      </div>
    </div>
    <div class="header-auto">
      <div class="auto-label">Auto Trade</div>
      <label class="toggle-switch">
        <input type="checkbox" id="autoTradeToggle" onchange="toggleAutoTrade()"/>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <div class="auto-status" id="autoStatus">OFF</div>
    </div>
  </header>

  <!-- BODY -->
  <div class="app-body">
    <!-- NAV -->
    <nav class="app-nav">
      <div class="nav-section">
        <div class="nav-section-label">Overview</div>
        <div class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">
          <span class="ni">‚¨°</span> Dashboard
        </div>
        <div class="nav-item" onclick="showPage('market-watch')" data-page="market-watch">
          <span class="ni">‚óà</span> Market Watch
          <span class="nav-badge cyan" id="nb-mw">0</span>
        </div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-section">
        <div class="nav-section-label">Intelligence</div>
        <div class="nav-item" onclick="showPage('signals')" data-page="signals">
          <span class="ni">‚ö°</span> Signals
          <span class="nav-badge green" id="nb-sig">0</span>
        </div>
        <div class="nav-item" onclick="showPage('analytics')" data-page="analytics">
          <span class="ni">‚óé</span> Analytics
        </div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-section">
        <div class="nav-section-label">Trading</div>
        <div class="nav-item" onclick="showPage('active-trades')" data-page="active-trades">
          <span class="ni">‚ñ∑</span> Active Trades
          <span class="nav-badge" id="nb-active" style="background:var(--cyan);color:var(--bg-deep)">0</span>
        </div>
        <div class="nav-item" onclick="showPage('trade-history')" data-page="trade-history">
          <span class="ni">‚â°</span> Trade History
        </div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-section">
        <div class="nav-section-label">Configuration</div>
        <div class="nav-item" onclick="showPage('settings')" data-page="settings">
          <span class="ni">‚öô</span> Settings
        </div>
      </div>
      <div class="nav-footer">
        <button class="nav-logout" onclick="doLogout()">‚èª Disconnect</button>
      </div>
    </nav>

    <!-- MAIN PAGES -->
    <main class="app-main">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <div class="page-hdr">
          <div class="page-title"><span>DASHBOARD</span> ‚Äî Overview</div>
          <div class="page-actions">
            <div class="neural-badge"><div class="neural-dot"></div>AI ACTIVE</div>
            <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()">‚Üª Refresh</button>
          </div>
        </div>
        <div class="ai-insight" id="ai-insight-dash">
          <div class="ai-icon">ü§ñ</div>
          <div class="ai-text" id="ai-insight-text">Initializing AI analysis engine... Streaming live market data from volatility indices.</div>
        </div>
        <div class="stats-row">
          <div class="stat-card cyan">
            <div class="stat-label">Balance</div>
            <div class="stat-val cyan" id="dash-balance">0.00</div>
            <div class="stat-sub" id="dash-currency">‚Äî</div>
          </div>
          <div class="stat-card green">
            <div class="stat-label">Today P&L</div>
            <div class="stat-val" id="dash-pnl">0.00</div>
            <div class="stat-sub" id="dash-pnl-pct">0.00%</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-label">Win Rate</div>
            <div class="stat-val" id="dash-winrate">‚Äî</div>
            <div class="stat-sub" id="dash-trades-count">0 trades today</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-label">Active Trades</div>
            <div class="stat-val orange" id="dash-active">0</div>
            <div class="stat-sub">contracts open</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-label">Top Signal</div>
            <div class="stat-val" style="font-size:14px;font-family:var(--font-display);letter-spacing:1px" id="dash-top-signal">Scanning‚Ä¶</div>
            <div class="stat-sub" id="dash-top-conf">Confidence: ‚Äî</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">Risk Level</div>
            <div class="stat-val" id="dash-risk-val">LOW</div>
            <div class="risk-meter" style="margin-top:8px"><div class="risk-fill risk-low" id="dash-risk-bar" style="width:15%"></div></div>
          </div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-hdr">
              <div class="card-title">Top AI Signals</div>
              <div class="neural-badge" style="font-size:8px"><div class="neural-dot"></div>LIVE</div>
            </div>
            <div class="card-body">
              <table class="data-table" id="dash-signals-table">
                <thead><tr><th>Symbol</th><th>Signal</th><th>Confidence</th><th>Action</th></tr></thead>
                <tbody id="dash-signals-body">
                  <tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:30px">Loading signals‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-hdr">
              <div class="card-title">P&L History (Today)</div>
            </div>
            <div class="card-body">
              <div id="dash-pnl-bars" class="pnl-mini" style="height:100px;align-items:flex-end">
                <div style="width:100%;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:12px">No trades yet</div>
              </div>
              <div style="margin-top:12px">
                <div class="chart-container" style="height:140px"><canvas id="dash-pnl-chart"></canvas></div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid-2" style="margin-top:0">
          <div class="card">
            <div class="card-hdr"><div class="card-title">Recent Trades</div></div>
            <table class="data-table"><thead><tr><th>Symbol</th><th>Type</th><th>Stake</th><th>P&L</th></tr></thead>
            <tbody id="dash-recent-body"><tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">No recent trades</td></tr></tbody></table>
          </div>
          <div class="card">
            <div class="card-hdr"><div class="card-title">Market Pulse (Live Ticks)</div></div>
            <div id="dash-market-pulse" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;max-height:200px;overflow:hidden"></div>
          </div>
        </div>
      </div>

      <!-- MARKET WATCH PAGE -->
      <div class="page" id="page-market-watch">
        <div class="page-hdr">
          <div class="page-title"><span>MARKET WATCH</span> ‚Äî Live Volatility Indices</div>
          <div class="page-actions">
            <div class="neural-badge"><div class="neural-dot"></div>STREAMING</div>
            <button class="btn btn-secondary btn-sm" onclick="resubscribeAll()">‚Üª Resubscribe</button>
          </div>
        </div>
        <div class="session-bar">
          <div class="session-chip live">‚óè MARKETS OPEN</div>
          <div class="session-chip">VOLATILITY INDICES 24/7</div>
          <div class="session-chip">SYNTHETIC INDICES</div>
          <div class="session-time" id="mw-clock">--:--:--</div>
        </div>
        <div class="mw-grid" id="mw-grid"></div>
      </div>

      <!-- SIGNALS PAGE -->
      <div class="page" id="page-signals">
        <div class="page-hdr">
          <div class="page-title"><span>AI SIGNALS</span> ‚Äî Trade Intelligence</div>
          <div class="page-actions">
            <select id="sig-filter-type" class="btn btn-secondary btn-sm" style="padding:5px 12px" onchange="renderSignals()">
              <option value="all">All Contract Types</option>
              <option value="CALL">Rise</option>
              <option value="PUT">Fall</option>
              <option value="CALLE">Rise Equals</option>
              <option value="PUTE">Fall Equals</option>
            </select>
            <select id="sig-filter-conf" class="btn btn-secondary btn-sm" style="padding:5px 12px" onchange="renderSignals()">
              <option value="0">Any Confidence</option>
              <option value="60">60%+</option>
              <option value="70">70%+</option>
              <option value="80">80%+</option>
              <option value="90">90%+</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="executeBestSignal()">‚ö° Execute Best</button>
          </div>
        </div>
        <div class="ai-insight" id="sig-ai-insight">
          <div class="ai-icon">üß†</div>
          <div class="ai-text" id="sig-ai-text">AI is scanning all volatility indices for high-confidence trade setups using RSI, EMA crossovers, momentum analysis, and tick pattern recognition.</div>
        </div>
        <div class="sig-grid" id="sig-grid">
          <div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted)">
            <div class="loading-dots"><span></span><span></span><span></span></div>
            <p style="margin-top:16px">Generating AI signals‚Ä¶</p>
          </div>
        </div>
      </div>

      <!-- ANALYTICS PAGE -->
      <div class="page" id="page-analytics">
        <div class="page-hdr">
          <div class="page-title"><span>ANALYTICS</span> ‚Äî Deep Market Intelligence</div>
        </div>
        <div class="analytics-sym-select" id="analytics-sym-tabs"></div>
        <div class="analytics-grid" id="analytics-content">
          <div>
            <div class="card">
              <div class="card-hdr">
                <div class="card-title" id="an-sym-title">Select a symbol</div>
                <div class="neural-badge"><div class="neural-dot"></div>LIVE ANALYSIS</div>
              </div>
              <div class="chart-container"><canvas id="an-price-chart"></canvas></div>
            </div>
            <div class="grid-2" style="margin-bottom:0">
              <div class="card" style="margin-bottom:0">
                <div class="card-hdr"><div class="card-title">RSI (14)</div></div>
                <div class="chart-container" style="height:120px"><canvas id="an-rsi-chart"></canvas></div>
              </div>
              <div class="card" style="margin-bottom:0">
                <div class="card-hdr"><div class="card-title">Momentum</div></div>
                <div class="chart-container" style="height:120px"><canvas id="an-mom-chart"></canvas></div>
              </div>
            </div>
          </div>
          <div>
            <div class="card">
              <div class="card-hdr"><div class="card-title">Tick Pattern Tape</div></div>
              <div class="tick-tape" id="an-tick-tape">
                <span style="color:var(--text-muted);font-size:12px">Waiting for ticks‚Ä¶</span>
              </div>
            </div>
            <div class="card">
              <div class="card-hdr"><div class="card-title">Technical Indicators</div></div>
              <div class="indicator-table" id="an-indicators">
                <div class="ind-row"><div class="ind-row-name">RSI (14)</div><div class="ind-row-val" id="ind-rsi">‚Äî</div><div class="ind-row-signal" id="ind-rsi-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">EMA 5</div><div class="ind-row-val" id="ind-ema5">‚Äî</div><div class="ind-row-signal" id="ind-ema5-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">EMA 10</div><div class="ind-row-val" id="ind-ema10">‚Äî</div><div class="ind-row-signal" id="ind-ema10-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">EMA 20</div><div class="ind-row-val" id="ind-ema20">‚Äî</div><div class="ind-row-signal" id="ind-ema20-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">Momentum</div><div class="ind-row-val" id="ind-mom">‚Äî</div><div class="ind-row-signal" id="ind-mom-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">Volatility</div><div class="ind-row-val" id="ind-vol">‚Äî</div><div class="ind-row-signal" id="ind-vol-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">Streak</div><div class="ind-row-val" id="ind-streak">‚Äî</div><div class="ind-row-signal" id="ind-streak-sig">‚Äî</div></div>
                <div class="ind-row"><div class="ind-row-name">AI Score</div><div class="ind-row-val" id="ind-ai-score" style="font-size:18px;color:var(--cyan)">‚Äî</div><div class="ind-row-signal" id="ind-ai-sig">‚Äî</div></div>
              </div>
            </div>
            <div class="card">
              <div class="card-hdr"><div class="card-title">AI Recommendation</div></div>
              <div id="an-recommendation" style="padding:10px 0">
                <div style="text-align:center;color:var(--text-muted);font-size:12px">Analyzing‚Ä¶</div>
              </div>
            </div>
            <div class="card">
              <div class="card-hdr">
                <div class="card-title">Ensemble AI ‚Äî Model Votes</div>
                <div class="neural-badge"><div class="neural-dot"></div>8 MODELS</div>
              </div>
              <div id="an-ensemble-result">
                <div style="text-align:center;color:var(--text-muted);font-size:12px;padding:12px">Select symbol to run ensemble analysis‚Ä¶</div>
              </div>
              <div class="model-panel" id="an-model-panel">
                <div class="model-row"><div class="model-name">Logistic Reg</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-lr" style="width:0%"></div></div><div class="model-vote" id="mv-lr">‚Äî</div><div class="model-acc" id="ma-lr">‚Äî</div></div>
                <div class="model-row"><div class="model-name">KNN (k=5)</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-knn" style="width:0%"></div></div><div class="model-vote" id="mv-knn">‚Äî</div><div class="model-acc" id="ma-knn">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Naive Bayes</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-nb" style="width:0%"></div></div><div class="model-vote" id="mv-nb">‚Äî</div><div class="model-acc" id="ma-nb">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Rand Forest</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-rf" style="width:0%"></div></div><div class="model-vote" id="mv-rf">‚Äî</div><div class="model-acc" id="ma-rf">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Grad Boost</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-gb" style="width:0%"></div></div><div class="model-vote" id="mv-gb">‚Äî</div><div class="model-acc" id="ma-gb">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Seq RNN</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-rnn" style="width:0%"></div></div><div class="model-vote" id="mv-rnn">‚Äî</div><div class="model-acc" id="ma-rnn">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Perceptron</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-per" style="width:0%"></div></div><div class="model-vote" id="mv-per">‚Äî</div><div class="model-acc" id="ma-per">‚Äî</div></div>
                <div class="model-row"><div class="model-name">Autocorr</div><div class="model-bar-wrap"><div class="model-bar-fill" id="mb-ac" style="width:0%"></div></div><div class="model-vote" id="mv-ac">‚Äî</div><div class="model-acc" id="ma-ac">‚Äî</div></div>
              </div>
              <div style="margin-top:10px">
                <div class="ensemble-label">Contract Type Scores</div>
                <div class="ct-scoring" id="an-ct-scores">
                  <div class="ct-score-row"><div class="ct-score-name">Rise</div><div class="ct-score-val" id="cts-call" style="color:var(--text-muted)">‚Äî</div></div>
                  <div class="ct-score-row"><div class="ct-score-name">Fall</div><div class="ct-score-val" id="cts-put" style="color:var(--text-muted)">‚Äî</div></div>
                  <div class="ct-score-row"><div class="ct-score-name">Rise =</div><div class="ct-score-val" id="cts-calle" style="color:var(--text-muted)">‚Äî</div></div>
                  <div class="ct-score-row"><div class="ct-score-name">Fall =</div><div class="ct-score-val" id="cts-pute" style="color:var(--text-muted)">‚Äî</div></div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-hdr"><div class="card-title">Pattern Statistics</div></div>
              <div id="an-pattern-stats" style="font-family:var(--font-mono);font-size:12px">
                <div style="text-align:center;color:var(--text-muted)">Collecting data‚Ä¶</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIVE TRADES PAGE -->
      <div class="page" id="page-active-trades">
        <div class="page-hdr">
          <div class="page-title"><span>ACTIVE TRADES</span> ‚Äî Open Positions</div>
          <div class="page-actions">
            <button class="btn btn-secondary btn-sm" onclick="refreshActiveTrades()">‚Üª Refresh</button>
          </div>
        </div>
        <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
          <div class="stat-card cyan"><div class="stat-label">Open Contracts</div><div class="stat-val cyan" id="at-count">0</div></div>
          <div class="stat-card green"><div class="stat-label">Running P&L</div><div class="stat-val green" id="at-pnl">0.00</div></div>
          <div class="stat-card orange"><div class="stat-label">Exposure</div><div class="stat-val orange" id="at-exposure">0.00</div></div>
          <div class="stat-card purple"><div class="stat-label">Avg Duration</div><div class="stat-val" id="at-dur">‚Äî</div></div>
        </div>
        <div id="active-trades-list">
          <div class="no-trades">
            <div class="icon">‚óé</div>
            <p>No active trades. Enable Auto Trade or execute signals manually.</p>
          </div>
        </div>
      </div>

      <!-- TRADE HISTORY PAGE -->
      <div class="page" id="page-trade-history">
        <div class="page-hdr">
          <div class="page-title"><span>TRADE HISTORY</span> ‚Äî Performance Log</div>
          <div class="page-actions">
            <button class="btn btn-secondary btn-sm" onclick="exportHistory()">‚Üì Export CSV</button>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-card green"><div class="stat-label">Total Profit</div><div class="stat-val green" id="hist-profit">0.00</div></div>
          <div class="stat-card red"><div class="stat-label">Total Loss</div><div class="stat-val red" id="hist-loss">0.00</div></div>
          <div class="stat-card purple"><div class="stat-label">Win Rate</div><div class="stat-val" id="hist-winrate">‚Äî</div></div>
          <div class="stat-card cyan"><div class="stat-label">Total Trades</div><div class="stat-val cyan" id="hist-total">0</div></div>
          <div class="stat-card orange"><div class="stat-label">Best Trade</div><div class="stat-val orange" id="hist-best">‚Äî</div></div>
          <div class="stat-card yellow"><div class="stat-label">Avg Stake</div><div class="stat-val" id="hist-avg-stake">‚Äî</div></div>
        </div>
        <div class="filter-row">
          <label>Symbol:</label>
          <select id="hist-sym-filter" onchange="renderHistory()">
            <option value="all">All Symbols</option>
          </select>
          <label>Type:</label>
          <select id="hist-type-filter" onchange="renderHistory()">
            <option value="all">All Types</option>
            <option value="CALL">Rise</option>
            <option value="PUT">Fall</option>
            <option value="CALLE">Rise Equals</option>
            <option value="PUTE">Fall Equals</option>
          </select>
          <label>Result:</label>
          <select id="hist-result-filter" onchange="renderHistory()">
            <option value="all">All Results</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="clearHistoryFilters()">‚úï Clear</button>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table class="data-table" id="history-table">
              <thead><tr><th>#</th><th>Symbol</th><th>Contract</th><th>Stake</th><th>Payout</th><th>P&L</th><th>Duration</th><th>Entry</th><th>Exit</th><th>Status</th><th>Time</th></tr></thead>
              <tbody id="history-tbody">
                <tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:40px">No trade history yet. Start trading to see results here.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SETTINGS PAGE -->
      <div class="page" id="page-settings">
        <div class="page-hdr">
          <div class="page-title"><span>SETTINGS</span> ‚Äî Configuration</div>
        </div>
        <div class="settings-tabs">
          <div class="stab active" onclick="showSettingsTab('trade')">‚öô Trade Parameters</div>
          <div class="stab" onclick="showSettingsTab('risk')">üõ° AI Risk Manager</div>
          <div class="stab" onclick="showSettingsTab('martingale')">üìà AI Martingale</div>
        </div>

        <!-- TRADE PARAMS TAB -->
        <div class="stab-content active" id="stab-trade">
          <div class="settings-group">
            <div class="settings-group-title">Symbols to Trade</div>
            <div class="sym-checkboxes" id="sym-checkboxes"></div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Contract Parameters</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Allowed Contract Types</label>
                <div style="display:flex;flex-direction:column;gap:6px;margin-top:4px">
                  <label class="checkbox-field"><input type="checkbox" id="ct-rise" checked/><span>Rise (CALL)</span></label>
                  <label class="checkbox-field"><input type="checkbox" id="ct-fall" checked/><span>Fall (PUT)</span></label>
                  <label class="checkbox-field"><input type="checkbox" id="ct-rise-eq"/><span>Rise Equals (CALLE)</span></label>
                  <label class="checkbox-field"><input type="checkbox" id="ct-fall-eq"/><span>Fall Equals (PUTE)</span></label>
                </div>
              </div>
              <div class="form-field">
                <label>Default Duration</label>
                <select id="cfg-duration">
                  <option value="1t">1 Tick</option>
                  <option value="2t">2 Ticks</option>
                  <option value="3t">3 Ticks</option>
                  <option value="5t" selected>5 Ticks</option>
                  <option value="10t">10 Ticks</option>
                  <option value="15t">15 Ticks</option>
                  <option value="30t">30 Ticks</option>
                  <option value="60s">60 Seconds</option>
                  <option value="120s">2 Minutes</option>
                  <option value="300s">5 Minutes</option>
                </select>
                <div class="hint">Default contract duration for auto trades</div>
              </div>
              <div class="form-field">
                <label>Base Stake (USD)</label>
                <input type="number" id="cfg-stake" value="1" min="0.35" step="0.01"/>
                <div class="hint">Minimum stake per contract</div>
              </div>
              <div class="form-field">
                <label>Min AI Confidence (%)</label>
                <input type="range" id="cfg-min-confidence" min="50" max="95" value="65" oninput="document.getElementById('conf-display').textContent=this.value+'%'"/>
                <div class="range-display" id="conf-display">65%</div>
                <div class="hint">Only trade signals above this confidence level</div>
              </div>
              <div class="form-field">
                <label>Signal Cooldown (seconds)</label>
                <input type="number" id="cfg-cooldown" value="30" min="5" max="300"/>
                <div class="hint">Wait time between trades on same symbol</div>
              </div>
              <div class="form-field">
                <label>Max Concurrent Trades</label>
                <input type="number" id="cfg-max-concurrent" value="5" min="1" max="20"/>
                <div class="hint">Maximum open positions at once</div>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">AI Engine Parameters</div>
            <div class="settings-row">
              <div class="form-field">
                <label>RSI Period</label>
                <input type="number" id="cfg-rsi-period" value="14" min="5" max="30"/>
              </div>
              <div class="form-field">
                <label>EMA Short Period</label>
                <input type="number" id="cfg-ema-short" value="5" min="3" max="20"/>
              </div>
              <div class="form-field">
                <label>EMA Medium Period</label>
                <input type="number" id="cfg-ema-med" value="10" min="5" max="50"/>
              </div>
              <div class="form-field">
                <label>EMA Long Period</label>
                <input type="number" id="cfg-ema-long" value="20" min="10" max="100"/>
              </div>
              <div class="form-field">
                <label>Tick History Depth</label>
                <select id="cfg-tick-depth">
                  <option value="50">50 ticks</option>
                  <option value="100" selected>100 ticks</option>
                  <option value="200">200 ticks</option>
                  <option value="500">500 ticks</option>
                </select>
              </div>
              <div class="form-field">
                <label>Signal Refresh (seconds)</label>
                <input type="number" id="cfg-sig-refresh" value="5" min="3" max="30"/>
              </div>
            </div>
          </div>
          <div class="save-row">
            <button class="btn btn-secondary" onclick="resetTradeSettings()">Reset Defaults</button>
            <button class="btn btn-primary" onclick="saveTradeSettings()">Save Trade Settings</button>
          </div>
        </div>

        <!-- RISK MANAGER TAB -->
        <div class="stab-content" id="stab-risk">
          <div class="settings-group">
            <div class="settings-group-title">Daily Loss Limits</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Max Daily Loss (USD)</label>
                <input type="number" id="cfg-max-daily-loss" value="50" min="1"/>
                <div class="hint">Stop trading when daily loss reaches this amount</div>
              </div>
              <div class="form-field">
                <label>Max Daily Loss (%)</label>
                <input type="number" id="cfg-max-daily-loss-pct" value="10" min="1" max="100"/>
                <div class="hint">Stop trading when this % of balance is lost</div>
              </div>
              <div class="form-field">
                <label>Daily Loss Action</label>
                <select id="cfg-daily-loss-action">
                  <option value="pause">Pause Auto Trading</option>
                  <option value="stop">Stop & Alert</option>
                  <option value="reduce">Reduce Stake by 50%</option>
                </select>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Trade Limits</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Max Trades Per Hour</label>
                <input type="number" id="cfg-max-per-hour" value="20" min="1" max="200"/>
              </div>
              <div class="form-field">
                <label>Max Trades Per Day</label>
                <input type="number" id="cfg-max-per-day" value="100" min="1" max="1000"/>
              </div>
              <div class="form-field">
                <label>Max Stake Per Trade (USD)</label>
                <input type="number" id="cfg-max-stake" value="100" min="1"/>
                <div class="hint">Hard cap on any single trade stake</div>
              </div>
              <div class="form-field">
                <label>Max Total Exposure (USD)</label>
                <input type="number" id="cfg-max-exposure" value="500" min="1"/>
                <div class="hint">Maximum total stake in open positions</div>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Consecutive Loss Protection</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Max Consecutive Losses</label>
                <input type="number" id="cfg-max-consec-loss" value="5" min="1" max="20"/>
                <div class="hint">Pause trading after N consecutive losses</div>
              </div>
              <div class="form-field">
                <label>Cooldown After Max Losses (min)</label>
                <input type="number" id="cfg-loss-cooldown" value="15" min="1" max="120"/>
              </div>
              <div class="form-field">
                <label>Recovery Mode</label>
                <select id="cfg-recovery-mode">
                  <option value="pause">Pause Trading</option>
                  <option value="reduce">Reduce to Base Stake</option>
                  <option value="skip">Skip Low Confidence</option>
                </select>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Risk Scoring Weights</div>
            <div class="settings-row">
              <div class="form-field">
                <label>RSI Weight (%)</label>
                <input type="range" id="w-rsi" min="0" max="100" value="25" oninput="document.getElementById('w-rsi-d').textContent=this.value+'%'"/>
                <div class="range-display" id="w-rsi-d">25%</div>
              </div>
              <div class="form-field">
                <label>EMA Weight (%)</label>
                <input type="range" id="w-ema" min="0" max="100" value="30" oninput="document.getElementById('w-ema-d').textContent=this.value+'%'"/>
                <div class="range-display" id="w-ema-d">30%</div>
              </div>
              <div class="form-field">
                <label>Momentum Weight (%)</label>
                <input type="range" id="w-mom" min="0" max="100" value="25" oninput="document.getElementById('w-mom-d').textContent=this.value+'%'"/>
                <div class="range-display" id="w-mom-d">25%</div>
              </div>
              <div class="form-field">
                <label>Pattern Weight (%)</label>
                <input type="range" id="w-pat" min="0" max="100" value="20" oninput="document.getElementById('w-pat-d').textContent=this.value+'%'"/>
                <div class="range-display" id="w-pat-d">20%</div>
              </div>
            </div>
          </div>
          <div class="save-row">
            <button class="btn btn-secondary" onclick="resetRiskSettings()">Reset Defaults</button>
            <button class="btn btn-primary" onclick="saveRiskSettings()">Save Risk Settings</button>
          </div>
        </div>

        <!-- MARTINGALE TAB -->
        <div class="stab-content" id="stab-martingale">
          <div class="settings-group">
            <div class="settings-group-title">Martingale Configuration</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Enable Martingale</label>
                <label class="checkbox-field" style="margin-top:8px">
                  <input type="checkbox" id="cfg-martingale-enabled"/>
                  <span>Enable AI Martingale System</span>
                </label>
                <div class="hint">Automatically adjust stake after losses to recover</div>
              </div>
              <div class="form-field">
                <label>Martingale Multiplier</label>
                <input type="number" id="cfg-mg-multiplier" value="2.0" min="1.1" max="5" step="0.1"/>
                <div class="hint">Stake multiplier after each loss (e.g. 2.0 = double)</div>
              </div>
              <div class="form-field">
                <label>Max Martingale Rounds</label>
                <input type="number" id="cfg-mg-rounds" value="4" min="1" max="10"/>
                <div class="hint">Maximum consecutive martingale steps</div>
              </div>
              <div class="form-field">
                <label>Reset After Win</label>
                <select id="cfg-mg-reset">
                  <option value="immediately">Immediately</option>
                  <option value="delay1">After 1 Confirmation Win</option>
                  <option value="delay2">After 2 Consecutive Wins</option>
                </select>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Advanced Martingale</div>
            <div class="settings-row">
              <div class="form-field">
                <label>Martingale Strategy</label>
                <select id="cfg-mg-strategy">
                  <option value="classic">Classic (Always Double)</option>
                  <option value="adaptive">Adaptive (Based on Confidence)</option>
                  <option value="fibonacci">Fibonacci Sequence</option>
                  <option value="dalembert">D'Alembert (Linear)</option>
                </select>
                <div class="hint">Algorithm for stake progression</div>
              </div>
              <div class="form-field">
                <label>Max Martingale Stake (USD)</label>
                <input type="number" id="cfg-mg-max-stake" value="256" min="1"/>
                <div class="hint">Hard cap on martingale stake (safety limit)</div>
              </div>
              <div class="form-field">
                <label>Min Confidence for Martingale</label>
                <input type="range" id="cfg-mg-min-conf" min="50" max="95" value="60" oninput="document.getElementById('mg-conf-d').textContent=this.value+'%'"/>
                <div class="range-display" id="mg-conf-d">60%</div>
                <div class="hint">Only apply martingale when confidence meets threshold</div>
              </div>
              <div class="form-field">
                <label>Apply Martingale Only When</label>
                <select id="cfg-mg-apply-when">
                  <option value="same-symbol">Same symbol as last loss</option>
                  <option value="same-type">Same contract type</option>
                  <option value="any">Any next trade</option>
                </select>
              </div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Martingale State</div>
            <div class="stats-row" style="grid-template-columns:repeat(5,1fr)">
              <div class="stat-card cyan"><div class="stat-label">Current Round</div><div class="stat-val cyan" id="mg-round">0</div></div>
              <div class="stat-card orange"><div class="stat-label">Current Stake</div><div class="stat-val orange" id="mg-stake">‚Äî</div></div>
              <div class="stat-card red"><div class="stat-label">Consec. Losses</div><div class="stat-val red" id="mg-losses">0</div></div>
              <div class="stat-card green"><div class="stat-label">Recovery Target</div><div class="stat-val green" id="mg-target">‚Äî</div></div>
              <div class="stat-card yellow"><div class="stat-label">Status</div><div class="stat-val" id="mg-status" style="font-size:13px;font-family:var(--font-display);letter-spacing:1px">IDLE</div></div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="resetMartingale()" style="margin-top:8px">‚Ü∫ Reset Martingale State</button>
          </div>
          <div class="save-row">
            <button class="btn btn-secondary" onclick="resetMartingaleSettings()">Reset Defaults</button>
            <button class="btn btn-primary" onclick="saveMartingaleSettings()">Save Martingale Settings</button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SYMBOLS = [
  {id:'R_10',name:'Volatility 10',short:'V10'},
  {id:'R_25',name:'Volatility 25',short:'V25'},
  {id:'R_50',name:'Volatility 50',short:'V50'},
  {id:'R_75',name:'Volatility 75',short:'V75'},
  {id:'R_100',name:'Volatility 100',short:'V100'},
  {id:'1HZ10V',name:'Volatility 10 (1s)',short:'V10 1s'},
  {id:'1HZ25V',name:'Volatility 25 (1s)',short:'V25 1s'},
  {id:'1HZ50V',name:'Volatility 50 (1s)',short:'V50 1s'},
  {id:'1HZ75V',name:'Volatility 75 (1s)',short:'V75 1s'},
  {id:'1HZ100V',name:'Volatility 100 (1s)',short:'V100 1s'},
  {id:'BOOM500',name:'Boom 500',short:'BOOM500'},
  {id:'BOOM1000',name:'Boom 1000',short:'BOOM1000'},
  {id:'CRASH500',name:'Crash 500',short:'CRASH500'},
  {id:'CRASH1000',name:'Crash 1000',short:'CRASH1000'},
  {id:'stpRNG',name:'Step Index',short:'STEP'},
  {id:'JD10',name:'Jump 10',short:'JD10'},
  {id:'JD25',name:'Jump 25',short:'JD25'},
  {id:'JD50',name:'Jump 50',short:'JD50'},
  {id:'JD75',name:'Jump 75',short:'JD75'},
  {id:'JD100',name:'Jump 100',short:'JD100'},
];

const CONTRACT_TYPES = {
  CALL:'Rise', PUT:'Fall', CALLE:'Rise Equals', PUTE:'Fall Equals'
};

const state = {
  ws: null, wsReady: false, reconnectTimer: null, reconnectCount: 0, maxReconnect: 10,
  pingInterval: null, authToken: null, appId: '1089', server: '',
  account: null, balance: 0, currency: 'USD',
  ticks: {}, // symbol -> [{price, epoch, direction}]
  sparklines: {}, // symbol -> chart instance
  mwSparklines: {},
  activeTrades: {}, // contract_id -> trade obj
  tradeHistory: [], // all past trades
  signals: {}, // symbol -> signal obj
  analyticsSymbol: null,
  charts: { priceChart: null, rsiChart: null, momChart: null, pnlChart: null },
  lastTradeTime: {}, // symbol -> ms
  autoTrade: false,
  autoInterval: null,
  signalInterval: null,
  consecutiveLosses: 0,
  martingaleRound: 0,
  martingaleStake: null,
  dailyPnL: 0, dailyTrades: 0, dailyWins: 0,
  sessionStart: Date.now(),
  subscribed: new Set(),
  pendingBuys: new Map(), // req_id -> trade info
  settings: {
    trade: {
      symbols: ['R_10','R_25','R_50','R_75','R_100','1HZ10V','1HZ25V','1HZ50V','1HZ75V','1HZ100V'],
      contractTypes: ['CALL','PUT'],
      duration: '5t', stake: 1, minConfidence: 65,
      cooldown: 30, maxConcurrent: 5,
      rsiPeriod: 14, emaShort: 5, emaMed: 10, emaLong: 20,
      tickDepth: 100, sigRefresh: 5,
    },
    risk: {
      maxDailyLoss: 50, maxDailyLossPct: 10, dailyLossAction: 'pause',
      maxPerHour: 20, maxPerDay: 100, maxStake: 100, maxExposure: 500,
      maxConsecLoss: 5, lossCooldown: 15, recoveryMode: 'pause',
      wRsi: 25, wEma: 30, wMom: 25, wPat: 20,
    },
    martingale: {
      enabled: false, multiplier: 2.0, maxRounds: 4, reset: 'immediately',
      strategy: 'classic', maxStake: 256, minConf: 60, applyWhen: 'same-symbol',
    }
  },
  reqId: 1,
  pausedUntil: 0,
};

let lastBestSignalSym = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ENGINE ‚Äî Technical Analysis
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AI = {
  ema(prices, period) {
    if (prices.length < period) return null;
    const k = 2 / (period + 1);
    let ema = prices.slice(0, period).reduce((a,b) => a+b, 0) / period;
    for (let i = period; i < prices.length; i++) ema = prices[i] * k + ema * (1 - k);
    return ema;
  },
  rsi(prices, period = 14) {
    if (prices.length < period + 1) return 50;
    const changes = prices.slice(-period-1).slice(1).map((p,i) => p - prices.slice(-period-1)[i]);
    const gains = changes.filter(c => c > 0);
    const losses = changes.filter(c => c < 0).map(c => Math.abs(c));
    const avgGain = gains.length ? gains.reduce((a,b)=>a+b,0)/period : 0;
    const avgLoss = losses.length ? losses.reduce((a,b)=>a+b,0)/period : 0;
    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  },
  momentum(prices, period = 10) {
    if (prices.length < period) return 0;
    return ((prices[prices.length-1] - prices[prices.length-period]) / prices[prices.length-period]) * 100;
  },
  volatility(prices, period = 20) {
    if (prices.length < period) return 0;
    const slice = prices.slice(-period);
    const mean = slice.reduce((a,b)=>a+b,0)/period;
    const variance = slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/period;
    return Math.sqrt(variance);
  },
  streak(ticks) {
    if (!ticks || ticks.length < 2) return {count:0, dir:'none'};
    let count = 0; const dir = ticks[ticks.length-1].direction;
    for (let i = ticks.length-1; i >= 0; i--) {
      if (ticks[i].direction === dir) count++; else break;
    }
    return {count, dir};
  },
  patternScore(ticks) {
    // Analyze last 20 ticks for pattern bias
    if (!ticks || ticks.length < 10) return {score:0, bias:'neutral'};
    const last = ticks.slice(-20);
    const ups = last.filter(t => t.direction === 'up').length;
    const downs = last.filter(t => t.direction === 'down').length;
    const bias = ups > downs ? 'bullish' : downs > ups ? 'bearish' : 'neutral';
    const score = Math.abs(ups - downs) / last.length; // 0-1
    return {score, bias, ups, downs};
  },
  generateSignal(symbol) {
    const ticks = state.ticks[symbol];
    const s = state.settings;
    const cfg = s.trade;
    const weights = s.risk;

    if (!ticks || ticks.length < 30) return null;
    const prices = ticks.map(t => t.price);

    const rsi = AI.rsi(prices, cfg.rsiPeriod);
    const ema5 = AI.ema(prices, cfg.emaShort);
    const ema10 = AI.ema(prices, cfg.emaMed);
    const ema20 = AI.ema(prices, cfg.emaLong);
    const mom = AI.momentum(prices, 10);
    const vol = AI.volatility(prices, 20);
    const streak = AI.streak(ticks);
    const pattern = AI.patternScore(ticks);
    const price = prices[prices.length-1];

    // RSI signal: oversold -> CALL, overbought -> PUT
    let rsiSignal = 0; // -1 bear, +1 bull
    if (rsi < 30) rsiSignal = 1;
    else if (rsi < 40) rsiSignal = 0.6;
    else if (rsi > 70) rsiSignal = -1;
    else if (rsi > 60) rsiSignal = -0.6;
    else rsiSignal = 0;

    // EMA signal
    let emaSignal = 0;
    if (ema5 && ema10 && ema20) {
      if (ema5 > ema10 && ema10 > ema20) emaSignal = 1;
      else if (ema5 < ema10 && ema10 < ema20) emaSignal = -1;
      else if (ema5 > ema10) emaSignal = 0.5;
      else emaSignal = -0.5;
    }

    // Momentum signal
    const momSignal = Math.max(-1, Math.min(1, mom / 0.05));

    // Pattern signal
    let patSignal = 0;
    if (pattern.bias === 'bullish') patSignal = pattern.score;
    else if (pattern.bias === 'bearish') patSignal = -pattern.score;

    // Streak reversal logic: long streaks often reverse
    let streakBonus = 0;
    if (streak.count >= 5) {
      streakBonus = streak.dir === 'up' ? -0.3 : 0.3; // contrarian
    }

    // Weighted aggregate signal
    const wTotal = weights.wRsi + weights.wEma + weights.wMom + weights.wPat;
    const aggSignal = (
      rsiSignal * (weights.wRsi/wTotal) +
      emaSignal * (weights.wEma/wTotal) +
      momSignal * (weights.wMom/wTotal) +
      patSignal * (weights.wPat/wTotal) +
      streakBonus * 0.1
    );

    // ‚îÄ‚îÄ ENSEMBLE ML LAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Run all 8 models and get weighted consensus
    const ensResult = EnsembleML.predict(symbol);
    
    let cappedConf, finalContractType, finalDirection;
    
    if (ensResult) {
      // Blend classic AI score with ensemble for robustness
      const classicScore = aggSignal; // -1 to +1
      const ensScore = ensResult.ensembleScore;
      // Give 40% weight to classic indicators, 60% to ensemble
      const blendedScore = classicScore * 0.4 + ensScore * 0.6;
      
      // Confidence: use ensemble confidence + classic reinforcement
      const classicRawConf = Math.abs(aggSignal);
      const ensConf = ensResult.confidence;
      const blendedConf = Math.round(ensConf * 0.65 + (50 + classicRawConf * 40) * 0.35);
      cappedConf = Math.min(97, Math.max(50, blendedConf));
      
      // Direction: use blended score
      finalDirection = blendedScore >= 0 ? 'RISE' : 'FALL';
      
      // Contract type: use ensemble CT scoring overlaid with volatility logic
      const isBull = blendedScore > 0;
      const allowedTypes = cfg.contractTypes;
      
      // Pick best scoring allowed type
      const ctScores = ensResult.ctScores;
      const rankedAllowed = Object.entries(ctScores)
        .filter(([ct]) => allowedTypes.includes(ct))
        .sort((a,b) => b[1]-a[1]);
      
      if (rankedAllowed.length > 0) {
        finalContractType = rankedAllowed[0][0];
      } else {
        // Fallback to classic logic
        if (vol < 0.01) {
          finalContractType = isBull && allowedTypes.includes('CALLE') ? 'CALLE'
            : !isBull && allowedTypes.includes('PUTE') ? 'PUTE'
            : isBull && allowedTypes.includes('CALL') ? 'CALL'
            : allowedTypes.includes('PUT') ? 'PUT' : allowedTypes[0];
        } else {
          finalContractType = isBull && allowedTypes.includes('CALL') ? 'CALL'
            : !isBull && allowedTypes.includes('PUT') ? 'PUT'
            : isBull && allowedTypes.includes('CALLE') ? 'CALLE'
            : allowedTypes.length ? allowedTypes[0] : 'CALL';
        }
      }
      
      // Save predictions for online learning accuracy tracking
      if (ensResult.modelResults) {
        EnsembleML._savePredictionsForTracking(symbol, ensResult.modelResults);
      }
    } else {
      // No ensemble (insufficient ticks) ‚Äî fall back to classic
      const rawConf = Math.abs(aggSignal);
      cappedConf = Math.min(97, Math.max(50, Math.round(50 + rawConf * 45)));
      finalDirection = aggSignal >= 0 ? 'RISE' : 'FALL';
      const isBull = aggSignal > 0;
      const allowedTypes = cfg.contractTypes;
      if (vol < 0.01) {
        finalContractType = isBull && allowedTypes.includes('CALLE') ? 'CALLE'
          : !isBull && allowedTypes.includes('PUTE') ? 'PUTE'
          : isBull && allowedTypes.includes('CALL') ? 'CALL'
          : allowedTypes.includes('PUT') ? 'PUT' : allowedTypes[0];
      } else {
        finalContractType = isBull && allowedTypes.includes('CALL') ? 'CALL'
          : !isBull && allowedTypes.includes('PUT') ? 'PUT'
          : isBull && allowedTypes.includes('CALLE') ? 'CALLE'
          : allowedTypes.length ? allowedTypes[0] : 'CALL';
      }
    }

    // Recommended duration based on volatility
    let duration = cfg.duration;
    if (vol > 0.05) duration = '3t';
    else if (vol < 0.01) duration = '10t';

    const symInfo = SYMBOLS.find(s => s.id === symbol) || {name: symbol};

    return {
      symbol, symName: symInfo.name, contractType: finalContractType,
      confidence: cappedConf, direction: finalDirection,
      price, rsi, ema5, ema10, ema20, momentum: mom, volatility: vol,
      streak, pattern, rsiSignal, emaSignal, momSignal, patSignal,
      aggSignal, duration, timestamp: Date.now(),
      stake: AI.computeStake(symbol, cappedConf),
      ensResult, // full ensemble result attached
    };
  },
  computeStake(symbol, confidence) {
    const cfg = state.settings;
    let stake = cfg.trade.stake;
    // Apply martingale if enabled and in recovery
    if (cfg.martingale.enabled && state.martingaleRound > 0) {
      const mg = cfg.martingale;
      let mgStake = stake;
      if (mg.strategy === 'classic') {
        mgStake = stake * Math.pow(mg.multiplier, state.martingaleRound);
      } else if (mg.strategy === 'fibonacci') {
        const fibs = [1,1,2,3,5,8,13,21,34];
        mgStake = stake * (fibs[Math.min(state.martingaleRound, fibs.length-1)]);
      } else if (mg.strategy === 'dalembert') {
        mgStake = stake + (state.martingaleRound * stake * 0.5);
      } else { // adaptive
        const confBonus = (confidence - 60) / 40; // 0-1
        mgStake = stake * (1 + state.martingaleRound * mg.multiplier * confBonus);
      }
      stake = Math.min(mgStake, mg.maxStake, cfg.risk.maxStake);
    }
    return Math.max(0.35, Math.round(stake * 100) / 100);
  },
  allSignals() {
    const cfg = state.settings.trade;
    const results = [];
    for (const sym of cfg.symbols) {
      const sig = AI.generateSignal(sym);
      if (sig) { state.signals[sym] = sig; results.push(sig); }
    }
    return results.sort((a,b) => b.confidence - a.confidence);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RISK MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RiskManager = {
  canTrade(signal) {
    const r = state.settings.risk;
    const now = Date.now();

    if (now < state.pausedUntil) {
      toast('Risk Manager: Trading paused (cooldown)', 'warn'); return false;
    }
    if (Math.abs(state.dailyPnL) >= r.maxDailyLoss && state.dailyPnL < 0) {
      this.triggerDailyLossAction(); return false;
    }
    if (state.balance > 0 && Math.abs(state.dailyPnL) / state.balance * 100 >= r.maxDailyLossPct && state.dailyPnL < 0) {
      this.triggerDailyLossAction(); return false;
    }
    if (state.dailyTrades >= r.maxPerDay) {
      toast('Risk Manager: Daily trade limit reached', 'warn'); return false;
    }
    if (state.consecutiveLosses >= r.maxConsecLoss) {
      state.pausedUntil = now + r.lossCooldown * 60000;
      toast(`Risk Manager: ${r.maxConsecLoss} consecutive losses! Pausing ${r.lossCooldown}min`, 'error');
      return false;
    }
    const totalExposure = Object.values(state.activeTrades).reduce((s,t) => s+t.stake, 0);
    if (totalExposure + signal.stake > r.maxExposure) {
      toast('Risk Manager: Max exposure reached', 'warn'); return false;
    }
    if (Object.keys(state.activeTrades).length >= state.settings.trade.maxConcurrent) {
      return false;
    }
    const lastTrade = state.lastTradeTime[signal.symbol] || 0;
    if (now - lastTrade < state.settings.trade.cooldown * 1000) return false;
    if (signal.confidence < state.settings.trade.minConfidence) return false;
    return true;
  },
  triggerDailyLossAction() {
    const action = state.settings.risk.dailyLossAction;
    if (action === 'pause') {
      state.autoTrade = false;
      document.getElementById('autoTradeToggle').checked = false;
      updateAutoStatus();
      toast('Risk Manager: Daily loss limit hit! Auto trade PAUSED', 'error');
    } else if (action === 'reduce') {
      state.settings.trade.stake = Math.max(0.35, state.settings.trade.stake * 0.5);
      toast('Risk Manager: Daily loss limit! Stake reduced 50%', 'warn');
    } else {
      state.autoTrade = false; updateAutoStatus();
      toast('Risk Manager: STOP ‚Äî Daily loss limit reached!', 'error');
    }
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENSEMBLE ML ENGINE ‚Äî 8 Models, Online Learning, Per-Contract Scoring
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EnsembleML = {
  // Model registry: weight adapts based on recent accuracy
  models: {
    lr:  { name:'Logistic Reg',  w:1.0, correct:0, total:0, lastPred:{} },
    knn: { name:'KNN (k=5)',     w:1.0, correct:0, total:0, lastPred:{} },
    nb:  { name:'Naive Bayes',   w:1.0, correct:0, total:0, lastPred:{} },
    rf:  { name:'Rand Forest',   w:1.0, correct:0, total:0, lastPred:{} },
    gb:  { name:'Grad Boost',    w:1.0, correct:0, total:0, lastPred:{} },
    rnn: { name:'Seq RNN',       w:1.0, correct:0, total:0, lastPred:{} },
    per: { name:'Perceptron',    w:1.0, correct:0, total:0, lastPred:{} },
    ac:  { name:'Autocorr',      w:1.0, correct:0, total:0, lastPred:{} },
  },

  // Per-symbol KNN store: array of {features, outcome} with max 500 records
  knnStore: {},

  // Naive Bayes frequency tables per symbol: {patternKey -> {up:0, down:0}}
  nbTable: {},

  // Perceptron weights (12 inputs + bias): initialized with slight random noise
  perWeights: null,
  perHidden: null,

  // RNN hidden state per symbol
  rnnHidden: {},

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // FEATURE EXTRACTION  (returns 12-dim vector)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  extractFeatures(ticks, prices, cfg) {
    if (!ticks || prices.length < 25) return null;
    const period = cfg.rsiPeriod || 14;
    const n = prices.length;

    // Ratios of up ticks over windows
    const last5  = ticks.slice(-5);
    const last10 = ticks.slice(-10);
    const last20 = ticks.slice(-20);
    const upR5  = last5.filter(t=>t.direction==='up').length  / 5;
    const upR10 = last10.filter(t=>t.direction==='up').length / 10;
    const upR20 = last20.filter(t=>t.direction==='up').length / 20;

    // RSI normalized [0,1]
    const rsi = AI.rsi(prices, period) / 100;

    // Momentum (short/med) ‚Äî clip to [-1,1]
    const clip = v => Math.max(-1, Math.min(1, v));
    const mom5  = clip(AI.momentum(prices.slice(-6), 5) / 0.1);
    const mom10 = clip(AI.momentum(prices.slice(-11), 10) / 0.1);

    // EMA alignment score: +1 bullish stack, -1 bearish, 0 mixed
    const ema5  = AI.ema(prices, cfg.emaShort || 5);
    const ema10 = AI.ema(prices, cfg.emaMed   || 10);
    const ema20 = AI.ema(prices, cfg.emaLong  || 20);
    let emaAlign = 0;
    if (ema5 && ema10 && ema20) {
      if (ema5>ema10 && ema10>ema20) emaAlign=1;
      else if (ema5<ema10 && ema10<ema20) emaAlign=-1;
      else if (ema5>ema10) emaAlign=0.5;
      else emaAlign=-0.5;
    }

    // Volatility normalized to [0,1] against 0.1 cap
    const vol = Math.min(1, AI.volatility(prices, 20) / 0.1);

    // Streak: length normalized + direction
    const streak = AI.streak(ticks);
    const streakLen = Math.min(1, streak.count / 10);
    const streakDir = streak.dir==='up' ? 1 : streak.dir==='down' ? -1 : 0;

    // Price position in last 20-tick range [0,1]
    const hi = Math.max(...prices.slice(-20));
    const lo = Math.min(...prices.slice(-20));
    const range = hi - lo || 0.0001;
    const pricePos = (prices[n-1] - lo) / range;

    // Pattern byte: last 8 tick directions as 8-bit integer, normalized [0,1]
    const last8 = ticks.slice(-8);
    let patByte = 0;
    last8.forEach((t,i) => { if(t.direction==='up') patByte |= (1<<i); });
    const patNorm = patByte / 255;

    return [upR5, upR10, upR20, rsi, mom5, mom10, emaAlign, vol, streakLen, streakDir, pricePos, patNorm];
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 1. LOGISTIC REGRESSION
  //    Sigmoid on weighted feature sum. Weights adapts with stochastic gradient.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  lrWeights: null,
  lrLR: 0.01,

  _initLR() {
    if (!this.lrWeights) {
      // Initialize: bias + 12 features = 13 weights
      this.lrWeights = Array.from({length:13}, (_,i) => {
        // Hand-tuned priors: upRatio5,10,20 positive; rsi: if >0.5 bear
        const priors = [0.8,0.6,0.4,-0.3,0.5,0.3,0.4,-0.2,0.0,0.3,0.2,0.1,0.0];
        return priors[i] + (Math.random()-0.5)*0.05;
      });
    }
  },

  sigmoid(x) { return 1 / (1 + Math.exp(-x)); },

  predictLR(features) {
    this._initLR();
    const w = this.lrWeights;
    let z = w[0]; // bias
    features.forEach((f,i) => { z += w[i+1]*f; });
    const prob = this.sigmoid(z);
    // prob > 0.5 ‚Üí RISE
    return { dir: prob > 0.5 ? 1 : -1, conf: Math.abs(prob - 0.5) * 2 };
  },

  _updateLR(features, actual) { // actual: 1=up, -1=down
    this._initLR();
    const w = this.lrWeights;
    let z = w[0];
    features.forEach((f,i) => { z += w[i+1]*f; });
    const pred = this.sigmoid(z);
    const target = actual > 0 ? 1 : 0;
    const err = pred - target;
    w[0] -= this.lrLR * err;
    features.forEach((f,i) => { w[i+1] -= this.lrLR * err * f; });
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 2. K-NEAREST NEIGHBORS (k=5)
  //    Euclidean distance on feature vectors stored per symbol.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  predictKNN(features, symbol) {
    const store = this.knnStore[symbol] || [];
    if (store.length < 10) return { dir: 0, conf: 0 };
    const k = Math.min(5, store.length);
    // Compute distances
    const dists = store.map(rec => ({
      d: features.reduce((s,f,i) => s + Math.pow(f - rec.f[i], 2), 0),
      o: rec.o
    })).sort((a,b)=>a.d-b.d).slice(0, k);
    const votes = dists.reduce((s,r) => s + r.o, 0);
    const conf = Math.abs(votes) / k;
    return { dir: votes > 0 ? 1 : votes < 0 ? -1 : 0, conf };
  },

  _storeKNN(symbol, features, outcome) { // outcome: 1 or -1
    if (!this.knnStore[symbol]) this.knnStore[symbol] = [];
    const store = this.knnStore[symbol];
    store.push({ f: [...features], o: outcome });
    if (store.length > 500) store.shift();
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 3. NAIVE BAYES
  //    Pattern key from top 6 binary features. P(Up|pattern) vs P(Down|pattern).
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  predictNB(features, symbol) {
    // Key = binary string of: upR5>0.5, upR10>0.5, rsi>0.5, mom5>0, emaAlign>0, streakDir>0
    const key = [
      features[0]>0.5?'1':'0',
      features[1]>0.5?'1':'0',
      features[3]>0.5?'1':'0',
      features[4]>0?'1':'0',
      features[6]>0?'1':'0',
      features[9]>0?'1':'0',
    ].join('');
    const tbl = (this.nbTable[symbol] || {})[key];
    if (!tbl) return { dir: 0, conf: 0 };
    const total = tbl.up + tbl.dn;
    if (total < 3) return { dir: 0, conf: 0 };
    const pUp = (tbl.up + 1) / (total + 2); // Laplace smoothing
    return { dir: pUp > 0.5 ? 1 : -1, conf: Math.abs(pUp - 0.5) * 2 };
  },

  _updateNB(symbol, features, outcome) {
    const key = [
      features[0]>0.5?'1':'0',
      features[1]>0.5?'1':'0',
      features[3]>0.5?'1':'0',
      features[4]>0?'1':'0',
      features[6]>0?'1':'0',
      features[9]>0?'1':'0',
    ].join('');
    if (!this.nbTable[symbol]) this.nbTable[symbol] = {};
    if (!this.nbTable[symbol][key]) this.nbTable[symbol][key] = {up:0,dn:0};
    if (outcome > 0) this.nbTable[symbol][key].up++;
    else this.nbTable[symbol][key].dn++;
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 4. RANDOM FOREST (8 decision stumps with random feature subsets)
  //    Each stump picks 1 feature, applies a threshold, votes.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _rfStumps: null,

  _initRF() {
    if (this._rfStumps) return;
    // Pre-defined stumps: [featureIdx, threshold, direction_if_above]
    this._rfStumps = [
      [0,  0.6,  1],  // upRatio5 > 0.6 ‚Üí RISE
      [1,  0.5,  1],  // upRatio10 > 0.5 ‚Üí RISE
      [3,  0.7, -1],  // RSI > 0.7 ‚Üí overbought ‚Üí FALL
      [3,  0.3,  1],  // RSI < 0.3 ‚Üí oversold ‚Üí RISE (inverted below)
      [4,  0.3,  1],  // mom5 > 0.3 ‚Üí RISE
      [6,  0.4,  1],  // emaAlign > 0.4 ‚Üí RISE
      [9,  0.5,  1],  // streakDir > 0 ‚Üí RISE (might reverse)
      [10, 0.7,  1],  // pricePos > 0.7 ‚Üí nearing high ‚Üí could FALL
      [2,  0.5,  1],  // upRatio20 > 0.5 ‚Üí RISE
      [5,  0.2,  1],  // mom10 > 0.2 ‚Üí RISE
    ];
  },

  predictRF(features) {
    this._initRF();
    let votes = 0;
    for (const [fi, thr, dir] of this._rfStumps) {
      const val = features[fi];
      // stump 3 is inverted: if RSI < 0.3 ‚Üí RISE
      if (fi===3 && thr===0.3) { votes += val < thr ? dir : -dir; }
      // stump 7: high price position ‚Üí mean-reverting ‚Üí FALL
      else if (fi===10) { votes += val > thr ? -dir : dir; }
      else { votes += val > thr ? dir : -dir; }
    }
    const conf = Math.abs(votes) / this._rfStumps.length;
    return { dir: votes > 0 ? 1 : -1, conf };
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 5. GRADIENT BOOSTING (5 additive weak learners)
  //    Each learner corrects residuals of previous.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _gbTrees: null,

  _initGB() {
    if (this._gbTrees) return;
    // Weak learners: [featureIdx, threshold, leafVal_pos, leafVal_neg]
    // Each returns a small real value (regression stumps combined)
    this._gbTrees = [
      { fi:1, thr:0.5, lp:0.3, ln:-0.3 },  // upRatio10
      { fi:4, thr:0.1, lp:0.2, ln:-0.2 },  // momentum5
      { fi:6, thr:0.0, lp:0.25,ln:-0.25 }, // emaAlign
      { fi:3, thr:0.5, lp:-0.15,ln:0.15 }, // RSI (inverted)
      { fi:2, thr:0.5, lp:0.2, ln:-0.2 },  // upRatio20
    ];
  },

  predictGB(features) {
    this._initGB();
    const lr = 0.8;
    let score = 0;
    for (const t of this._gbTrees) {
      score += (features[t.fi] > t.thr ? t.lp : t.ln) * lr;
    }
    const prob = this.sigmoid(score * 2);
    return { dir: prob > 0.5 ? 1 : -1, conf: Math.abs(prob-0.5)*2 };
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 6. SEQUENTIAL RNN (Elman-style, hidden state per symbol)
  //    h_t = tanh(W_h * h_{t-1} + W_x * x_t + b)
  //    y = sigmoid(V * h_t)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _rnnWh: null, _rnnWx: null, _rnnWv: null, _rnnB: null,
  _hiddenDim: 6,

  _initRNN() {
    if (this._rnnWh) return;
    const H = this._hiddenDim;
    // Weight matrices: simplified as flat arrays
    // W_h: H√óH, W_x: H√ó4 (use 4 key features), V: H‚Üí1
    const rand = () => (Math.random()-0.5)*0.2;
    this._rnnWh = Array.from({length:H*H}, rand);
    this._rnnWx = Array.from({length:H*4},  rand);
    this._rnnWv = Array.from({length:H},     rand);
    this._rnnB  = Array.from({length:H},     () => 0.01);
  },

  _rnnStep(hidden, x4) { // x4: 4 key features
    this._initRNN();
    const H = this._hiddenDim;
    const newH = Array(H).fill(0);
    for (let h=0; h<H; h++) {
      let val = this._rnnB[h];
      // Recurrent
      for (let j=0; j<H; j++) val += this._rnnWh[h*H+j] * hidden[j];
      // Input
      for (let j=0; j<4; j++) val += this._rnnWx[h*4+j] * x4[j];
      newH[h] = Math.tanh(val);
    }
    return newH;
  },

  predictRNN(features, symbol) {
    this._initRNN();
    const H = this._hiddenDim;
    if (!this.rnnHidden[symbol]) this.rnnHidden[symbol] = Array(H).fill(0);
    // Use 4 core features: upR10, rsi, mom5, emaAlign
    const x4 = [features[1], features[3], features[4], features[6]];
    const newH = this._rnnStep(this.rnnHidden[symbol], x4);
    this.rnnHidden[symbol] = newH;
    let out = 0;
    for (let h=0; h<H; h++) out += this._rnnWv[h] * newH[h];
    const prob = this.sigmoid(out);
    return { dir: prob > 0.5 ? 1 : -1, conf: Math.abs(prob-0.5)*2 };
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 7. PERCEPTRON (1-layer neural net, 12‚Üí8‚Üí1)
  //    Two-layer MLP with tanh activation, adaptive via backprop.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _initPerceptron() {
    if (this.perWeights) return;
    const rand = () => (Math.random()-0.5)*0.3;
    // 12 inputs ‚Üí 8 hidden ‚Üí 1 output (bias included as extra input +1)
    this.perWeights = {
      w1: Array.from({length:13*8}, rand), // [in+bias x hidden]
      w2: Array.from({length:9},    rand), // [hidden+bias ‚Üí output]
    };
  },

  _mlpForward(features) {
    this._initPerceptron();
    const inp = [...features, 1]; // +bias
    // Hidden layer
    const hidden = Array(8).fill(0).map((_,h) => {
      let z = 0;
      inp.forEach((x,i) => { z += this.perWeights.w1[h*13+i]*x; });
      return Math.tanh(z);
    });
    // Output
    const hidBias = [...hidden, 1];
    let out = 0;
    hidBias.forEach((x,i) => { out += this.perWeights.w2[i]*x; });
    return { out, hidden: hidBias };
  },

  predictPerceptron(features) {
    const { out } = this._mlpForward(features);
    const prob = this.sigmoid(out);
    return { dir: prob > 0.5 ? 1 : -1, conf: Math.abs(prob-0.5)*2 };
  },

  _updatePerceptron(features, actual) { // actual: 1 or -1
    const target = actual > 0 ? 1 : 0;
    const { out, hidden } = this._mlpForward(features);
    const prob = this.sigmoid(out);
    const err2 = prob - target;
    const lr = 0.005;
    // Backprop output layer
    hidden.forEach((x,i) => { this.perWeights.w2[i] -= lr * err2 * x; });
    // Backprop hidden layer
    const inp = [...features, 1];
    for (let h=0; h<8; h++) {
      const dHidden = err2 * this.perWeights.w2[h] * (1 - hidden[h]*hidden[h]); // tanh deriv
      inp.forEach((x,i) => { this.perWeights.w1[h*13+i] -= lr * dHidden * x; });
    }
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 8. AUTOCORRELATION MODEL
  //    Tests if price returns are positively (momentum) or negatively
  //    (mean-reversion) autocorrelated at lags 1,2,3.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  predictAutocorr(prices) {
    if (prices.length < 20) return { dir: 0, conf: 0 };
    const returns = [];
    for (let i=1; i<prices.length; i++) returns.push(prices[i]-prices[i-1]);
    const mean = returns.reduce((a,b)=>a+b,0) / returns.length;
    // Compute autocorrelation at lag 1,2,3
    let ac1=0, ac2=0, ac3=0, denom=0;
    returns.forEach(r => denom += (r-mean)**2);
    if (denom===0) return { dir:0, conf:0 };
    for (let i=1; i<returns.length; i++) ac1 += (returns[i]-mean)*(returns[i-1]-mean);
    for (let i=2; i<returns.length; i++) ac2 += (returns[i]-mean)*(returns[i-2]-mean);
    for (let i=3; i<returns.length; i++) ac3 += (returns[i]-mean)*(returns[i-3]-mean);
    ac1/=denom; ac2/=denom; ac3/=denom;
    const lastReturn = returns[returns.length-1];
    // Positive autocorr ‚Üí momentum (last direction continues)
    // Negative autocorr ‚Üí mean reversion (last direction reverses)
    const acScore = (ac1 + ac2*0.5 + ac3*0.25) / 1.75;
    let dir = 0, conf = 0;
    if (Math.abs(acScore) > 0.05) {
      const momentum = lastReturn > 0; // did price go up last tick?
      if (acScore > 0) { dir = momentum ? 1 : -1; }  // momentum
      else             { dir = momentum ? -1 : 1; }   // mean-reversion
      conf = Math.min(1, Math.abs(acScore) * 5);
    }
    return { dir, conf };
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // CONTRACT-TYPE SCORING
  //    Translates ensemble signal ‚Üí per-contract-type score [0-100]
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  scoreContractTypes(ensembleScore, volatility, allowedTypes) {
    // ensembleScore: -1 to +1 (positive = bullish)
    const bull  = Math.max(0, ensembleScore);   // 0‚Üí1
    const bear  = Math.max(0, -ensembleScore);  // 0‚Üí1
    const lowVol = Math.max(0, 1 - volatility * 10); // high when vol is low

    const scores = {
      CALL:  Math.round((bull * 0.7 + (1-volatility*5) * bull * 0.3) * 100),
      PUT:   Math.round((bear * 0.7 + (1-volatility*5) * bear * 0.3) * 100),
      CALLE: Math.round(((bull * 0.5 + lowVol * 0.5) * (ensembleScore > -0.2 ? 1 : 0.3)) * 100),
      PUTE:  Math.round(((bear * 0.5 + lowVol * 0.5) * (ensembleScore < 0.2  ? 1 : 0.3)) * 100),
    };

    // Only score allowed types
    const active = {};
    for (const ct of (allowedTypes || Object.keys(scores))) {
      if (scores[ct] !== undefined) active[ct] = scores[ct];
    }
    return active;
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // MAIN PREDICT ‚Äî Run all 8 models, weighted ensemble
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  predict(symbol) {
    const ticks = state.ticks[symbol];
    if (!ticks || ticks.length < 30) return null;
    const prices = ticks.map(t => t.price);
    const cfg = state.settings.trade;
    const features = this.extractFeatures(ticks, prices, cfg);
    if (!features) return null;

    const modelPreds = {
      lr:  this.predictLR(features),
      knn: this.predictKNN(features, symbol),
      nb:  this.predictNB(features, symbol),
      rf:  this.predictRF(features),
      gb:  this.predictGB(features),
      rnn: this.predictRNN(features, symbol),
      per: this.predictPerceptron(features),
      ac:  this.predictAutocorr(prices),
    };

    // Weighted vote
    let weightedSum = 0, totalWeight = 0;
    const modelResults = {};
    for (const [key, pred] of Object.entries(modelPreds)) {
      const m = this.models[key];
      const eff_weight = m.w * (pred.conf > 0.05 ? 1 : 0.3); // penalize low-confidence models
      weightedSum += pred.dir * pred.conf * eff_weight;
      totalWeight += eff_weight;
      modelResults[key] = { dir: pred.dir, conf: pred.conf, w: m.w };
    }

    const ensembleScore = totalWeight > 0 ? weightedSum / totalWeight : 0;
    const rawConf = Math.min(1, Math.abs(ensembleScore));

    // Count bull/bear/neutral votes
    const votes = { bull:0, bear:0, neut:0 };
    for (const pred of Object.values(modelPreds)) {
      if (pred.dir > 0) votes.bull++;
      else if (pred.dir < 0) votes.bear++;
      else votes.neut++;
    }

    const vol = AI.volatility(prices, 20);
    const ctScores = this.scoreContractTypes(
      ensembleScore,
      vol,
      cfg.contractTypes
    );

    // Best contract type
    const bestCT = Object.entries(ctScores).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'CALL';

    // Confidence: blend ensemble signal strength + vote agreement
    const voteAgreement = Math.max(votes.bull, votes.bear) / 8;
    const ensConf = Math.round((rawConf * 0.5 + voteAgreement * 0.5) * 90 + 5);

    // Store features for online learning
    this._pendingFeatures = { symbol, features, ensembleScore };

    return {
      ensembleScore,
      confidence: Math.min(97, Math.max(50, ensConf)),
      direction: ensembleScore >= 0 ? 'RISE' : 'FALL',
      bestContractType: bestCT,
      ctScores,
      votes,
      modelResults,
      features,
    };
  },

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ONLINE LEARNING ‚Äî update all models after trade result
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onTradeResult(symbol, outcome, features) {
    // outcome: 'won' ‚Üí actual=+1, 'lost' ‚Üí actual=-1 (simplified: assumes CALL)
    // We use the contract direction to determine actual
    const actual = outcome === 'won' ? 1 : -1;
    if (!features) return;

    // Update LR
    this._updateLR(features, actual);

    // Update KNN store
    this._storeKNN(symbol, features, actual);

    // Update NB
    this._updateNB(symbol, features, actual);

    // Update Perceptron
    this._updatePerceptron(features, actual);

    // Update model accuracy weights
    for (const [key, m] of Object.entries(this.models)) {
      const lastPred = m.lastPred[symbol];
      if (lastPred !== undefined) {
        const correct = (lastPred > 0 && actual > 0) || (lastPred < 0 && actual < 0);
        m.total++;
        if (correct) m.correct++;
        // Adaptive weight: based on rolling accuracy, clamp [0.2, 2.0]
        const acc = m.total >= 5 ? m.correct / m.total : 0.5;
        m.w = Math.max(0.2, Math.min(2.0, 0.2 + acc * 1.8));
      }
    }
  },

  // Save last predictions for accuracy tracking
  _savePredictionsForTracking(symbol, modelResults) {
    for (const [key, pred] of Object.entries(modelResults)) {
      this.models[key].lastPred[symbol] = pred.dir;
    }
  },

  // Accuracy string
  accStr(key) {
    const m = this.models[key];
    if (m.total < 3) return '‚Äî';
    return Math.round(m.correct / m.total * 100) + '%';
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET ‚Äî Deriv API Connection
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wsReqCallbacks = {};

function nextReqId() { return state.reqId++; }

function wsConnect() {
  if (state.ws) { try { state.ws.close(); } catch(e){} }
  const url = `${state.server}?app_id=${state.appId}`;
  setConnStatus('connecting');
  state.ws = new WebSocket(url);

  state.ws.onopen = () => {
    state.reconnectCount = 0;
    clearTimeout(state.reconnectTimer);
    // Authorize
    wsSend({ authorize: state.authToken });
    startPing();
  };

  state.ws.onmessage = (e) => {
    try { wsHandle(JSON.parse(e.data)); } catch(er) {}
  };

  state.ws.onclose = () => {
    setConnStatus('error');
    stopPing();
    state.wsReady = false;
    state.subscribed.clear();
    scheduleReconnect();
  };

  state.ws.onerror = () => {
    setConnStatus('error');
  };
}

function wsSend(data) {
  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return null;
  const id = data.req_id || nextReqId();
  data.req_id = id;
  state.ws.send(JSON.stringify(data));
  return id;
}

function wsHandle(msg) {
  if (msg.error) {
    const errMsg = msg.error.message || 'Unknown error';
    if (msg.msg_type === 'authorize') {
      setConnStatus('error');
      document.getElementById('loginStatus').className = 'login-status error';
      document.getElementById('loginStatus').textContent = 'Auth failed: ' + errMsg;
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('app').classList.remove('visible');
      return;
    }
    console.warn('WS Error:', errMsg);
    return;
  }

  if (msg.req_id && wsReqCallbacks[msg.req_id]) {
    wsReqCallbacks[msg.req_id](msg);
    delete wsReqCallbacks[msg.req_id];
  }

  switch (msg.msg_type) {
    case 'authorize': handleAuth(msg.authorize); break;
    case 'balance': handleBalance(msg.balance); break;
    case 'tick': handleTick(msg.tick); break;
    case 'buy': handleBuy(msg.buy, msg); break;
    case 'proposal_open_contract': handlePOC(msg.proposal_open_contract); break;
    case 'transaction': handleTransaction(msg.transaction); break;
    case 'ping': break;
    default: break;
  }
}

function handleAuth(auth) {
  state.wsReady = true;
  state.account = auth;
  state.currency = auth.currency;
  setConnStatus('connected');
  document.getElementById('hdrAccount').textContent = auth.loginid;
  document.getElementById('hdrCurrency').textContent = auth.currency;
  // Subscribe to balance
  wsSend({ balance: 1, subscribe: 1 });
  // Subscribe ticks for all symbols
  const activeSym = state.settings.trade.symbols;
  subscribeSymbols(activeSym);
  // Subscribe to open contracts
  wsSend({ proposal_open_contract: 1, subscribe: 1 });
  // Show app
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  // Start intervals
  startSignalEngine();
  startClockUpdate();
  updateMartingaleUI();
  toast('Connected to Deriv API ‚úì', 'success');
}

function handleBalance(bal) {
  state.balance = bal.balance;
  document.getElementById('hdrBalance').textContent = bal.balance.toFixed(2);
  document.getElementById('dash-balance').textContent = bal.balance.toFixed(2);
  document.getElementById('dash-currency').textContent = bal.currency;
}

function handleTick(tick) {
  const sym = tick.symbol;
  if (!state.ticks[sym]) state.ticks[sym] = [];
  const arr = state.ticks[sym];
  const prev = arr.length ? arr[arr.length-1].price : tick.quote;
  const direction = tick.quote > prev ? 'up' : tick.quote < prev ? 'down' : 'eq';
  arr.push({ price: tick.quote, epoch: tick.epoch, direction });
  if (arr.length > state.settings.trade.tickDepth) arr.shift();
  updateMWCard(sym, tick, direction);
  updateAnalyticsIfSelected(sym);
  updateDashPulse(sym, tick, direction);
  // Update sparkline
  updateMWSparkline(sym);
}

function handleBuy(buy, msg) {
  if (!buy) return;
  const tradeInfo = state.pendingBuys.get(msg.req_id);
  state.pendingBuys.delete(msg.req_id);
  const trade = {
    contract_id: buy.contract_id,
    symbol: tradeInfo?.symbol || '‚Äî',
    contractType: tradeInfo?.contractType || '‚Äî',
    stake: buy.buy_price,
    duration: tradeInfo?.duration || '‚Äî',
    entryPrice: null,
    currentPrice: null,
    pnl: 0, status: 'open',
    startTime: Date.now(),
    confidence: tradeInfo?.confidence || 0,
    signal: tradeInfo,
  };
  state.activeTrades[buy.contract_id] = trade;
  state.lastTradeTime[trade.symbol] = Date.now();
  state.dailyTrades++;
  updateActiveTradesUI();
  updateBadges();
  toast(`Trade opened: ${CONTRACT_TYPES[trade.contractType] || trade.contractType} on ${trade.symbol} @ $${trade.stake.toFixed(2)}`, 'info');
}

function handlePOC(poc) {
  if (!poc || !poc.contract_id) return;
  const cid = poc.contract_id;
  if (poc.is_expired || poc.is_sold) {
    const trade = state.activeTrades[cid];
    if (trade) {
      const pnl = (poc.profit || 0);
      trade.pnl = pnl;
      trade.status = poc.status || (pnl >= 0 ? 'won' : 'lost');
      trade.exitPrice = poc.exit_tick;
      trade.entryPrice = poc.entry_tick;
      // Move to history
      state.tradeHistory.unshift({ ...trade, closedAt: Date.now() });
      delete state.activeTrades[cid];
      // Update stats
      state.dailyPnL += pnl;
      if (pnl >= 0) { state.dailyWins++; state.consecutiveLosses = 0; }
      else {
        state.consecutiveLosses++;
        updateMartingaleOnLoss(trade);
      }
      if (pnl >= 0) updateMartingaleOnWin();
      // ‚îÄ‚îÄ ONLINE LEARNING: update all 8 models with trade outcome ‚îÄ‚îÄ
      const outcome = pnl >= 0 ? 'won' : 'lost';
      const features = trade.signal?.ensResult?.features;
      EnsembleML.onTradeResult(trade.symbol, outcome, features);
      updateDashStats();
      updateHistoryUI();
      updateActiveTradesUI();
      updateBadges();
      const color = pnl >= 0 ? 'success' : 'error';
      toast(`Trade closed: ${pnl >= 0 ? '‚úì WON' : '‚úó LOST'} $${Math.abs(pnl).toFixed(2)}`, color);
    }
  } else if (state.activeTrades[cid]) {
    state.activeTrades[cid].pnl = poc.profit || 0;
    state.activeTrades[cid].entryPrice = poc.entry_tick || state.activeTrades[cid].entryPrice;
    state.activeTrades[cid].currentPrice = poc.current_spot;
    updateActiveTradesUI();
  }
}

function handleTransaction(tx) {}

function scheduleReconnect() {
  if (state.reconnectCount >= state.maxReconnect) { toast('Max reconnect attempts reached.','error'); return; }
  state.reconnectCount++;
  const delay = Math.min(30000, 2000 * Math.pow(1.5, state.reconnectCount));
  clearTimeout(state.reconnectTimer);
  state.reconnectTimer = setTimeout(() => {
    if (state.wsReady) return;
    toast(`Reconnecting‚Ä¶ (attempt ${state.reconnectCount})`, 'warn');
    wsConnect();
  }, delay);
}

function startPing() {
  stopPing();
  state.pingInterval = setInterval(() => {
    wsSend({ ping: 1 });
  }, 30000);
}
function stopPing() { clearInterval(state.pingInterval); }

function subscribeSymbols(symbols) {
  for (const sym of symbols) {
    if (!state.subscribed.has(sym)) {
      wsSend({ ticks: sym, subscribe: 1 });
      state.subscribed.add(sym);
    }
  }
  document.getElementById('nb-mw').textContent = symbols.length;
}

function resubscribeAll() {
  state.subscribed.clear();
  subscribeSymbols(state.settings.trade.symbols);
  toast('Resubscribed to all symbols', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADE EXECUTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function executeTrade(signal) {
  if (!state.wsReady) { toast('Not connected to Deriv', 'error'); return; }
  if (!RiskManager.canTrade(signal)) return;

  const params = {
    amount: signal.stake,
    basis: 'stake',
    contract_type: signal.contractType,
    currency: state.currency || 'USD',
    duration: parseInt(signal.duration) || 5,
    duration_unit: signal.duration?.includes('t') ? 't' : 's',
    symbol: signal.symbol,
  };

  const id = nextReqId();
  state.pendingBuys.set(id, { ...signal, req_id: id });
  state.ws.send(JSON.stringify({ buy: 1, price: signal.stake * 2, parameters: params, req_id: id }));
}

function executeManual(symbol) {
  const sig = state.signals[symbol] || AI.generateSignal(symbol);
  if (!sig) { toast('No signal available for ' + symbol, 'warn'); return; }
  executeTrade(sig);
}

function executeBestSignal() {
  const sigs = AI.allSignals();
  const best = sigs.find(s => s.confidence >= state.settings.trade.minConfidence);
  if (!best) { toast('No high-confidence signal found', 'warn'); return; }
  executeTrade(best);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO TRADE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSignalEngine() {
  clearInterval(state.signalInterval);
  const refresh = (state.settings.trade.sigRefresh || 5) * 1000;
  state.signalInterval = setInterval(() => {
    const sigs = AI.allSignals();
    renderSignals();
    updateDashSignals(sigs);
    updateBadges(sigs);
    if (state.autoTrade) {
      for (const sig of sigs) {
        if (RiskManager.canTrade(sig)) {
          executeTrade(sig);
          break; // one at a time from auto cycle
        }
      }
    }
  }, refresh);
}

function toggleAutoTrade() {
  state.autoTrade = document.getElementById('autoTradeToggle').checked;
  updateAutoStatus();
  if (state.autoTrade) toast('Auto Trade ENABLED ‚Äî AI is now trading autonomously', 'success');
  else toast('Auto Trade DISABLED', 'info');
}

function updateAutoStatus() {
  const el = document.getElementById('autoStatus');
  el.textContent = state.autoTrade ? 'ON' : 'OFF';
  el.className = 'auto-status' + (state.autoTrade ? ' on' : '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARTINGALE MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMartingaleOnLoss(trade) {
  const mg = state.settings.martingale;
  if (!mg.enabled) return;
  if (state.martingaleRound < mg.maxRounds) state.martingaleRound++;
  updateMartingaleUI();
}

function updateMartingaleOnWin() {
  const mg = state.settings.martingale;
  if (!mg.enabled) return;
  if (mg.reset === 'immediately') { state.martingaleRound = 0; }
  else if (mg.reset === 'delay1' && state.martingaleRound > 0) { state.martingaleRound--; }
  else if (mg.reset === 'delay2' && state.martingaleRound > 0) { state.martingaleRound = Math.max(0, state.martingaleRound - 2); }
  updateMartingaleUI();
}

function resetMartingale() {
  state.martingaleRound = 0;
  state.consecutiveLosses = 0;
  updateMartingaleUI();
  toast('Martingale state reset', 'info');
}

function updateMartingaleUI() {
  const cfg = state.settings;
  const mg = cfg.martingale;
  const round = state.martingaleRound;
  let stake = cfg.trade.stake;
  if (mg.strategy === 'fibonacci') {
    const fibs = [1,1,2,3,5,8,13,21,34];
    stake = stake * (fibs[Math.min(round, fibs.length-1)]);
  } else if (mg.strategy === 'dalembert') {
    stake = stake + (round * stake * 0.5);
  } else {
    stake = stake * Math.pow(mg.multiplier, round);
  }
  stake = Math.min(stake, mg.maxStake);
  document.getElementById('mg-round').textContent = round;
  document.getElementById('mg-stake').textContent = '$' + stake.toFixed(2);
  document.getElementById('mg-losses').textContent = state.consecutiveLosses;
  const baseStake = cfg.trade.stake;
  const target = baseStake * Math.pow(mg.multiplier, round) * (mg.multiplier - 1);
  document.getElementById('mg-target').textContent = '$' + Math.min(target, 999).toFixed(2);
  document.getElementById('mg-status').textContent = round > 0 ? 'RECOVERY' : 'IDLE';
  document.getElementById('mg-status').style.color = round > 0 ? 'var(--orange)' : 'var(--text-secondary)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setConnStatus(status) {
  const dot = document.getElementById('connDot');
  const lbl = document.getElementById('connStatus');
  dot.className = 'conn-dot ' + status;
  lbl.textContent = {connected:'Connected',connecting:'Connecting‚Ä¶',error:'Disconnected'}[status] || status;
}

function updateMWCard(sym, tick, direction) {
  const card = document.getElementById('mw-' + sym);
  if (!card) return;
  const priceEl = card.querySelector('.mw-price');
  if (priceEl) {
    priceEl.textContent = tick.quote.toFixed(getDecimals(sym));
    priceEl.className = 'mw-price ' + (direction === 'up' ? 'up' : direction === 'down' ? 'dn' : '');
  }
  const arr = card.querySelector('.mw-direction-arrow');
  if (arr) {
    arr.textContent = direction === 'up' ? '‚ñ≤' : direction === 'down' ? '‚ñº' : '‚Äî';
    arr.className = 'mw-direction-arrow ' + (direction === 'up' ? 'up' : direction === 'down' ? 'dn' : '');
  }
  // Update stats
  const ticks = state.ticks[sym] || [];
  if (ticks.length > 1) {
    const first = ticks[0].price;
    const last = tick.quote;
    const chg = ((last - first) / first * 100);
    const chgEl = card.querySelector('.mw-price-change');
    if (chgEl) {
      chgEl.textContent = (chg >= 0 ? '+' : '') + chg.toFixed(3) + '%';
      chgEl.style.color = chg >= 0 ? 'var(--green)' : 'var(--red)';
    }
  }
  // Update signal pill
  const sig = state.signals[sym];
  const pill = card.querySelector('.mw-signal-pill');
  if (pill && sig) {
    pill.textContent = sig.direction;
    pill.className = 'mw-signal-pill tbl-badge ' + (sig.direction === 'RISE' ? 'badge-rise' : 'badge-fall');
  }
}

function updateMWSparkline(sym) {
  const ticks = state.ticks[sym];
  if (!ticks || ticks.length < 2) return;
  const canvas = document.getElementById('spark-' + sym);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const prices = ticks.slice(-40).map(t => t.price);
  const min = Math.min(...prices), max = Math.max(...prices);
  const range = max - min || 0.0001;
  const w = canvas.offsetWidth || 220, h = canvas.offsetHeight || 50;
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0, 0, w, h);
  const last = prices[prices.length-1];
  const first = prices[0];
  const color = last >= first ? '#00ff88' : '#ff3366';
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.shadowColor = color;
  ctx.shadowBlur = 4;
  prices.forEach((p, i) => {
    const x = (i / (prices.length-1)) * w;
    const y = h - ((p - min) / range) * (h - 4) - 2;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
  // Fill
  ctx.beginPath();
  ctx.strokeStyle = 'transparent';
  prices.forEach((p, i) => {
    const x = (i / (prices.length-1)) * w;
    const y = h - ((p - min) / range) * (h - 4) - 2;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
  ctx.fillStyle = color + '18';
  ctx.fill();
}

function getDecimals(sym) {
  if (sym.includes('HZ')) return 4;
  if (sym.startsWith('R_')) return 3;
  return 2;
}

function updateAnalyticsIfSelected(sym) {
  if (state.analyticsSymbol !== sym) return;
  const ticks = state.ticks[sym];
  if (!ticks || ticks.length < 5) return;
  const prices = ticks.map(t => t.price);
  // Update indicator table
  const cfg = state.settings.trade;
  const rsi = AI.rsi(prices, cfg.rsiPeriod);
  const ema5 = AI.ema(prices, cfg.emaShort);
  const ema10 = AI.ema(prices, cfg.emaMed);
  const ema20 = AI.ema(prices, cfg.emaLong);
  const mom = AI.momentum(prices, 10);
  const vol = AI.volatility(prices, 20);
  const streak = AI.streak(ticks);
  const pattern = AI.patternScore(ticks);
  const sig = state.signals[sym];

  setInd('ind-rsi', rsi?.toFixed(2), rsi < 30 ? 'OVERSOLD' : rsi > 70 ? 'OVERBOUGHT' : 'NEUTRAL', rsi < 40 ? 'var(--green)' : rsi > 60 ? 'var(--red)' : 'var(--text-secondary)');
  setInd('ind-ema5', ema5?.toFixed(getDecimals(sym)+1), '', 'var(--cyan)');
  setInd('ind-ema10', ema10?.toFixed(getDecimals(sym)+1), ema5 > ema10 ? 'BULL' : 'BEAR', ema5 > ema10 ? 'var(--green)' : 'var(--red)');
  setInd('ind-ema20', ema20?.toFixed(getDecimals(sym)+1), ema10 > ema20 ? 'BULL' : 'BEAR', ema10 > ema20 ? 'var(--green)' : 'var(--red)');
  setInd('ind-mom', mom?.toFixed(4) + '%', mom > 0 ? 'BULLISH' : 'BEARISH', mom > 0 ? 'var(--green)' : 'var(--red)');
  setInd('ind-vol', vol?.toFixed(5), vol > 0.05 ? 'HIGH' : vol < 0.01 ? 'LOW' : 'MEDIUM', 'var(--orange)');
  setInd('ind-streak', streak.count + ' ' + (streak.dir === 'up' ? '‚ñ≤' : streak.dir === 'down' ? '‚ñº' : ''), streak.dir.toUpperCase(), streak.dir === 'up' ? 'var(--green)' : streak.dir === 'down' ? 'var(--red)' : 'var(--text-secondary)');
  if (sig) setInd('ind-ai-score', sig.confidence + '%', sig.direction + ' ' + (sig.confidence >= 75 ? 'STRONG' : 'MODERATE'), sig.direction === 'RISE' ? 'var(--green)' : 'var(--red)');

  // ‚îÄ‚îÄ ENSEMBLE ML PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (ticks.length >= 30) {
    const ens = EnsembleML.predict(sym);
    if (ens) {
      renderEnsemblePanel(sym, ens);
    }
  }

  // Tick tape
  const tape = document.getElementById('an-tick-tape');
  if (tape) {
    const last = ticks.slice(-60);
    tape.innerHTML = last.map(t => `<div class="tick-dot ${t.direction === 'up' ? 'up' : t.direction === 'down' ? 'dn' : 'eq'}">${t.direction === 'up' ? '‚ñ≤' : t.direction === 'down' ? '‚ñº' : '‚îÄ'}</div>`).join('');
  }

  // Pattern stats
  const ps = document.getElementById('an-pattern-stats');
  if (ps && ticks.length >= 20) {
    const last20 = ticks.slice(-20);
    const ups = last20.filter(t => t.direction === 'up').length;
    const downs = last20.filter(t => t.direction === 'down').length;
    ps.innerHTML = `
      <div style="display:flex;gap:16px;padding:4px 0">
        <div><div style="color:var(--text-muted);font-size:9px;letter-spacing:1px">LAST 20 TICKS</div>
        <div style="color:var(--green);font-size:14px">‚ñ≤ ${ups} UP</div>
        <div style="color:var(--red);font-size:14px">‚ñº ${downs} DOWN</div></div>
        <div><div style="color:var(--text-muted);font-size:9px;letter-spacing:1px">STREAK</div>
        <div style="color:var(--cyan);font-size:14px">${streak.count}x ${streak.dir.toUpperCase()}</div></div>
        <div><div style="color:var(--text-muted);font-size:9px;letter-spacing:1px">BIAS</div>
        <div style="color:${pattern.bias === 'bullish' ? 'var(--green)' : pattern.bias === 'bearish' ? 'var(--red)' : 'var(--text-secondary)'};font-size:14px">${pattern.bias.toUpperCase()}</div></div>
      </div>`;
  }

  // Recommendation
  const rec = document.getElementById('an-recommendation');
  if (rec && sig) {
    const isRise = sig.direction === 'RISE';
    rec.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;background:${isRise ? 'rgba(0,255,136,0.05)' : 'rgba(255,51,102,0.05)'};border:1px solid ${isRise ? 'rgba(0,255,136,0.2)' : 'rgba(255,51,102,0.2)'};padding:14px">
        <div style="font-size:36px">${isRise ? '‚ñ≤' : '‚ñº'}</div>
        <div>
          <div style="font-family:var(--font-display);font-size:14px;color:${isRise ? 'var(--green)' : 'var(--red)'};letter-spacing:2px">${CONTRACT_TYPES[sig.contractType]}</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Confidence: <span style="color:var(--cyan);font-family:var(--font-mono)">${sig.confidence}%</span></div>
          <div style="font-size:12px;color:var(--text-secondary)">Duration: <span style="color:var(--text-primary);font-family:var(--font-mono)">${sig.duration}</span> | Stake: <span style="color:var(--text-primary);font-family:var(--font-mono)">$${sig.stake.toFixed(2)}</span></div>
        </div>
        <button class="btn btn-${isRise ? 'success' : 'danger'} btn-sm" style="margin-left:auto" onclick="executeTrade(state.signals['${sym}'])">EXECUTE</button>
      </div>`;
  }

  // Update analytics chart
  updateAnalyticsChart(sym, prices);
}

function setInd(id, val, sig, color) {
  const el = document.getElementById(id);
  const sigEl = document.getElementById(id + '-sig');
  if (el) { el.textContent = val ?? '‚Äî'; el.style.color = color || ''; }
  if (sigEl) { sigEl.textContent = sig ?? '‚Äî'; sigEl.style.color = color || ''; }
}

// ‚îÄ‚îÄ ENSEMBLE PANEL RENDERER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEnsemblePanel(sym, ens) {
  // Per-model bars
  const modelKeys = ['lr','knn','nb','rf','gb','rnn','per','ac'];
  for (const key of modelKeys) {
    const res = ens.modelResults[key];
    if (!res) continue;
    const bar  = document.getElementById('mb-' + key);
    const vote = document.getElementById('mv-' + key);
    const acc  = document.getElementById('ma-' + key);
    if (!bar || !vote || !acc) continue;

    const confPct = Math.round(res.conf * 100);
    const isBull = res.dir > 0;
    const isNeut = res.dir === 0 || res.conf < 0.05;

    bar.style.width = confPct + '%';
    bar.style.background = isNeut ? 'var(--text-muted)' : isBull ? 'var(--green)' : 'var(--red)';

    vote.textContent = isNeut ? 'NEUT' : isBull ? '‚ñ≤ RISE' : '‚ñº FALL';
    vote.className = 'model-vote ' + (isNeut ? 'neut' : isBull ? 'bull' : 'bear');

    const modelAcc = EnsembleML.accStr(key);
    acc.textContent = modelAcc;
    // Weight badge
    const wt = EnsembleML.models[key].w;
    acc.title = `Weight: ${wt.toFixed(2)}`;
  }

  // Ensemble result summary
  const resEl = document.getElementById('an-ensemble-result');
  if (resEl) {
    const isRise = ens.direction === 'RISE';
    const aggColor = isRise ? 'var(--green)' : 'var(--red)';
    const agrPct = Math.round(Math.max(ens.votes.bull, ens.votes.bear) / 8 * 100);
    resEl.innerHTML = `
      <div class="ensemble-result">
        <div class="ensemble-label">Ensemble Verdict</div>
        <div class="ensemble-vote-row">
          <div class="ensemble-direction ${isRise ? 'rise' : 'fall'}">${ens.direction}</div>
          <div style="flex:1">
            <div style="height:6px;background:var(--bg-deep);border:1px solid var(--border);overflow:hidden;margin-bottom:4px">
              <div style="height:100%;width:${ens.confidence}%;background:${aggColor};transition:width 0.5s"></div>
            </div>
            <div style="font-family:var(--font-mono);font-size:13px;color:${aggColor}">${ens.confidence}% confidence</div>
          </div>
        </div>
        <div class="ensemble-votes" style="margin-top:6px">
          <span class="ev-bull">‚ñ≤ ${ens.votes.bull} Rise</span>
          <span class="ev-bear">‚ñº ${ens.votes.bear} Fall</span>
          ${ens.votes.neut ? `<span class="ev-neut">‚Äî ${ens.votes.neut} Neutral</span>` : ''}
          <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-left:auto">${agrPct}% agreement</span>
        </div>
        <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);margin-top:6px">
          Ensemble score: <span style="color:${aggColor}">${ens.ensembleScore >= 0 ? '+' : ''}${ens.ensembleScore.toFixed(4)}</span>
          | Best CT: <span style="color:var(--cyan)">${CONTRACT_TYPES[ens.bestContractType] || ens.bestContractType}</span>
        </div>
      </div>`;
  }

  // Contract type scores
  const ctScores = ens.ctScores;
  const ctMax = Math.max(...Object.values(ctScores));
  for (const [ct, score] of Object.entries(ctScores)) {
    const ctEl = document.getElementById('cts-' + ct.toLowerCase());
    if (!ctEl) continue;
    ctEl.textContent = score + '%';
    ctEl.style.color = score >= 70 ? 'var(--green)' : score >= 50 ? 'var(--cyan)' : 'var(--text-secondary)';
    const row = ctEl.closest('.ct-score-row');
    if (row) {
      if (score === ctMax) row.classList.add('best');
      else row.classList.remove('best');
    }
  }
}

function updateAnalyticsChart(sym, prices) {
  const ctx = document.getElementById('an-price-chart');
  if (!ctx) return;
  const labels = prices.map((_,i) => i);
  const ema5arr = [], ema10arr = [], ema20arr = [];
  const cfg = state.settings.trade;
  for (let i = cfg.emaShort; i <= prices.length; i++) {
    ema5arr.push({ x: i-1, y: AI.ema(prices.slice(0,i), cfg.emaShort) });
  }
  for (let i = cfg.emaMed; i <= prices.length; i++) {
    ema10arr.push({ x: i-1, y: AI.ema(prices.slice(0,i), cfg.emaMed) });
  }
  for (let i = cfg.emaLong; i <= prices.length; i++) {
    ema20arr.push({ x: i-1, y: AI.ema(prices.slice(0,i), cfg.emaLong) });
  }

  if (state.charts.priceChart) {
    state.charts.priceChart.data.labels = labels;
    state.charts.priceChart.data.datasets[0].data = prices;
    state.charts.priceChart.data.datasets[1].data = ema5arr.map(p=>p.y);
    state.charts.priceChart.data.datasets[2].data = ema10arr.map(p=>p.y);
    state.charts.priceChart.data.datasets[3].data = ema20arr.map(p=>p.y);
    state.charts.priceChart.update('none');
  } else {
    state.charts.priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Price', data: prices, borderColor: '#00d4ff', borderWidth: 1.5, pointRadius: 0, tension: 0.1, fill: false },
          { label: 'EMA5', data: ema5arr.map(p=>p.y), borderColor: '#00ff88', borderWidth: 1, pointRadius: 0, borderDash: [2,2], fill: false },
          { label: 'EMA10', data: ema10arr.map(p=>p.y), borderColor: '#ffcc00', borderWidth: 1, pointRadius: 0, borderDash: [4,2], fill: false },
          { label: 'EMA20', data: ema20arr.map(p=>p.y), borderColor: '#ff8c42', borderWidth: 1, pointRadius: 0, borderDash: [6,2], fill: false },
        ]
      },
      options: chartOptions('Price & EMAs')
    });
  }

  // RSI chart
  const rsiCtx = document.getElementById('an-rsi-chart');
  if (rsiCtx) {
    const rsiData = [];
    const cfg2 = state.settings.trade;
    for (let i = cfg2.rsiPeriod + 1; i <= prices.length; i++) {
      rsiData.push(AI.rsi(prices.slice(0, i), cfg2.rsiPeriod));
    }
    if (state.charts.rsiChart) {
      state.charts.rsiChart.data.labels = rsiData.map((_,i)=>i);
      state.charts.rsiChart.data.datasets[0].data = rsiData;
      state.charts.rsiChart.update('none');
    } else {
      state.charts.rsiChart = new Chart(rsiCtx, {
        type: 'line',
        data: { labels: rsiData.map((_,i)=>i), datasets: [
          { label: 'RSI', data: rsiData, borderColor: '#a855f7', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.2 }
        ]},
        options: { ...chartOptions('RSI'), plugins: { ...chartOptions('').plugins, annotation: {} }, scales: {
          x: { display: false },
          y: { min: 0, max: 100, grid: { color: 'rgba(26,48,80,0.5)' }, ticks: { color: '#6a8aaa', font: { family: "'Share Tech Mono'" }, maxTicksLimit: 5 } }
        }}
      });
    }
  }
}

function chartOptions(title) {
  return {
    responsive: true, maintainAspectRatio: false, animation: false,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { display: false }, tooltip: {
      backgroundColor: '#0c1929', borderColor: '#1a3050', borderWidth: 1,
      titleColor: '#6a8aaa', bodyColor: '#d4eaff',
      titleFont: { family: "'Share Tech Mono'" }, bodyFont: { family: "'Share Tech Mono'" }
    }},
    scales: {
      x: { display: false },
      y: { grid: { color: 'rgba(26,48,80,0.5)' }, ticks: { color: '#6a8aaa', font: { family: "'Share Tech Mono'", size: 10 }, maxTicksLimit: 5 }, border: { color: 'transparent' } }
    }
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// MARKET WATCH
function renderMarketWatch() {
  const grid = document.getElementById('mw-grid');
  if (!grid) return;
  grid.innerHTML = SYMBOLS.map(sym => `
    <div class="mw-card" id="mw-${sym.id}" onclick="selectAnalyticsSymbol('${sym.id}')">
      <div class="mw-signal-pill tbl-badge" style="display:none"></div>
      <div class="mw-card-top">
        <div>
          <div class="mw-sym-name">${sym.name}</div>
          <div class="mw-sym-id">${sym.id}</div>
        </div>
        <div class="mw-price-block">
          <div class="mw-price" id="mw-price-${sym.id}">‚Äî</div>
          <div class="mw-price-change" id="mw-chg-${sym.id}" style="color:var(--text-muted)">‚Äî</div>
        </div>
      </div>
      <div class="mw-mini-chart">
        <canvas id="spark-${sym.id}" style="width:100%;height:50px"></canvas>
      </div>
      <div class="mw-stats">
        <div class="mw-stat"><div class="mw-stat-lbl">Direction</div><div class="mw-direction-arrow" id="mw-dir-${sym.id}">‚Äî</div></div>
        <div class="mw-stat"><div class="mw-stat-lbl">Ticks</div><div class="mw-stat-val" id="mw-ticks-${sym.id}">0</div></div>
        <div class="mw-stat"><div class="mw-stat-lbl">Signal</div><div class="mw-stat-val" id="mw-sig-${sym.id}" style="color:var(--cyan);font-size:11px;font-family:var(--font-mono)">‚Äî</div></div>
      </div>
    </div>`).join('');
}

// SIGNALS
function renderSignals() {
  const grid = document.getElementById('sig-grid');
  if (!grid) return;
  const typeFilter = document.getElementById('sig-filter-type')?.value || 'all';
  const confFilter = parseInt(document.getElementById('sig-filter-conf')?.value || '0');
  const sigs = Object.values(state.signals);
  const filtered = sigs.filter(s => {
    if (typeFilter !== 'all' && s.contractType !== typeFilter) return false;
    if (s.confidence < confFilter) return false;
    return true;
  }).sort((a,b) => b.confidence - a.confidence);

  if (!filtered.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted)"><div class="loading-dots"><span></span><span></span><span></span></div><p style="margin-top:16px">Generating signals from market data‚Ä¶</p></div>';
    return;
  }

  const highConf = filtered.filter(s => s.confidence >= 75).length;
  document.getElementById('sig-ai-text').innerHTML = `Analyzed <strong>${filtered.length}</strong> volatility indices. Found <strong>${highConf}</strong> high-confidence setups (‚â•75%). Top signal: <strong>${filtered[0]?.symName}</strong> ‚Äî ${CONTRACT_TYPES[filtered[0]?.contractType] || '‚Äî'} at <strong>${filtered[0]?.confidence}%</strong> confidence.`;

  grid.innerHTML = filtered.map(sig => {
    const isRise = sig.direction === 'RISE';
    const confClass = sig.confidence >= 80 ? 'conf-green' : sig.confidence >= 65 ? 'conf-yellow' : 'conf-red';
    const typeClass = sig.contractType === 'CALL' ? 'rise-sig' : sig.contractType === 'PUT' ? 'fall-sig' : sig.contractType === 'CALLE' ? 'rise-eq-sig' : 'fall-eq-sig';
    const indBull = [], indBear = [];
    if (sig.rsiSignal > 0) indBull.push('RSI ‚Üë'); else if (sig.rsiSignal < 0) indBear.push('RSI ‚Üì');
    if (sig.emaSignal > 0) indBull.push('EMA ‚Üë'); else if (sig.emaSignal < 0) indBear.push('EMA ‚Üì');
    if (sig.momSignal > 0) indBull.push('MOM ‚Üë'); else if (sig.momSignal < 0) indBear.push('MOM ‚Üì');
    if (sig.patSignal > 0) indBull.push('PAT ‚Üë'); else if (sig.patSignal < 0) indBear.push('PAT ‚Üì');
    if (sig.streak.count >= 4) indBear.push(`STREAK ${sig.streak.count}x`);
    return `
      <div class="sig-card ${typeClass}">
        <div class="sig-top">
          <div>
            <div class="sig-sym">${sig.symName}</div>
            <div style="font-family:var(--font-mono);font-size:9px;color:var(--text-muted);margin-top:2px">${sig.symbol}</div>
          </div>
          <div class="sig-time">${new Date(sig.timestamp).toLocaleTimeString()}</div>
        </div>
        <div class="sig-main">
          <div class="sig-direction ${isRise ? 'rise' : 'fall'}">${CONTRACT_TYPES[sig.contractType]}</div>
          <div class="sig-conf-block">
            <div class="sig-conf-label">AI Confidence</div>
            <div class="sig-conf-bar"><div class="sig-conf-fill ${isRise ? 'fill-green' : 'fill-red'}" style="width:${sig.confidence}%"></div></div>
            <div class="sig-conf-pct ${confClass}">${sig.confidence}%</div>
          </div>
        </div>
        <div class="sig-details">
          <div class="sig-detail"><div class="sig-detail-lbl">Entry</div><div class="sig-detail-val">${sig.price?.toFixed(getDecimals(sig.symbol)) || '‚Äî'}</div></div>
          <div class="sig-detail"><div class="sig-detail-lbl">Duration</div><div class="sig-detail-val">${sig.duration}</div></div>
          <div class="sig-detail"><div class="sig-detail-lbl">Stake</div><div class="sig-detail-val">$${sig.stake.toFixed(2)}</div></div>
          <div class="sig-detail"><div class="sig-detail-lbl">RSI</div><div class="sig-detail-val">${sig.rsi?.toFixed(1) || '‚Äî'}</div></div>
          <div class="sig-detail"><div class="sig-detail-lbl">Momentum</div><div class="sig-detail-val">${sig.momentum?.toFixed(4) || '‚Äî'}%</div></div>
          <div class="sig-detail"><div class="sig-detail-lbl">Streak</div><div class="sig-detail-val">${sig.streak.count}x ${sig.streak.dir}</div></div>
        </div>
        <div class="sig-indicators">
          ${indBull.map(i => `<span class="ind-pill ind-bull">${i}</span>`).join('')}
          ${indBear.map(i => `<span class="ind-pill ind-bear">${i}</span>`).join('')}
        </div>
        ${sig.ensResult ? `
        <div style="background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;margin-bottom:10px">
          <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;font-family:var(--font-display)">Model Consensus: ${sig.ensResult.votes.bull}‚ñ≤ ${sig.ensResult.votes.bear}‚ñº ${sig.ensResult.votes.neut}‚Äî</div>
          <div style="display:flex;gap:3px;flex-wrap:wrap">
            ${Object.entries(sig.ensResult.modelResults).map(([k,r]) => {
              const isBull = r.dir > 0;
              const isNeut = r.dir===0 || r.conf < 0.05;
              const color = isNeut ? 'var(--text-muted)' : isBull ? 'var(--green)' : 'var(--red)';
              const names = {lr:'LR',knn:'KNN',nb:'NB',rf:'RF',gb:'GB',rnn:'RNN',per:'MLP',ac:'AC'};
              return `<span style="font-family:var(--font-mono);font-size:8px;color:${color};background:${color}18;border:1px solid ${color}44;padding:1px 5px;letter-spacing:1px">${names[k]||k} ${isNeut?'‚Äî':isBull?'‚ñ≤':'‚ñº'}</span>`;
            }).join('')}
          </div>
          <div style="margin-top:6px">
            <div style="font-size:9px;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;margin-bottom:3px;font-family:var(--font-display)">Best Contract</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              ${Object.entries(sig.ensResult.ctScores).sort((a,b)=>b[1]-a[1]).map(([ct, sc]) =>
                `<span style="font-family:var(--font-mono);font-size:10px;color:${sc>=70?'var(--green)':sc>=50?'var(--cyan)':'var(--text-secondary)'};letter-spacing:1px">${CONTRACT_TYPES[ct]||ct}: ${sc}%</span>`
              ).join(' ¬∑ ')}
            </div>
          </div>
        </div>` : ''}
        <div class="sig-actions">
          <button class="btn btn-${isRise ? 'success' : 'danger'} btn-sm" onclick="executeTrade(state.signals['${sig.symbol}'])">‚ñ∂ Execute</button>
          <button class="btn btn-secondary btn-sm" onclick="selectAnalyticsSymbol('${sig.symbol}');showPage('analytics')">üìä Analyze</button>
        </div>
      </div>`;
  }).join('');

  document.getElementById('nb-sig').textContent = filtered.filter(s => s.confidence >= 70).length;
}

// ACTIVE TRADES
function updateActiveTradesUI() {
  const list = document.getElementById('active-trades-list');
  const trades = Object.values(state.activeTrades);
  document.getElementById('at-count').textContent = trades.length;
  document.getElementById('nb-active').textContent = trades.length;
  const totalPnl = trades.reduce((s,t)=>s+t.pnl,0);
  const totalExp = trades.reduce((s,t)=>s+t.stake,0);
  const pnlEl = document.getElementById('at-pnl');
  pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + totalPnl.toFixed(2);
  pnlEl.className = 'stat-val ' + (totalPnl >= 0 ? 'green' : 'red');
  document.getElementById('at-exposure').textContent = totalExp.toFixed(2);

  if (!trades.length) {
    list.innerHTML = '<div class="no-trades"><div class="icon">‚óé</div><p>No active trades. Enable Auto Trade or execute signals manually.</p></div>';
    return;
  }

  list.innerHTML = trades.map(t => {
    const elapsed = (Date.now() - t.startTime) / 1000;
    const pnlColor = t.pnl >= 0 ? 'var(--green)' : 'var(--red)';
    return `
      <div class="trade-card">
        <div class="trade-sym">
          <div class="trade-sym-name">${SYMBOLS.find(s=>s.id===t.symbol)?.short || t.symbol}</div>
          <div class="trade-contract">${CONTRACT_TYPES[t.contractType] || t.contractType}</div>
          <div style="margin-top:4px"><span class="tbl-badge badge-${t.contractType==='CALL'?'rise':t.contractType==='PUT'?'fall':t.contractType==='CALLE'?'rise-eq':'fall-eq'}">${CONTRACT_TYPES[t.contractType]||t.contractType}</span></div>
        </div>
        <div class="trade-progress">
          <div class="trade-progress-top">
            <span class="trade-progress-label">Running (${elapsed.toFixed(0)}s)</span>
            <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted)">Contract: ${t.contract_id}</span>
          </div>
          <div class="trade-progress-bar"><div class="trade-progress-fill" style="width:${Math.min(100, elapsed/60*100)}%"></div></div>
          <div style="display:flex;gap:16px;margin-top:6px;font-size:11px;color:var(--text-muted)">
            <span>Entry: <span style="font-family:var(--font-mono);color:var(--text-secondary)">${t.entryPrice?.toFixed(getDecimals(t.symbol)) || '‚Äî'}</span></span>
            <span>Current: <span style="font-family:var(--font-mono);color:var(--cyan)">${(state.ticks[t.symbol]?.slice(-1)[0]?.price || t.currentPrice)?.toFixed(getDecimals(t.symbol)) || '‚Äî'}</span></span>
          </div>
        </div>
        <div class="trade-stake">
          <div class="trade-stake-lbl">Stake</div>
          <div class="trade-stake-val">$${t.stake.toFixed(2)}</div>
        </div>
        <div class="trade-pnl">
          <div class="trade-pnl-val" style="color:${pnlColor}">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)}</div>
          <div style="font-size:10px;color:var(--text-muted)">Running P&L</div>
        </div>
      </div>`;
  }).join('');
}

// HISTORY
function renderHistory() {
  const symFilter = document.getElementById('hist-sym-filter')?.value || 'all';
  const typeFilter = document.getElementById('hist-type-filter')?.value || 'all';
  const resultFilter = document.getElementById('hist-result-filter')?.value || 'all';
  const history = state.tradeHistory.filter(t => {
    if (symFilter !== 'all' && t.symbol !== symFilter) return false;
    if (typeFilter !== 'all' && t.contractType !== typeFilter) return false;
    if (resultFilter !== 'all' && t.status !== resultFilter) return false;
    return true;
  });

  document.getElementById('hist-total').textContent = history.length;
  const won = history.filter(t=>t.status==='won');
  const lost = history.filter(t=>t.status==='lost');
  const totalProfit = won.reduce((s,t)=>s+(t.pnl||0),0);
  const totalLoss = lost.reduce((s,t)=>s+Math.abs(t.pnl||0),0);
  document.getElementById('hist-profit').textContent = '+' + totalProfit.toFixed(2);
  document.getElementById('hist-loss').textContent = '-' + totalLoss.toFixed(2);
  document.getElementById('hist-winrate').textContent = history.length ? Math.round(won.length/history.length*100)+'%' : '‚Äî';
  const best = history.reduce((b,t)=>(!b || t.pnl > b.pnl) ? t : b, null);
  document.getElementById('hist-best').textContent = best ? '$'+best.pnl.toFixed(2) : '‚Äî';
  const avgStake = history.length ? history.reduce((s,t)=>s+t.stake,0)/history.length : 0;
  document.getElementById('hist-avg-stake').textContent = avgStake ? '$'+avgStake.toFixed(2) : '‚Äî';

  const tbody = document.getElementById('history-tbody');
  if (!history.length) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--text-muted);padding:40px">No trades match your filters</td></tr>';
    return;
  }
  tbody.innerHTML = history.map((t,i) => {
    const pnlColor = t.pnl >= 0 ? 'var(--green)' : 'var(--red)';
    const dur = t.duration || '‚Äî';
    return `<tr>
      <td class="tbl-mono">${i+1}</td>
      <td>${SYMBOLS.find(s=>s.id===t.symbol)?.short || t.symbol}</td>
      <td><span class="tbl-badge badge-${t.contractType==='CALL'?'rise':t.contractType==='PUT'?'fall':t.contractType==='CALLE'?'rise-eq':'fall-eq'}">${CONTRACT_TYPES[t.contractType]||t.contractType}</span></td>
      <td class="tbl-mono">$${t.stake?.toFixed(2)||'‚Äî'}</td>
      <td class="tbl-mono">${t.payout ? '$'+t.payout.toFixed(2) : '‚Äî'}</td>
      <td class="tbl-mono" style="color:${pnlColor}">${t.pnl >= 0 ? '+' : ''}${t.pnl?.toFixed(2)||'0.00'}</td>
      <td class="tbl-mono">${dur}</td>
      <td class="tbl-mono">${t.entryPrice?.toFixed(getDecimals(t.symbol)) || '‚Äî'}</td>
      <td class="tbl-mono">${t.exitPrice?.toFixed(getDecimals(t.symbol)) || '‚Äî'}</td>
      <td><span class="tbl-badge ${t.status==='won'?'badge-won':'badge-lost'}">${(t.status||'?').toUpperCase()}</span></td>
      <td class="tbl-mono" style="color:var(--text-muted)">${new Date(t.closedAt||Date.now()).toLocaleTimeString()}</td>
    </tr>`;
  }).join('');
}

function updateHistoryUI() {
  // Update sym filter dropdown
  const sel = document.getElementById('hist-sym-filter');
  if (sel) {
    const existing = Array.from(sel.options).map(o=>o.value);
    for (const t of state.tradeHistory) {
      if (!existing.includes(t.symbol)) {
        const o = document.createElement('option');
        o.value = t.symbol; o.textContent = SYMBOLS.find(s=>s.id===t.symbol)?.short || t.symbol;
        sel.appendChild(o);
        existing.push(t.symbol);
      }
    }
  }
  renderHistory();
}

function updateDashStats() {
  const trades = state.tradeHistory;
  const pnl = state.dailyPnL;
  const el = document.getElementById('dash-pnl');
  el.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
  el.className = 'stat-val ' + (pnl >= 0 ? 'green' : 'red');
  const pct = state.balance ? (pnl / state.balance * 100) : 0;
  document.getElementById('dash-pnl-pct').innerHTML = `<span class="${pnl >= 0 ? 'up' : 'dn'}">${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%</span>`;
  const wins = state.dailyWins;
  const total = state.dailyTrades;
  const wr = total ? Math.round(wins/total*100) : 0;
  document.getElementById('dash-winrate').textContent = total ? wr+'%' : '‚Äî';
  document.getElementById('dash-winrate').className = 'stat-val ' + (wr >= 50 ? 'green' : 'red');
  document.getElementById('dash-trades-count').textContent = total + ' trades today';
  document.getElementById('dash-active').textContent = Object.keys(state.activeTrades).length;
  // Update recent trades
  const recent = state.tradeHistory.slice(0, 5);
  document.getElementById('dash-recent-body').innerHTML = recent.length ? recent.map(t => `
    <tr>
      <td>${SYMBOLS.find(s=>s.id===t.symbol)?.short||t.symbol}</td>
      <td><span class="tbl-badge badge-${t.contractType==='CALL'?'rise':t.contractType==='PUT'?'fall':'fall'}">${CONTRACT_TYPES[t.contractType]||t.contractType}</span></td>
      <td class="tbl-mono">$${t.stake?.toFixed(2)||'‚Äî'}</td>
      <td class="tbl-mono" style="color:${t.pnl>=0?'var(--green)':'var(--red)'}">${t.pnl>=0?'+':''}${t.pnl?.toFixed(2)||'0'}</td>
    </tr>`).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px">No recent trades</td></tr>';

  // Risk meter
  const riskPct = Math.min(100, (state.consecutiveLosses / state.settings.risk.maxConsecLoss * 100));
  const riskBar = document.getElementById('dash-risk-bar');
  const riskVal = document.getElementById('dash-risk-val');
  if (riskPct < 33) { riskBar.className = 'risk-fill risk-low'; riskVal.textContent = 'LOW'; riskVal.style.color = 'var(--green)'; }
  else if (riskPct < 66) { riskBar.className = 'risk-fill risk-med'; riskVal.textContent = 'MEDIUM'; riskVal.style.color = 'var(--yellow)'; }
  else { riskBar.className = 'risk-fill risk-high'; riskVal.textContent = 'HIGH'; riskVal.style.color = 'var(--red)'; }
  riskBar.style.width = Math.max(5, riskPct) + '%';
}

function updateDashSignals(sigs) {
  if (!sigs || !sigs.length) return;
  const top = sigs[0];
  document.getElementById('dash-top-signal').textContent = top.symName.substring(0,12);
  document.getElementById('dash-top-conf').textContent = 'Confidence: ' + top.confidence + '% ‚Äî ' + CONTRACT_TYPES[top.contractType];

  const tbody = document.getElementById('dash-signals-body');
  tbody.innerHTML = sigs.slice(0,6).map(s => {
    const isRise = s.direction === 'RISE';
    return `<tr>
      <td style="font-family:var(--font-mono);font-size:12px">${SYMBOLS.find(sym=>sym.id===s.symbol)?.short||s.symbol}</td>
      <td><span class="tbl-badge badge-${isRise?'rise':'fall'}">${CONTRACT_TYPES[s.contractType]}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:4px;background:var(--bg-deep);border:1px solid var(--border);overflow:hidden">
            <div style="height:100%;width:${s.confidence}%;background:${isRise?'var(--green)':'var(--red)'}"></div>
          </div>
          <span style="font-family:var(--font-mono);font-size:11px;color:${s.confidence>=75?'var(--green)':s.confidence>=65?'var(--yellow)':'var(--text-secondary)'}">${s.confidence}%</span>
        </div>
      </td>
      <td><button class="btn btn-${isRise?'success':'danger'} btn-sm" onclick="executeTrade(state.signals['${s.symbol}'])">‚ñ∂</button></td>
    </tr>`;
  }).join('');
}

let dashPulseItems = {};
function updateDashPulse(sym, tick, direction) {
  const container = document.getElementById('dash-market-pulse');
  if (!container) return;
  if (!dashPulseItems[sym]) {
    const el = document.createElement('div');
    el.id = 'pulse-' + sym;
    el.style.cssText = 'background:var(--bg-deep);border:1px solid var(--border);padding:6px 10px;display:flex;justify-content:space-between;align-items:center;gap:10px;overflow:hidden';
    el.innerHTML = `<span style="font-family:var(--font-mono);font-size:9px;color:var(--text-muted)">${SYMBOLS.find(s=>s.id===sym)?.short||sym}</span><span id="pulse-val-${sym}" style="font-family:var(--font-mono);font-size:11px">‚Äî</span>`;
    container.appendChild(el);
    dashPulseItems[sym] = true;
  }
  const el = document.getElementById('pulse-val-' + sym);
  if (el) {
    el.textContent = tick.quote.toFixed(getDecimals(sym));
    el.style.color = direction === 'up' ? 'var(--green)' : direction === 'down' ? 'var(--red)' : 'var(--text-secondary)';
  }
}

function updateBadges(sigs) {
  document.getElementById('nb-active').textContent = Object.keys(state.activeTrades).length;
  document.getElementById('nb-mw').textContent = state.settings.trade.symbols.length;
  if (sigs) document.getElementById('nb-sig').textContent = (sigs||[]).filter(s=>s.confidence>=70).length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSettings() {
  // Symbol checkboxes
  const container = document.getElementById('sym-checkboxes');
  if (container) {
    container.innerHTML = SYMBOLS.map(sym => {
      const checked = state.settings.trade.symbols.includes(sym.id);
      return `<label class="sym-checkbox ${checked?'checked':''}" id="sym-cb-label-${sym.id}">
        <input type="checkbox" value="${sym.id}" ${checked?'checked':''} onchange="toggleSymbolSetting('${sym.id}',this)"/>
        <span>${sym.short}</span>
      </label>`;
    }).join('');
  }
  // Analytics tabs
  const atabs = document.getElementById('analytics-sym-tabs');
  if (atabs) {
    atabs.innerHTML = SYMBOLS.map(sym =>
      `<div class="sym-tab" id="atab-${sym.id}" onclick="selectAnalyticsSymbol('${sym.id}')">${sym.short}</div>`
    ).join('');
  }
  // Load settings from state
  loadSettingsToUI();
}

function loadSettingsToUI() {
  const cfg = state.settings;
  // Trade
  document.getElementById('cfg-duration').value = cfg.trade.duration;
  document.getElementById('cfg-stake').value = cfg.trade.stake;
  document.getElementById('cfg-min-confidence').value = cfg.trade.minConfidence;
  document.getElementById('conf-display').textContent = cfg.trade.minConfidence + '%';
  document.getElementById('cfg-cooldown').value = cfg.trade.cooldown;
  document.getElementById('cfg-max-concurrent').value = cfg.trade.maxConcurrent;
  document.getElementById('cfg-rsi-period').value = cfg.trade.rsiPeriod;
  document.getElementById('cfg-ema-short').value = cfg.trade.emaShort;
  document.getElementById('cfg-ema-med').value = cfg.trade.emaMed;
  document.getElementById('cfg-ema-long').value = cfg.trade.emaLong;
  document.getElementById('cfg-tick-depth').value = cfg.trade.tickDepth;
  document.getElementById('cfg-sig-refresh').value = cfg.trade.sigRefresh;
  document.getElementById('ct-rise').checked = cfg.trade.contractTypes.includes('CALL');
  document.getElementById('ct-fall').checked = cfg.trade.contractTypes.includes('PUT');
  document.getElementById('ct-rise-eq').checked = cfg.trade.contractTypes.includes('CALLE');
  document.getElementById('ct-fall-eq').checked = cfg.trade.contractTypes.includes('PUTE');
  // Risk
  document.getElementById('cfg-max-daily-loss').value = cfg.risk.maxDailyLoss;
  document.getElementById('cfg-max-daily-loss-pct').value = cfg.risk.maxDailyLossPct;
  document.getElementById('cfg-daily-loss-action').value = cfg.risk.dailyLossAction;
  document.getElementById('cfg-max-per-hour').value = cfg.risk.maxPerHour;
  document.getElementById('cfg-max-per-day').value = cfg.risk.maxPerDay;
  document.getElementById('cfg-max-stake').value = cfg.risk.maxStake;
  document.getElementById('cfg-max-exposure').value = cfg.risk.maxExposure;
  document.getElementById('cfg-max-consec-loss').value = cfg.risk.maxConsecLoss;
  document.getElementById('cfg-loss-cooldown').value = cfg.risk.lossCooldown;
  document.getElementById('cfg-recovery-mode').value = cfg.risk.recoveryMode;
  document.getElementById('w-rsi').value = cfg.risk.wRsi; document.getElementById('w-rsi-d').textContent = cfg.risk.wRsi + '%';
  document.getElementById('w-ema').value = cfg.risk.wEma; document.getElementById('w-ema-d').textContent = cfg.risk.wEma + '%';
  document.getElementById('w-mom').value = cfg.risk.wMom; document.getElementById('w-mom-d').textContent = cfg.risk.wMom + '%';
  document.getElementById('w-pat').value = cfg.risk.wPat; document.getElementById('w-pat-d').textContent = cfg.risk.wPat + '%';
  // Martingale
  document.getElementById('cfg-martingale-enabled').checked = cfg.martingale.enabled;
  document.getElementById('cfg-mg-multiplier').value = cfg.martingale.multiplier;
  document.getElementById('cfg-mg-rounds').value = cfg.martingale.maxRounds;
  document.getElementById('cfg-mg-reset').value = cfg.martingale.reset;
  document.getElementById('cfg-mg-strategy').value = cfg.martingale.strategy;
  document.getElementById('cfg-mg-max-stake').value = cfg.martingale.maxStake;
  document.getElementById('cfg-mg-min-conf').value = cfg.martingale.minConf;
  document.getElementById('mg-conf-d').textContent = cfg.martingale.minConf + '%';
  document.getElementById('cfg-mg-apply-when').value = cfg.martingale.applyWhen;
}

function toggleSymbolSetting(id, el) {
  const label = document.getElementById('sym-cb-label-' + id);
  if (el.checked) {
    if (!state.settings.trade.symbols.includes(id)) state.settings.trade.symbols.push(id);
    label.classList.add('checked');
    if (!state.subscribed.has(id)) subscribeSymbols([id]);
  } else {
    state.settings.trade.symbols = state.settings.trade.symbols.filter(s => s !== id);
    label.classList.remove('checked');
  }
}

function saveTradeSettings() {
  const cfg = state.settings.trade;
  cfg.duration = document.getElementById('cfg-duration').value;
  cfg.stake = parseFloat(document.getElementById('cfg-stake').value) || 1;
  cfg.minConfidence = parseInt(document.getElementById('cfg-min-confidence').value) || 65;
  cfg.cooldown = parseInt(document.getElementById('cfg-cooldown').value) || 30;
  cfg.maxConcurrent = parseInt(document.getElementById('cfg-max-concurrent').value) || 5;
  cfg.rsiPeriod = parseInt(document.getElementById('cfg-rsi-period').value) || 14;
  cfg.emaShort = parseInt(document.getElementById('cfg-ema-short').value) || 5;
  cfg.emaMed = parseInt(document.getElementById('cfg-ema-med').value) || 10;
  cfg.emaLong = parseInt(document.getElementById('cfg-ema-long').value) || 20;
  cfg.tickDepth = parseInt(document.getElementById('cfg-tick-depth').value) || 100;
  cfg.sigRefresh = parseInt(document.getElementById('cfg-sig-refresh').value) || 5;
  cfg.contractTypes = [];
  if (document.getElementById('ct-rise').checked) cfg.contractTypes.push('CALL');
  if (document.getElementById('ct-fall').checked) cfg.contractTypes.push('PUT');
  if (document.getElementById('ct-rise-eq').checked) cfg.contractTypes.push('CALLE');
  if (document.getElementById('ct-fall-eq').checked) cfg.contractTypes.push('PUTE');
  startSignalEngine();
  toast('Trade settings saved ‚úì', 'success');
}

function saveRiskSettings() {
  const r = state.settings.risk;
  r.maxDailyLoss = parseFloat(document.getElementById('cfg-max-daily-loss').value) || 50;
  r.maxDailyLossPct = parseFloat(document.getElementById('cfg-max-daily-loss-pct').value) || 10;
  r.dailyLossAction = document.getElementById('cfg-daily-loss-action').value;
  r.maxPerHour = parseInt(document.getElementById('cfg-max-per-hour').value) || 20;
  r.maxPerDay = parseInt(document.getElementById('cfg-max-per-day').value) || 100;
  r.maxStake = parseFloat(document.getElementById('cfg-max-stake').value) || 100;
  r.maxExposure = parseFloat(document.getElementById('cfg-max-exposure').value) || 500;
  r.maxConsecLoss = parseInt(document.getElementById('cfg-max-consec-loss').value) || 5;
  r.lossCooldown = parseInt(document.getElementById('cfg-loss-cooldown').value) || 15;
  r.recoveryMode = document.getElementById('cfg-recovery-mode').value;
  r.wRsi = parseInt(document.getElementById('w-rsi').value) || 25;
  r.wEma = parseInt(document.getElementById('w-ema').value) || 30;
  r.wMom = parseInt(document.getElementById('w-mom').value) || 25;
  r.wPat = parseInt(document.getElementById('w-pat').value) || 20;
  toast('Risk manager settings saved ‚úì', 'success');
}

function saveMartingaleSettings() {
  const mg = state.settings.martingale;
  mg.enabled = document.getElementById('cfg-martingale-enabled').checked;
  mg.multiplier = parseFloat(document.getElementById('cfg-mg-multiplier').value) || 2;
  mg.maxRounds = parseInt(document.getElementById('cfg-mg-rounds').value) || 4;
  mg.reset = document.getElementById('cfg-mg-reset').value;
  mg.strategy = document.getElementById('cfg-mg-strategy').value;
  mg.maxStake = parseFloat(document.getElementById('cfg-mg-max-stake').value) || 256;
  mg.minConf = parseInt(document.getElementById('cfg-mg-min-conf').value) || 60;
  mg.applyWhen = document.getElementById('cfg-mg-apply-when').value;
  updateMartingaleUI();
  toast('Martingale settings saved ‚úì', 'success');
}

function resetTradeSettings() { state.settings.trade = { symbols:['R_10','R_25','R_50','R_75','R_100','1HZ10V','1HZ25V','1HZ50V','1HZ75V','1HZ100V'], contractTypes:['CALL','PUT'], duration:'5t', stake:1, minConfidence:65, cooldown:30, maxConcurrent:5, rsiPeriod:14, emaShort:5, emaMed:10, emaLong:20, tickDepth:100, sigRefresh:5 }; loadSettingsToUI(); toast('Trade settings reset', 'info'); }
function resetRiskSettings() { state.settings.risk = { maxDailyLoss:50, maxDailyLossPct:10, dailyLossAction:'pause', maxPerHour:20, maxPerDay:100, maxStake:100, maxExposure:500, maxConsecLoss:5, lossCooldown:15, recoveryMode:'pause', wRsi:25, wEma:30, wMom:25, wPat:20 }; loadSettingsToUI(); toast('Risk settings reset', 'info'); }
function resetMartingaleSettings() { state.settings.martingale = { enabled:false, multiplier:2.0, maxRounds:4, reset:'immediately', strategy:'classic', maxStake:256, minConf:60, applyWhen:'same-symbol' }; loadSettingsToUI(); toast('Martingale settings reset', 'info'); }

function clearHistoryFilters() {
  document.getElementById('hist-sym-filter').value = 'all';
  document.getElementById('hist-type-filter').value = 'all';
  document.getElementById('hist-result-filter').value = 'all';
  renderHistory();
}

function exportHistory() {
  if (!state.tradeHistory.length) { toast('No trade history to export', 'warn'); return; }
  const headers = ['#','Symbol','Contract','Stake','P&L','Duration','Entry','Exit','Status','Time'];
  const rows = state.tradeHistory.map((t,i) => [
    i+1, t.symbol, CONTRACT_TYPES[t.contractType]||t.contractType,
    t.stake?.toFixed(2), t.pnl?.toFixed(2), t.duration||'‚Äî',
    t.entryPrice||'‚Äî', t.exitPrice||'‚Äî', t.status||'‚Äî',
    new Date(t.closedAt||Date.now()).toLocaleString()
  ]);
  const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'deriv-ai-history-' + Date.now() + '.csv';
  a.click();
  toast('Trade history exported ‚úì', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name)?.classList.add('active');
  document.querySelector(`[data-page="${name}"]`)?.classList.add('active');
  if (name === 'signals') renderSignals();
  if (name === 'trade-history') renderHistory();
  if (name === 'active-trades') updateActiveTradesUI();
  if (name === 'analytics' && state.analyticsSymbol) updateAnalyticsIfSelected(state.analyticsSymbol);
  if (name === 'settings') loadSettingsToUI();
}

function showSettingsTab(name) {
  document.querySelectorAll('.stab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.stab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('stab-' + name)?.classList.add('active');
  event.target.classList.add('active');
}

function selectAnalyticsSymbol(sym) {
  state.analyticsSymbol = sym;
  document.querySelectorAll('.sym-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('atab-' + sym)?.classList.add('active');
  const symInfo = SYMBOLS.find(s => s.id === sym) || { name: sym };
  document.getElementById('an-sym-title').textContent = symInfo.name + ' ‚Äî Live Analysis';
  updateAnalyticsIfSelected(sym);
  // Reset charts on symbol change
  if (state.charts.priceChart) { state.charts.priceChart.destroy(); state.charts.priceChart = null; }
  if (state.charts.rsiChart) { state.charts.rsiChart.destroy(); state.charts.rsiChart = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK & MISC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startClockUpdate() {
  setInterval(() => {
    const now = new Date();
    const t = now.toTimeString().substring(0, 8);
    const el = document.getElementById('liveClock');
    if (el) el.textContent = t;
    const mwClock = document.getElementById('mw-clock');
    if (mwClock) mwClock.textContent = t + ' UTC' + (now.toTimeString().match(/GMT[+-]\d+/)?.[0]||'');
    // Update tick counts on mw cards
    state.settings.trade.symbols.forEach(sym => {
      const el = document.getElementById('mw-ticks-' + sym);
      if (el) el.textContent = (state.ticks[sym]?.length || 0);
      const sigEl = document.getElementById('mw-sig-' + sym);
      if (sigEl && state.signals[sym]) {
        const s = state.signals[sym];
        sigEl.textContent = s.direction + ' ' + s.confidence + '%';
        sigEl.style.color = s.direction === 'RISE' ? 'var(--green)' : 'var(--red)';
      }
    });
  }, 1000);
}

function refreshDashboard() {
  updateDashStats();
  const sigs = AI.allSignals();
  updateDashSignals(sigs);
  toast('Dashboard refreshed', 'info');
}

function refreshActiveTrades() {
  wsSend({ proposal_open_contract: 1, subscribe: 1 });
  updateActiveTradesUI();
  toast('Active trades refreshed', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = 'info') {
  const icons = { success: '‚úì', error: '‚úó', warn: '‚ö†', info: '‚Ñπ' };
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.innerHTML = `<span class="toast-icon">${icons[type]||'‚Ñπ'}</span><span>${msg}</span>`;
  container.appendChild(el);
  setTimeout(() => {
    el.classList.add('out');
    setTimeout(() => el.remove(), 300);
  }, 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN & INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initConnect() {
  const token = document.getElementById('apiToken').value.trim();
  const appId = document.getElementById('appId').value.trim() || '1089';
  const server = document.getElementById('serverSelect').value;
  if (!token) {
    document.getElementById('loginStatus').className = 'login-status error';
    document.getElementById('loginStatus').textContent = 'Please enter your Deriv API token';
    return;
  }
  state.authToken = token;
  state.appId = appId;
  state.server = server;
  document.getElementById('connectBtn').disabled = true;
  document.getElementById('loginStatus').className = 'login-status connecting';
  document.getElementById('loginStatus').textContent = 'Connecting to Deriv servers‚Ä¶';
  wsConnect();
  // Timeout for auth
  setTimeout(() => {
    if (!state.wsReady) {
      document.getElementById('loginStatus').className = 'login-status error';
      document.getElementById('loginStatus').textContent = 'Connection timeout. Check your token and network.';
      document.getElementById('connectBtn').disabled = false;
    }
  }, 15000);
}

function doLogout() {
  state.autoTrade = false;
  clearInterval(state.signalInterval);
  clearInterval(state.pingInterval);
  clearTimeout(state.reconnectTimer);
  state.maxReconnect = 0;
  try { state.ws?.close(); } catch(e){}
  state.wsReady = false;
  state.ticks = {};
  state.signals = {};
  state.activeTrades = {};
  state.subscribed.clear();
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('apiToken').value = '';
  document.getElementById('connectBtn').disabled = false;
  document.getElementById('loginStatus').className = 'login-status';
  document.getElementById('loginStatus').textContent = '';
  state.maxReconnect = 10;
  dashPulseItems = {};
  document.getElementById('dash-market-pulse').innerHTML = '';
  toast('Disconnected from Deriv', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STARTUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  renderMarketWatch();
  initSettings();
  // Demo mode: fill with sample ticks so AI can generate signals
  // (Remove when using real account)
});
</script>
</body>
</html>
